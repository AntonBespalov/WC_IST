# ENGINEERING_CONTRACT — общий инженерный контракт разработки (Safety/RT/Proof)

Назначение: зафиксировать общие требования к разработке прошивки источника (особенно в safety/real-time),
чтобы:
- любой новый код проходил аудит предсказуемо,
- риск “скрытых допущений” был минимальным,
- доказательства (tests/measurements) были воспроизводимыми.

Источники правды: `docs/PROJECT_CONTEXT.md`, `docs/GLOSSARY.md`, `docs/ARCHITECTURE.md`, `docs/SAFETY.md`, `docs/TEST_PLAN.md`.
Этот документ НЕ заменяет их, а задаёт единый “контракт инженерной дисциплины”.

---

## 1) Область действия

Контракт обязателен для:
- любых изменений, влияющих на управление током / ШИМ-домен,
- измерения/диагностики (ADC/SPI/DMA, качество данных),
- safety (fault, safe state, latch/recovery, watchdog),
- обмен с ТК (1 мс домен) и любые таймауты/валидаторы.

Если изменение затрагивает TIM1/BKIN/DRV_EN/INH или политику аварий — приоритет имеет `docs/SAFETY.md` и `docs/PROJECT_CONTEXT.md`.

---

## 2) Термины (минимум)

- **fast-домен (PWM)**: детерминированный шаг управления 1 раз на период PWM (см. `docs/ARCHITECTURE.md` / раздел 3).
- **slow-домен (1 мс)**: приём/валидация команд, сервисные функции (см. `docs/ARCHITECTURE.md` / раздел 3.2).
- **async fault-домен**: аппаратные аварии (BKIN/disable), не ждут RTOS/задач (см. `docs/PROJECT_CONTEXT.md` и `docs/SAFETY.md`).
- **deny-by-default**: при любой неопределённости/невалидности входов — безопасный выход (`u=0`, запрет применения), с наблюдаемой причиной.

---

## 3) Инварианты (SHALL / SHALL NOT)

### E1) Безопасное поведение по умолчанию (deny-by-default)

Компонент Core-слоя (control/measurement/safety/protocol/state machine):
- **SHALL** иметь определённое безопасное поведение при невалидных входах/состояниях.
- **SHALL** выдавать наблюдаемую причину (flags/counters), чтобы верхний уровень не был “слеп”.
- **SHALL NOT** продолжать выдавать управление/разрешение при сомнении в валидности данных.

Минимальный безопасный выход для управления:
- `u=0`;
- `enable_request=false`;
- диагностический флаг причины (например `MEAS_INVALID`, `CMD_INVALID`, `CFG_INVALID`, `NUM_INVALID`).

### E2) Валидность чисел и диапазонов

Для всех Core-API входов и конфигурации (особенно `float`):
- **SHALL** проверять `finite` (не NaN/Inf) для safety-критичных величин.
- **SHALL** проверять корректность диапазонов (например `min <= max`, `dt > 0`, лимиты не отрицательны, если это инвариант режима).
- При нарушении — **SHALL** применять deny-by-default (см. E1).

Примечание: “валидность” измерений/команд может агрегироваться в upstream-модулях, но Core НЕ должен увеличивать риск,
принимая NaN/Inf как “просто число”.

### E3) Разделение временных доменов

Код fast-домена (PWM) **SHALL** быть:
- O(1) по времени и памяти,
- без блокировок,
- без динамической памяти,
- без протокольных операций и логирования “в лоб”.

Код fast-домена **SHALL NOT**:
- ожидать mutex/queue/semaphore,
- вызывать `printf`/форматирование строк,
- обращаться к NVM/Flash,
- выполнять I/O.

### E4) Синхронизация fast/slow (атомарный снапшот)

Любые данные, которые пишет slow-домен и читает fast-домен, **SHALL** читаться в fast как согласованный снапшот.
Запрещены “рваные” обновления составных структур.

Допустимые паттерны (выбрать один и зафиксировать в DN/модуле):
- **Sequence counter (рекомендуется)**: two-phase запись `seq` (odd/even) + повторное чтение до согласованности.
- **Double-buffer**: writer пишет в неактивный буфер и атомарно переключает индекс.
- **Критсекция на стороне интеграции**: допускается только если явно зафиксировано, что fast-домен защищён от конкурентной записи
  (и есть доказательство/тест/измерение влияния на тайминги).

Если снапшот не может быть получен за ограниченное число попыток, **SHALL** использовать безопасный fallback (E1).

### E5) Overrun имеет определённое безопасное поведение

Для каждого критичного домена:
- **SHALL** существовать определение “overrun” (что именно не успело).
- **SHALL** быть наблюдаемое доказательство (счётчик/флаг + измерение на железе по `docs/TEST_PLAN.md` / L3).
- **SHALL** быть определено безопасное действие (controlled stop или fault по `docs/SAFETY.md`).

### E6) Актуальность команды (command freshness)

Должно быть однозначно определено, что означает `allow`/`enable` для контуров управления:
- **SHALL** включать условия “команда свежая/валидная/не просрочена” (таймаут по `docs/PROJECT_CONTEXT.md` / Safety и `docs/TEST_PLAN.md` / R2),
  либо эти условия должны быть частью входа `cmd_valid/age`.
- **SHALL NOT** продолжать “держать” управление при истечении таймаута команды без явного разрешения политики.

### E7) Доверие к измерениям (measurement trust)

Признаки качества измерений (`meas_valid`, stuck/sat/timeout/CRC и т.п.):
- **SHALL** быть консервативными: при сомнении → невалидно.
- **SHALL** приводить к запрету управления (E1) для safety-критичных контуров (“не варим вслепую”, см. `docs/PROJECT_CONTEXT.md`).

### E8) Наблюдаемость (минимум)

Для любых safety/RT веток:
- **SHALL** быть диагностические флаги и счётчики (ошибки измерений/команд/overrun/сатурации/таймауты).
- **SHALL** быть определены минимальные on-target измерения (GPIO/trace) до включения силовой части (см. `docs/TEST_PLAN.md` / L3-L4).

---

## 4) Proof obligations (что обязано быть доказано)

Любое изменение в safety/RT доменах **SHALL** сопровождаться планом доказательств:
- L1 unit (host): негативные/краевые кейсы (NaN/Inf, неверные лимиты, переходы enable/disable, сатурации, таймауты).
- L3 on-target: измерения длительности и джиттера критичных шагов (GPIO/trace).
- Fault-injection: минимум 5 сценариев из `docs/TEST_PLAN.md` / раздел 3 (адаптировать под изменение).

Ссылки на измерения и критерии приёмки фиксировать в соответствующем DN (например `docs/design-notes/DN-004_*.md`) или в `docs/TEST_PLAN.md` (если это системный инвариант).

---

## 5) Использование в запросах к Codex/LLM

Если запрос касается safety/таймингов/измерений/обмена:
- указывать `docs/ENGINEERING_CONTRACT.md` как обязательный контракт (вместе с `docs/PROJECT_CONTEXT.md`/`docs/SAFETY.md`);
- требовать выдачу “Spec + Tests/Proof + минимальный патч” (см. `docs/PROMPT_TEMPLATES.md`).

