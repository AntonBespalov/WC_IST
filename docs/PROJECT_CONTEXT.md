# Контекст проекта (Ground Truth)

Этот файл — единый источник правды о проекте.  
Если меняются железо, тайминги, политика аварий или интерфейсы — обновляй этот файл вместе с кодом/схемой (в одном PR).

Синхронизация: основные факты ниже приведены в соответствие с каноническими документами `docs/` (см. `docs/DOCS_INDEX.md`) по состоянию на **2026-02-02**.

---

## 1) Краткое описание системы
- Изделие: Источник сварочного тока (контроллер MFDC/силовой части; также: ИСТ/УСПФ/плата источника сварочного тока, см. `docs/GLOSSARY.md`)
- Назначение: управление сварочным током по заданию ТК + диагностика + безопасное отключение при отказах
- МК: **STM32G474** (серия STM32G4)
- ПО: **двухслойное**
  - быстрый контур (PWM/измерение/регулятор/fast protections): **без RTOS**, детерминированный (ISR/таймер)
  - медленный контур (CAN/диагностика/логирование/процессная логика): **FreeRTOS**

---

## 2) Тайминги и управление
- ШИМ/инвертор: **TIM1 (комплементарные выходы + Break BKIN/BKIN2)**
- Диапазон частоты MFDC-инвертора: **1–4 кГц**
- Шаг регулирования тока: **1 раз на период ШИМ** (контракт детерминизма)
- Сервисный режим `ManualDuty` (ручная скважность) для отладки ШИМ: duty 10–50%, slew-rate 2‰/период (диапазон 1–10‰/период), применение строго по периоду через preload, timeout связи 20 мс (см. `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`)
- Инвариант измерений/энергии: ток и напряжение берутся как **усреднённые по периоду ШИМ** величины (см. `docs/measurements/MEASUREMENT_ARCHITECTURE_RU.md`)
- Обмен с ТК:
  - Период команд: 1 мс
  - Ответ источника: **периодически 1 мс** (статус + измерения + fault/limit слова)
- Требования по задержкам:
  - **Аппаратный** shutdown (DESAT/OC/driver fault → BKIN/disable): целевое **≤ 5–10 мкс** (см. `docs/safety/SFAT_and_Timing_Budget_MFDC_ru.md`)
  - **Программный** shutdown (по измерениям/timeout) — допускает шкалу “периоды ШИМ / миллисекунды” по политике fault-классов
  - Джиттер запуска шага управления: **измеряется** (GPIO/осциллограф); целевые пороги TBD (фиксируются после первых замеров)

---

## 3) Измерения и тракт сигналов
- Внешние АЦП по SPI:
  - **AD7380** (синхронный двухканальный АЦП)
  - (опционально) внешний многоканальный АЦП для “медленных” каналов (температуры/питания): TBD
- Измеряемые величины:
  - Ток вторички: **катушка Роговского** (через интегратор) → AD7380 CH1 (`I_weld`)
  - Напряжение вторички: → AD7380 CH2 (`U_weld`)
  - Доп. каналы (температуры, токи, питания): TBD
- Пайплайн обработки измерений:
  1) сырые коды АЦП
  2) масштабирование (калибровка/коэффициенты)
  3) диагностика измерений (stuck/sat/timeout/пределы)
  4) усреднение/агрегация **по периоду ШИМ**:
     - `I_per = mean(I_samples[0..N-1])`
     - `U_per = mean(U_samples[0..N-1])`
     - `P_per = mean(I_samples[n] * U_samples[n])` (а не `I_per * U_per`)
  5) значение на вход регулятора: **`I_per`** (или другая явно зафиксированная величина)

---

## 4) Силовая часть и драйверы
- Драйверы затворов: **2× SKYPER 42 R**
- Силовые модули: **4× SEMiX252GB12**
- Входы/выходы управления драйвера (заполнить по схеме):
  - PWM IN: ________
  - ENABLE/INH/DRV_EN: ________
  - FAULT/READY/STATUS: ________ (тип выхода: open-collector / push-pull)
- Определение безопасного состояния (Safe State):
  - **ШИМ выключен аппаратно** (TIM1 outputs off через BKIN/BKIN2)
  - **Драйверы запрещены** (через DRV_EN/INH/SDI — по схеме)
  - Критические аварии: **latched-off** до явного recovery (нет авто-рестарта)
- Аппаратный путь отключения (shutdown-path):
  - Критические аварии → TIM1 BKIN/BKIN2 (железом, без RTOS/ISR)
  - Рекомендуется независимый запрет драйверов (DRV_EN/INH) + аппаратная защёлка (latch)
  - AOE (Automatic Output Enable) по умолчанию: OFF (если не оговорено иначе)
- Внешний супервизор / watchdog: **CBM706T** (см. `docs/safety/SAFETY_CONCEPT_CBM706T_RU.md`)
  - `FAULT_OUT` используется как **аппаратный запрет драйверов** (не только reset)
  - `RESET_OUT` может идти на `NRST` STM32 для восстановления, но reset **не является** safe state

---

## 5) Интерфейсы и обмен
- Основной интерфейс с ТК: **CAN FD** (см. `docs/protocols/PROTOCOL_TK.md`)
- Формат обмена:
  - Команда: `I_ref_cmd`, `enable`, `seq` (и опциональные лимиты)
  - Ответ: `seq_applied`, `I_ref_used`, `I_per`, `U_per`, `state`, `fault_word`, `limit_word`, счётчики ошибок
- Политика таймаутов:
  - Soft-timeout: **5 мс** (Draft 0.2) → controlled stop / спад `I_ref_used` по политике
  - Hard-timeout: **20 мс** (Draft 0.2) → **запрет сварки + FAULT** (latch по политике)
  - Bus-off/ошибки линии: **без ABOM** (Draft 0.2), восстановление с backoff **250 мс** (настраиваемо 100–500 мс), без “спама” в шину (см. `docs/protocols/PROTOCOL_TK.md` и `docs/SAFETY.md`)
- Интерфейс “плата ↔ ПК” по USB-UART: **PCcom4** (настройка/осциллографирование/логирование; режим отладки с обёрткой CAN-кадров, см. `docs/protocols/PCCOM4.02.md`)
- Неволатильные настройки/калибровки:
  - Хранение: **внутренняя Flash** МК (проектный NVM storage).
  - Safety-инвариант: запись во Flash разрешена **только** в `IDLE` (PWM OFF, сварка запрещена).
  - Формат записи (минимум): `magic` + `version` + `crc32` + payload.
  - Старт: при ошибке CRC/версии загружаются hardcoded defaults (безопасные значения) и фиксируется диагностический флаг.
  - Риск power-loss при erase: принять риск или реализовать схему Active/Backup (фиксируется в архитектуре).

---

## 6) Политика аварий и восстановления (проектный уровень)
- Классы аварий:
  - **HARD-FAULT** (аппаратное отключение + latch): драйвер fault/DESAT/OC, HW trip, критический перегрев/интерлок
  - **LIMIT** (ограничение без latch): headroom/duty limit, `dI/dt` limit, volt-seconds limit, saturation suspected
  - **SOFT-FAULT / ABORT** (прервать импульс/цикл без глобальной latch): NO_CURRENT, нестабильная регулировка, длительный LIMIT по политике
  - **INFO/WARN** (только телеметрия): сервис/диагностика
- Сервисный timeout в режиме `ManualDuty`: отсутствие команд/keepalive по интерфейсу активации > 20 мс ⇒ запрет сварки + переход в safe state (см. `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`)
- Защёлкивание (latch):
  - HARD-FAULT: всегда latch
  - SOFT-FAULT: latch до конца цикла / до подтверждения ТК (по политике)
  - LIMIT: не latch, но с накоплением времени (эскалация при превышении порога)
- Watchdog:
  - Внутренний: IWDG/WWDG (TBD)
  - Внешний супервизор: **CBM706T**
  - Политика: watchdog обслуживается только из “здорового” контекста; срабатывание приводит к **аппаратному запрету драйверов** + безопасному старту после reset

---

## 7) Наблюдаемость и логирование
- Обязательные debug-пины (должны иметь тест-пойнты):
  - DBG_CTRL_TICK — начало/конец шага управления
  - DBG_ADC_START — старт SPI/выборки
  - DBG_ADC_READY — DMA complete/данные готовы
  - DBG_PWM_APPLY — момент применения новых CCR/ARR
  - DBG_FAULT_ENTRY — вход в софт-обработчик аварии
  - BKIN_RAW — реальная линия аварии в TIM1
  - PWM_OUT — реальный выход TIM1_CHx/CHxN
- Внешняя память для логирования: **FRAM CY15B104Q-PZXI (QSPI)** (PSRAM не используется/не устанавливается).
- Дефолтный режим: поток логов/осциллографирования **сразу на ПК** через USB-UART, с промежуточной буферизацией в SRAM; запись во FRAM включается при необходимости (критерии — TBD).
- Логирование в память (если задействуется FRAM):
  - Кольцевой буфер фиксированных записей (например 64/128 байт)
  - Pre-trigger: последние ________ мс
  - Post-trigger после fault: ________ мс
  - Поля записи: timestamp, raw ADC, filtered, setpoint+seq, duty, state, fault bitmap, timing stats

---

## 8) Дефолтные допущения (пока не уточнено)
- Шаг регулирования тока запускается 1 раз на период ШИМ
- Потеря команд ТК > N мс ⇒ немедленный останов сварки + статус ошибки (N = TBD)
- Критический fault ⇒ аппаратное отключение + защёлка до явного восстановления
- Любой overrun критического цикла ⇒ переход в безопасное состояние (controlled stop или fault — уточнить)

---

## 9) Ссылки на связанные документы
- Каталог документов: `docs/DOCS_INDEX.md`
- Архитектура ПО: `docs/ARCHITECTURE.md`
- Политика безопасности/аварий: `docs/SAFETY.md`
- Протокол ТК (CAN): `docs/protocols/PROTOCOL_TK.md`
- Протокол плата ↔ ПК (USB-UART, PCcom4): `docs/protocols/PCCOM4.02.md`
- План тестов: `docs/TEST_PLAN.md`
- Skills: `.codex/skills/README.md`
- Design Notes: `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`
