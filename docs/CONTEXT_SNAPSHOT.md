# Контекст проекта — короткий снимок (Context Snapshot)

Назначение: короткая вставка в запросы к Codex, чтобы не тащить весь контекст.
Источник правды: `docs/PROJECT_CONTEXT.md` и `docs/GLOSSARY.md` (каталог доп. документов: `docs/DOCS_INDEX.md`).
Общий инженерный контракт разработки: `docs/ENGINEERING_CONTRACT.md` (defensive design, safety/RT, proof).
Стандарт кода (для любых патчей/кода): см. `docs/CODING_STANDARD_RU.md` (комментарии на русском, UTF-8/CRLF).
STM32CubeIDE: при добавлении новых папок с кодом обновлять include paths и `sourceEntries` в `.cproject` (см. `docs/HOW_TO_USE_RU.md` / раздел 5).

## Hardware/RTOS
- MCU: STM32G474 (STM32G4)
- Тактирование: HSE 16 МГц (ABM8AIG-16.000MHZ-4-T)
- Архитектура ПО: fast loop без RTOS (ISR/таймер) + slow loop FreeRTOS
- PWM (MFDC-инвертор): TIM1, 1–4 кГц, Break BKIN/BKIN2
- Gate drivers: 2× SKYPER 42 R → 4× SEMiX252GB12
- Измерения fast loop: AD7380 (I_weld/U_weld, SPI+DMA), ток — через интегратор (источник сигнала выбирается аппаратно: датчик тока трансформатора или катушка Роговского)
- Измерения “медленных” каналов: 2× AD7606 (SPI3/SPI4): входные токи/напряжения + температуры (модуль/выпрямитель/корпус)
- Внешний супервизор: CBM706T (FAULT/RESET роли разделены)
- ШИМ-выходы TIM1 буферизуются через CD4049UBDR
- USB-UART к ПК: FT232H (PCcom4)
- EtherCAT к ТК (целевой интерфейс): COMX 100CA-RE ↔ FMC (см. `docs/decisions/ADR-20260210-tk-interface-ethercat-comx-fmc-and-uart-pdo-emu.md`)

## Тайминги
- Команды ТК приходят с периодом 1 мс (целевое); источник отвечает статусом/измерениями.
- Шаг управления током: 1 раз на период PWM (детерминированно).
- Инвариант измерений: I и U используются как **усреднённые по периоду PWM**; энергия/мощность — по `mean(I*U)`.

## Safety (главное)
- Критические аварии должны выключать силовую часть аппаратно: TIM1 BKIN/BKIN2.
- Желателен независимый запрет драйверов: DRV_EN/INH.
- Нет авто-рестарта после критического fault (latch до явного recovery).
- Watchdog (в т.ч. внешний) должен приводить к safe state аппаратно.
- Потеря команд ТК > N мс (N TBD) => останов сварки + статус ошибки.
- Устойчиво невалидные измерения (timeout/stuck/sat/CRC) => запрет сварки (не “варим вслепую”).

## Наблюдаемость
- Debug GPIO: DBG0/DBG1 (настраиваемые события, фиксировать настройку в каждом тесте)
- Измерять: BKIN_RAW и PWM_OUT (TIM1_CHx/CHxN)
- Осциллографирование/логирование: USB-UART → ПК (не блокировать fast loop; буферизация в SRAM).
- Протокол “плата ↔ ПК” по USB-UART: PCcom4 (база: `docs/protocols/PCCOM4.02.md`, профиль проекта: `docs/protocols/PCCOM4.02_PROJECT.md`).
- Резерв для буферизации осциллографа/накопления: PSRAM APS6404L-3SQR-SN (QSPI/QUADSPI), если пропускной способности USB-UART не хватает (политика включения — TBD).

