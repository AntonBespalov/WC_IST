# Архитектура измерения, управления и защит  
## MFDC источник сварочного тока (1–4 кГц)  
*(STM32G4 + AD7380, источник ↔ ТК по EtherCAT PDO (1 кГц), осциллографирование/лог в ПК по USB-UART; опционально ring-buffer во внешней памяти)*

> **Принципиальное требование (инвариант):**  
> **Ток и напряжение измеряются и усредняются по всему периоду ШИМа**, а не в середине «тихого окна», потому что:  
> - ток после интегратора катушки Роговского имеет **пилообразную** форму;  
> - напряжение на вторичке — **ШИМ-сигнал**;  
> - физически значимая величина для управления и энергии — **среднее за период**.

Документ написан так, чтобы его можно было:  
- положить в `docs/measurements/`;  
- использовать как основу для **design review**;  
- использовать как **reference** при реализации firmware.

---

# 1. Назначение и принципы

Данный документ описывает архитектуру:

- формирования ШИМ (1–4 кГц),
- синхронного измерения тока и напряжения вторичной цепи,
- усреднения измерений,
- контура регулирования тока,
- защит первичной и вторичной стороны,

для MFDC-источника сварочного тока на базе **STM32G4 + AD7380**.

## 1.1. Базовый принцип архитектуры

Вся система **синхронизирована с периодом ШИМа**.

Период ШИМа является:

- базовой временной единицей измерения,
- базовой единицей управления,
- базовой единицей принятия решений защит.

---

# 2. Физические предпосылки (ключевая часть)

## 2.1. Форма тока вторички

Ток измеряется **катушкой Роговского**.

- сигнал катушки пропорционален **`di/dt`**;
- интегратор восстанавливает `i(t)`, но:
  - интегратор неидеален,
  - ток внутри периода имеет **пилообразную форму**,
  - форма и амплитуда пилы зависят от режима, скважности и нагрузки.

**Следствие:**  
мгновенное значение тока в любой фиксированной точке периода **не является репрезентативным**.

## 2.2. Форма напряжения вторички

Напряжение вторичной цепи имеет форму **ШИМ-сигнала**:

- большую часть периода — нижний уровень,
- короткие интервалы — верхний уровень,
- фронты загрязнены переходными процессами.

**Следствие:**  
одиночная точка измерения напряжения в периоде:

- либо попадает в «низ»,
- либо в «верх»,
- либо в фронт,

и не отражает реального **среднего напряжения**.

## 2.3. Вывод (ключевой архитектурный инвариант)

Физически осмысленные величины для управления и анализа — это значения, **усреднённые за период ШИМа**.

Следовательно:

- измерение должно вестись **на протяжении всего периода**,
- результатом измерения является **`⟨I⟩` и `⟨U⟩` за период**,
- «тихое окно» **не используется как единственная зона измерения**.

---

# 3. Временная модель системы

## 3.1. Период ШИМа как базовая единица

- Частота ШИМа: **1…4 кГц**
- Период: **250…1000 мкс**

Каждый период ШИМа рассматривается как **атомарный цикл**:

**Период `k`:**
- формирование ШИМа с фиксированной скважностью,
- синхронное измерение `I(t)`, `U(t)` на протяжении периода,
- накопление данных.

**Граница периода `k → k+1`:**
- вычисление средних значений,
- расчёт регулятора,
- загрузка новой скважности (preload).

## 3.2. Принцип «один период — одно решение»

В течение периода `k`:

- скважность **не меняется**,
- собираются данные измерений.

На границе периода:

- принимается **одно управляющее решение**,
- применяется **только с периода `k+1`**.

Это устраняет:

- полупериоды,
- смешивание данных,
- фазовые искажения в контуре.

---

# 4. Архитектура измерения

## 4.1. АЦП и каналы

**АЦП:** AD7380

Каналы:

- канал A — ток вторички `I₂`,
- канал B — напряжение вторички `U₂`.

Особенность:

- **одновременная выборка** каналов (sample & hold внутри AD7380).

## 4.2. Сэмплирование в течение периода

За каждый период ШИМа выполняется:

- `N` равномерно распределённых выборок **по всему периоду**.

Типовые значения:

- `N = 32` — базовый режим,
- `N = 64` — при повышенных требованиях к шуму.

Шаг между выборками:

- `Δt = T_pwm / N`.

## 4.3. Синхронизация измерений

- `TIM1` — мастер-таймер ШИМа.
- Вспомогательный таймер (`TIM2 / TIM3`):
  - синхронизирован от `TIM1`,
  - генерирует `N` событий выборки за период.

Каждое событие:

- формирует импульс `CNV` для AD7380,
- инициирует SPI-чтение,
- данные складываются в DMA-буфер.

**Принципиально:**

- измерения запускаются **аппаратно**,
- без ISR и **программного джиттера**.

## 4.4. Буферы данных

Для каждого периода формируются:

- `I_samples[0…N-1]`
- `U_samples[0…N-1]`

Все элементы массива:

- принадлежат **одному и тому же периоду** ШИМа,
- имеют одинаковую фазовую структуру **от периода к периоду**.

---

# 5. Обработка измерений

## 5.1. Усреднение за период

На границе периода вычисляются:

- `I_per = (1/N) · Σ I_samples[n]`
- `U_per = (1/N) · Σ U_samples[n]`

Это **основные физические величины**, используемые далее:

- в регуляторе тока,
- в защитах,
- в телеметрии.

## 5.2. Робастность к выбросам

Фронты ШИМа и EMI могут давать одиночные выбросы.

Допускается (опционально):

- ограничение значений по физическим пределам,
- усечённое среднее (отбрасывание min/max),
- медианный фильтр внутри периода.

**Важно:**  
фильтрация **не должна нарушать** принадлежность данных периоду.

## 5.3. Калибровка нуля (offset) / авто-рецентровка

Проблема: тракт катушки Роговского + интегратор и аналоговый фронт‑энд имеют дрейф нуля. “Хаотичная” калибровка приведёт к систематической ошибке и дрейфу регулятора.

Требование: процедуры zeroing/auto‑recentering выполняются **только** в заранее определённых условиях (без сварки) и не должны влиять на PWM‑домен.

**Условия допуска (все одновременно):**
- `state = IDLE`.
- PWM подтверждён как OFF **аппаратно** и удерживается OFF не менее `T_zero_guard_ms` (TBD, типично десятки мс).
- Измерения валидны (нет `ADC_*` ошибок), а уровень шума/дисперсия за окно ниже порога (порог TBD).

**Процедура (черновой вариант):**
- собрать окно из `M` периодов (TBD) сырых выборок при выключенном ШИМ;
- вычислить `offset_i`, `offset_u` как среднее (или робастную оценку) по окну;
- применить offset только как часть “raw→физика” пересчёта;
- (опционально) сохранить offsets/калибровки в NVM **только** в `IDLE` (см. `docs/PROJECT_CONTEXT.md` / раздел 5).

---

# 6. Контур регулирования тока

## 6.1. Структура контура

Контур тока работает по среднему току за период:

- `e_k = I_ref_k − I_per_k`
- `u_k = Regulator(e_k)`

Где:

- `I_ref_k` — уставка тока на период `k`,
- `I_per_k` — измеренный средний ток периода `k`,
- `u_k` — новая скважность для периода `k+1`.

## 6.2. Обновление ШИМа

Скважность записывается в `CCR preload`.  
Применяется **только** по событию `Update` `TIM1`.

Это гарантирует:

- отсутствие «рваных» периодов,
- согласованность измерений и управления.

## 6.3. Задержка контура

Контур имеет жёстко определённую задержку: **1 период ШИМа**.

Это:

- учитывается при настройке регулятора,
- делает систему предсказуемой и устойчивой.

---

# 7. Расчёт мощности и энергии

Для сварочных процессов принципиально важно:

- `⟨I⟩ · ⟨U⟩ ≠ ⟨I · U⟩`

Поэтому для энергии и мощности используется:

- `P_per = (1/N) · Σ ( I_samples[n] · U_samples[n] )`

Это корректно учитывает:

- ШИМ-природу напряжения,
- пульсацию тока,
- фазовые соотношения.

---

# 8. Архитектура защит

## 8.1. Быстрые аппаратные защиты (мкс)

Реализуются на первичной стороне, независимо от МК:

- `DESAT` драйверов,
- аппаратный `overcurrent`,
- `UVLO / OVP` звена DC,
- немедленное отключение ключей.

## 8.2. Быстрые программные защиты (периоды ШИМа)

Работают на базе `I_per`, `U_per`, `P_per`:

- превышение допустимого тока вторички,
- несоответствие первичка ↔ вторичка,
- аномальные режимы (обрыв, плохой контакт).

Реакция:

- аварийная остановка,
- переход в `fault-state`,
- логирование причины.

## 8.3. Медленные защиты (мс и выше)

- тепловые ограничения,
- ресурсные лимиты,
- технологические условия процесса.

---

# 9. Ключевые архитектурные инварианты

- Все измерения синхронизированы с периодом ШИМа.
- Все выборки одного массива принадлежат одному периоду.
- Управление обновляется только на границе периода.
- Контур тока работает по `⟨I⟩` за период.
- Напряжение и энергия считаются по всему периоду, а не в точке.
- Аппаратные защиты не зависят от прошивки.

---

# 10. Итог

Описанная архитектура:

- физически корректна для MFDC-сварки,
- устойчива,
- детерминирована,
- масштабируема в диапазоне 1–4 кГц,
- соответствует промышленным решениям высокого класса.
