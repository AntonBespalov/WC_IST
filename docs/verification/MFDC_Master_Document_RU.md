
# Master Verification & Test Architecture
## Источник сварочного тока MFDC (STM32G474)

Версия: 1.0  
Статус: рабочий документ  
Язык: русский

---

## 1. Назначение и область применения

Данный документ является **единым каноническим описанием архитектуры верификации и тестирования**
источника сварочного тока MFDC.

Документ объединяет:
- архитектурные решения прошивки (SIL-first),
- философию функциональной безопасности,
- тестовую пирамиду (Unit → SIL → HIL → стенды),
- критерии выхода и правила регрессии.

Цель документа — не «описать тесты», а **зафиксировать инженерную модель доверия**
к системе управления источником.

---

## 2. Контекст системы

### 2.1 Аппаратный контекст

- MCU: STM32G474
- Силовая часть: MFDC-инвертор
- Драйверы затворов: 2× SKYPER 42 R
- Силовые модули: SEMiX252GB12
- Датчик тока: катушка Роговского
- АЦП быстрого контура: AD7380
- АЦП медленных каналов: внешний многоканальный
- Связь с ТК: EtherCAT PDO, период **250 мкс (4 кГц)**
- Частота ШИМ: 1–4 кГц

### 2.2 Программный контекст

- Быстрый контур: bare-metal, детерминированный
- Медленный контур: FreeRTOS
- Генерация ШИМ: TIM1 (комплементарные выходы + Break)

---

## 3. Философия безопасности

### 3.1 Определение безопасного состояния

Система считается находящейся в безопасном состоянии, если одновременно выполняются условия:
- все выходы ШИМ отключены аппаратно;
- входы ENABLE драйверов неактивны;
- автоматическое повторное включение исключено;
- для выхода из safe-state требуется явная команда.

### 3.2 Уровни защиты

1. Аппаратный уровень (TIM1 Break, fault-линии драйверов)
2. Быстрый программный путь (fast loop)
3. Медленный программный надзор (slow loop)
4. Внешние цепи безопасности (E-Stop, interlock)

---

## 4. Тестовая пирамида

### 4.1 Уровни

- Unit tests / статический анализ
- SIL (Software-in-the-Loop)
- HIL (Hardware-in-the-Loop)
- Ограниченный силовой стенд
- Полнотоковые испытания

### 4.2 Принцип

Чем выше уровень:
- тем выше стоимость ошибки;
- тем меньше сценариев;
- тем больше доверие к результату.

---

## 5. SIL — Software-in-the-Loop

### 5.1 Архитектурное требование

Ядро управления должно компилироваться и исполняться:
- на STM32 (target),
- на ПК (host),
без использования HAL, CMSIS и FreeRTOS.

### 5.2 API ядра управления

- control_init()
- control_fast_step()
- control_slow_step()

### 5.3 Модель объекта

- апериодическое звено 1-го порядка;
- задержка 1–3 такта;
- насыщение по току и управляющему воздействию.

### 5.4 Модель измерения

- смещение нуля;
- шум;
- квантование;
- клиппинг.

### 5.5 Обязательные SIL-сценарии

- ступенька уставки;
- ramp;
- насыщение + anti-windup;
- обрыв датчика;
- КЗ датчика;
- залипание АЦП;
- таймаут связи с ТК.

---

## 6. HIL — Hardware-in-the-Loop

### 6.1 Назначение

HIL используется для проверки:
- реальных таймингов MCU;
- работы DMA, SPI, ADC;
- аппаратных путей аварийного отключения.

### 6.2 Эмулируемые сигналы

- ток;
- напряжение;
- fault драйверов;
- термостаты;
- interlock.

### 6.3 Критические измерения времени

- ADC sampling vs PWM phase;
- fault → PWM off (мкс);
- jitter fast loop.

---

## 7. On-target интеграционные тесты

- синхронизация ADC + DMA;
- EtherCAT (COMX/PDO) под нагрузкой;
- watchdog и reset-recovery.

---

## 8. Ограниченный силовой стенд

### 8.1 Назначение

Проверка реальной коммутации без риска разрушения.

### 8.2 Проверки

- dead-time;
- помехи и наводки;
- реакции драйверов.

---

## 9. Полнотоковые испытания

- реальный профиль сварки;
- тепловые режимы;
- повторяемость;
- восстановление после аварий.

---

## 10. Трассируемость

Каждый hazard обязан иметь:
Hazard → Safety mechanism → Test case.

---

## 11. Критерии выхода

- все SIL-тесты пройдены;
- все HIL safety-тесты пройдены;
- на силовом стенде нет необъяснимых аварий.

---

## 12. Управление изменениями

Любое изменение:
- регулятора;
- фильтров;
- логики аварий

обязывает повторный прогон SIL + HIL.

---

