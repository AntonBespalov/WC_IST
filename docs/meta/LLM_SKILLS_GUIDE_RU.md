# Единый документ: организация контекста и skills при работе с Codex (Embedded / STM32)

## Назначение документа
Этот документ фиксирует **ключевые принципы, правила и best practices** работы с Codex/LLM
в embedded‑проектах (STM32, FreeRTOS, силовая электроника, сварка).
Он задуман как **короткий, единый источник истины**, на который можно ссылаться из AGENTS.md,
skills и промптов.

---

## 1. Ground Truth и контекст проекта

### 1.1. Принцип Ground Truth
В проекте должен существовать **один источник правды**:
- железо
- тайминги
- safety‑политики
- протоколы
- допущения

Рекомендуемый файл:
- `docs/PROJECT_CONTEXT.md`

Дополнительно:
- `docs/CONTEXT_SNAPSHOT.md` — короткий список (10–20 пунктов), который реально вставляется в промпты.

### 1.2. Зачем это нужно
- снижает «угадывание» со стороны LLM
- предотвращает поломку таймингов и safety‑логики
- повышает воспроизводимость ответов

---

## 2. Skills: как и когда применять

### 2.1. Базовые правила
- Skills **не считаем автоматическими**
- Их нужно **вызывать явно** в промпте
- «Почти‑автомат» достигается дисциплиной через `AGENTS.md`

Пример:
> «Используй skills: workflow-spec-tests-code, patch-discipline-small-diffs»

### 2.2. Что хранить в skill
Skill должен содержать:
- правила поведения
- ограничения
- инварианты

Skill **не должен**:
- дублировать проектные данные
- содержать длинные описания железа

---

## 3. Рекомендуемая структура репозитория

Минимум:
- `AGENTS.md` — правила по умолчанию
- `docs/PROJECT_CONTEXT.md`
- `docs/CONTEXT_SNAPSHOT.md`
- `skills/`

Опционально:
- `docs/ARCHITECTURE.md`
- `docs/SAFETY.md`
- `docs/TEST_PLAN.md`
- `docs/PROTOCOL_TK.md`

---

## 4. Базовый workflow: Spec → DN → Tests → Code

### 4.1. Почему это важно
В embedded‑системах «сразу код» опасен:
- ISR
- RTOS
- тайминги
- аварии

### 4.2. Шаги
1. **Spec**
   - что меняем
   - что нельзя ломать
   - критерии приёмки
2. **DN (Design Note)**
   - фиксируем выжимку spec в репозитории (что/как/почему + test plan/rollback)
   - удобно делать “через Codex”: обсудили → попросили оформить DN
3. **Tests / Proof**
   - как доказываем корректность
   - измерения GPIO / fault‑injection / HIL
4. **Code**
   - минимальный патч

---

## 5. Маленькие диффы как правило

Обязательные установки:
- не менять лишние файлы
- не рефакторить «заодно»
- интерфейсы — только при необходимости

Рекомендуемый skill:
- `patch-discipline-small-diffs`

---

## 6. Safety‑инварианты (неприкасаемые)

Типовые инварианты:
- критические аварии выключают силовую часть **аппаратно**
- нет авто‑рестарта без recovery
- зависание МК не оставляет силовую часть включённой

Хранить в:
- `docs/SAFETY.md`
или отдельном skill

---

## 7. Тайминги = измерения, а не рассуждения

Требовать от ответов:
- какие GPIO ставить
- какие задержки мерить
- worst‑case значения
- поведение при overrun

---

## 8. Red‑team review как отдельный шаг

После кода:
- искать гонки
- искать тайминговые проблемы
- искать сценарии отказа

Лучше отдельным запросом:
> «Red‑team review этого патча»

---

## 9. Gate для «недоописанных» задач

### 9.1. MUST‑минимум
Задача недоописана, если нет:
- цели изменения
- границ правок
- контекста исполнения
- временного домена
- критерия готовности

### 9.2. Поведение
- сначала только вопросы
- без кода
- продолжать только после уточнений

---

## 10. Практика работы в VSCode / Codex

### 10.1. Контекст‑стек
Перед задачей открыть:
- CONTEXT_SNAPSHOT
- PROJECT_CONTEXT
- ARCHITECTURE / SAFETY (при необходимости)
- 1–3 файла кода

### 10.2. Шапка промпта
- «Следуй AGENTS.md»
- «Контекст: CONTEXT_SNAPSHOT»
- «Работай лениво с контекстом»
- «Используй skills: …»

---

## 11. Назначение документа
Этот файл предназначен для:
- onboarding
- стабилизации качества ответов
- снижения риска регрессий
- единого инженерного стиля работы с LLM
