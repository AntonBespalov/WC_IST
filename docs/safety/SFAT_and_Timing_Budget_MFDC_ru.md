# Safety Function Allocation Table (SFAT) и Fault Reaction Timing Budget
## Источник MFDC — STM32G474 / AD7380 / Катушка Роговского / SKYPER 42R

Документ-дополнение к DAP: фиксирует распределение safety‑функций по элементам системы (HW/SW) и задаёт бюджет времени реакции (вплоть до микросекунд) до перевода силовой части в безопасное состояние.

> Примечание: численные значения в Timing Budget ниже — **целевые/типовые** для проектирования. Их нужно подтвердить измерениями на стенде (осциллограф + лог событий) и спецификациями конкретных узлов (SKYPER 42R, SEMiX, схемотехника gate‑enable, настройки таймера).

---

## 1) Термины и элементы (для однозначности)

**Safe-state (безопасное состояние источника):**
1) ШИМ выключен (выходы таймера в безопасных уровнях),  
2) gate‑enable/разрешение драйверов снято аппаратно (fail-safe OFF),  
3) авария зафиксирована (fault latch), причина сохранена (код/время).

**Элементы системы:**
- **PSU_PWR** — силовая часть (SEMiX252GB12, DC‑линк, трансформатор, вторичка)
- **DRV1/DRV2** — драйверы SKYPER 42R (DESAT/OC, disable, fault out)
- **GE_CHAIN** — аппаратная цепь разрешения (gate‑enable), fail-safe=0
- **TIM_BRK** — аппаратный break/kill вход таймера ШИМ (мгновенное отключение выходов)
- **MCU_RT** — real-time контур в МК (ISR: sample→compute→update PWM + быстрый мониторинг)
- **MCU_APP** — прикладная логика (EtherCAT/COMX, диагностика, логирование, сервис)
- **ADC** — AD7380 + аналоговый фронт + тракт катушки Роговского
- **EtherCAT** — связь с ТК (RxPDO/TxPDO: уставки 1 кГц + телеметрия)

---

## 2) Safety Function Allocation Table (SFAT)

### SF-1: Аварийное снятие энергии (Emergency Energy Removal)

**Цель:** гарантированно прекратить подачу энергии при опасном событии.

| Подфункция | Реализатор | Тип | Вход/условие | Действие | Независимость |
|---|---|---|---|---|---|
| SF-1.1 Быстрое отключение ШИМ по аппаратному событию | TIM_BRK | HW | сигнал аварии (из DRV/компаратора/GE_CHAIN) | мгновенно гасит PWM | не зависит от ПО/связи с ТК |
| SF-1.2 Отключение драйверов (запрет gate) | GE_CHAIN / DRV disable | HW | авария, интерлок, e-stop | снимает gate-enable | не зависит от МК |
| SF-1.3 Защита ключей при DESAT/OC | DRV (SKYPER 42R) | HW | DESAT/overcurrent | локальное отключение/ограничение по драйверу | максимально независима |
| SF-1.4 Фиксация и защёлкивание аварии | MCU_RT | SW (RT) | fault input / диагностика | fault latch + переход в safe-state | зависит от МК, но не критична для снятия энергии |
| SF-1.5 Контролируемый спад (если допустимо) | MCU_RT | SW (RT) | предаварийный режим | ramp-down Iref/duty | опционально, не вместо HW отключения |

**Замечание:** SF-1 обязана **работать на уровне HW** даже при полном отказе MCU_APP и деградации связи с ТК (EtherCAT).

---

### SF-2: Обнаружение отказа МК (MCU Failure Detection)

| Подфункция | Реализатор | Тип | Условие | Действие | Независимость |
|---|---|---|---|---|---|
| SF-2.1 Независимый watchdog | IWDG/WWDG | HW/SW | МК не обслуживает WDG | reset МК → safe default | частично независим |
| SF-2.2 Запрет обслуживания WDG из «не‑RT» | MCU_RT | SW (архитектурное правило) | всегда | WDG кормится только из RT‑контекста | повышает детерминизм |
| SF-2.3 Безопасный запуск после reset | MCU_RT | SW | после reset | PWM=OFF, GE=OFF до явного разрешения | снижает риск «самостарта» |

**Замечание:** watchdog — механизм на шкале **миллисекунд**, он не заменяет аппаратный trip для микросекундных аварий.

---

### SF-3: Сверхток / аномальный ток (Overcurrent & Abnormal Current)

| Подфункция | Реализатор | Тип | Условие | Действие | Независимость |
|---|---|---|---|---|---|
| SF-3.1 Мгновенная аппаратная защита | DRV / TIM_BRK | HW | DESAT/OC | мгновенный stop PWM/drive | не зависит от ПО |
| SF-3.2 Быстрый надзор Imax / dI/dt | MCU_RT | SW (RT) | ADC показывает превышение | PWM=0 + GE off + fault latch | зависит от ADC и МК |
| SF-3.3 Plausibility/diagnostics ADC | MCU_RT | SW (RT) | залипание/выход за пределы/NaN | fault → safe-state | зависит от МК |
| SF-3.4 Ограничения (saturation flags) для ТК | MCU_APP | SW | насыщения/лимиты | телеметрия flags | не safety‑критично, но важно для устойчивости |

---

### SF-4: Потеря управляющих команд (Timeout связи с ТК / Command Validity)

| Подфункция | Реализатор | Тип | Условие | Действие | Независимость |
|---|---|---|---|---|---|
| SF-4.1 Контроль sequence/validity | MCU_APP + MCU_RT | SW | seq/CRC/диапазоны | reject команды | зависит от МК |
| SF-4.2 Таймаут команд | MCU_RT | SW (RT) | нет валидной команды N мс | ramp Iref→0 → disable | зависит от МК |
| SF-4.3 Safe behavior при старте | MCU_RT | SW | boot | PWM=OFF, GE=OFF | снижает риск самоподачи |

**Замечание:** timeout связи с ТК — обычно «quality/protective», но может становиться safety‑связанным, если потеря команд может привести к опасной подаче энергии.

---

## 3) Fault Reaction Timing Budget (время «событие → отключение»)

### 3.1 Формат бюджета

Для каждого инициирующего события задаём:
- **t_detect** — время обнаружения события (сенсор/драйвер/логика),
- **t_path** — путь реакции (HW trip, RT‑ISR, APP‑таск),
- **t_disable_pwm** — время до гарантированного отключения ШИМ,
- **t_disable_gate** — время до гарантированного снятия gate‑enable,
- **t_total_off** = max(t_disable_pwm, t_disable_gate) + запас (margin).

Рекомендуемый инженерный запас:
- **margin_hw = 20–50%** для микросекундных путей,
- **margin_sw = 1–2 цикла ISR** для RT‑путей.

---

### 3.2 Бюджеты по событиям (целевые значения)

#### E-1: DESAT на силовом ключе (самая быстрая авария)
- Типичная природа: пробой/недонасыщение, требующее немедленной реакции.
- Ожидаемый путь: **DRV (DESAT) → DRV disable / fault → TIM_BRK / GE_CHAIN**.

**Целевой бюджет:**
- t_detect (DESAT внутри DRV): **~1–3 мкс** (зависит от настроек DESAT/blanking)
- t_disable_pwm (TIM_BRK): **< 1 мкс** (в пределах аппаратной логики таймера)
- t_disable_gate (DRV disable / GE_CHAIN): **~1–5 мкс**
- t_total_off (цель): **≤ 5–10 мкс**

---

#### E-2: Аппаратный overcurrent/short (быстрый OC на драйвере)
Путь аналогичен DESAT.

**Цель:** **≤ 5–10 мкс** до прекращения управления.

---

#### E-3: Превышение Imax по измерению (AD7380 + Rogowski), RT‑монитор
Путь: **ADC sample → MCU_RT ISR check → PWM=0 + GE off**.

Вклад времени:
- t_sample: зависит от частоты дискретизации AD7380 и схемы синхронизации с PWM
- t_compute: длительность ISR (обычно единицы микросекунд)
- t_update_pwm: момент применения обновления (зависит от режима таймера — immediate / next update)

**Целевой бюджет (примерно):**
- t_detect (до попадания «плохого» сэмпла в ISR): **0.5–1.0 периода дискретизации**
- t_compute (ISR): **~2–8 мкс** (цель)
- t_disable_pwm: **≤ 1 PWM update** (или немедленно через break при критике)
- t_total_off (цель): **≤ 1 период PWM + 10–20 мкс**
  - при PWM 4 кГц период 250 мкс → цель **≤ ~270 мкс**
  - при PWM 1 кГц период 1000 мкс → цель **≤ ~1020 мкс**

> Для действительно опасных сценариев (разрушение/пожар) лучше опираться на HW‑защиты, а SW‑надзор считать вторым эшелоном.

---

#### E-4: Потеря команды ТК (EtherCAT PDO timeout / stale)
Путь: **MCU_RT таймер → ramp Iref→0 → disable**. Это событие обычно не микросекундное.

Рекомендуемые параметры:
- t_timeout_detect: **N = 10–50 мс** (подбирается под динамику процесса)
- t_ramp_down: **10–100 мс** (контролируемый спад)
- t_disable_gate после окончания ramp: **< 1 мс** (логика safe-state)
- t_total_off: **десятки–сотни миллисекунд**

---

#### E-5: Перегрев / отказ охлаждения
Путь: датчик температуры/поток → MCU_RT/APP → ramp/down → disable.
Шкала: **десятки–сотни миллисекунд**, иногда секунды (в зависимости от тепловой инерции), но реакция должна быть предсказуемой и защёлкнутой.

---

#### E-6: Зависание МК (watchdog)
Путь: WDG expiry → reset → безопасный запуск.
Шкала: **миллисекунды** (по настройке WDG). Это не «микросекундная» защита и не должна быть единственной линией.

---

### 3.3 Что нужно зафиксировать в проекте (как доказательство)

Для каждого события E‑1…E‑6 в проекте стоит иметь:
1) **Точку измерения** (GPIO toggle / лог событий / осциллограф),
2) **Определение “OFF”** (PWM low + gate disabled),
3) **Worst-case измерение** на реальном железе (max из серии),
4) Привязку к версии прошивки/настроек (таймер, DRV thresholds, ADC rate).

---

## 4) Мини‑список «вопросов, которые закрывает этот артефакт»

- Кто именно «снимает энергию» и что будет при зависании МК?
- Сколько микросекунд до отключения при DESAT/OC?
- Какая часть реакции аппаратная, а какая программная?
- Что происходит при потере legacy CAN (если включён)?
- Что происходит при потере обновления EtherCAT PDO?
- Где граница между safety и технологическими функциями?

---

## 5) Приложение: шаблон для заполнения “измеренными” значениями

После стендовых измерений добавьте раздел:

- E-1 DESAT: t_detect_meas, t_off_meas, условия (Udc, T, нагрузка)
- E-2 OC: …
- E-3 Imax via ADC: частота AD7380, синхронизация, worst-case ISR
- E-4 EtherCAT PDO timeout/stale: N, ramp, фактическое t_total
- E-5 thermal: пороги, гистерезис, реакция
- E-6 watchdog: period, кто кормит, подтверждение safe boot
