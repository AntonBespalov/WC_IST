# Сертификация и Safety-by-Design для источника MFDC/точечной сварки

## TL;DR

Даже если формально сертификация сейчас «не требуется», для источника сварочного тока почти всегда выгодно проектировать так, **как будто она может понадобиться**:

1. **Заранее определить опасности** и **«безопасное состояние»**.
2. Сделать критические защиты **аппаратно независимыми от МК**.
3. Обеспечить **детерминизм таймингов/измерений** и **воспроизводимую диагностику**.
4. Наладить **калибровку измерений** и **трассируемость требований/изменений**.

Если позже возникнет запрос на соответствие стандартам — архитектуру не придётся переделывать «с нуля».

---

## 1) Взгляд на сертификацию для твоего случая

Источник **MFDC/контактной сварки** — это устройство **высокой энергии** с рисками:

- **поражение током**
- **пожар/перегрев**
- **разрушение силовой части**
- **опасные режимы** при сбоях управления

Даже без требований рынка/заказчика по **SIL/PL**, инженерно ты всё равно живёшь «в мире рисков».

### Два уровня «нормативности», которые полезно держать в голове

#### Уровень A — безопасность оборудования контактной сварки (как изделия)

- **IEC 62135-1:2015** — *Resistance welding equipment — Safety requirements for design, manufacture and installation*.  
  Не про «как писать код», а про ожидаемые **опасности и конструктивные меры** (изоляция, зазоры/пути утечки, защита от поражения током, условия установки и т.п.).

- **ISO 669:2016** — про мех/электр характеристики оборудования; отдельно отмечено, что требования безопасности покрываются **IEC 62135-1**.

#### Уровень B — функциональная безопасность (если safety-функции реализуются управлением)

Если в системе есть **safety-функции**, реализуемые системой управления машины, обычно смотрят на:

- **ISO 12100:2010** — методология оценки рисков и снижения риска для машин (*type-A* стандарт).
- **ISO 13849-1:2023** — *Safety-related parts of control systems* (**PL**), включает требования и к ПО.
- **IEC 62061:2021** — функциональная безопасность систем управления машин (**SIL**-подход), в домене IEC 61508.
- **IEC 61508** — базовый стандарт функциональной безопасности для **E/E/PE** систем, на который опираются доменные.  
  Дополнительно появляются документы вокруг assurance ПО, например **IEC TS 61508-3-2:2024**.

> Даже если вы **не будете официально сертифицироваться**, эти документы полезны как **чек‑лист инженерной зрелости**.

---

## 2) Что стоит сделать «обязательно» в ПО источника (даже без сертификации)

### 2.1. Явно определить «безопасное состояние» и правила перехода в него

Для твоей платы «безопасное состояние» обычно:

- **ШИМ = 0** (или выключен аппаратно)
- силовая часть в безопасном состоянии (**контактор/разрешение драйверов снято**)
- понятный **код причины остановки** + **сохранение контекста** в лог

Критично: любой сбой связи с ТК (**CAN timeout**, битые кадры, рассинхрон) должен приводить к **предсказуемому** безопасному поведению:

- контролируемый спад **уставки к нулю**
- затем **отключение**

### 2.2. «Защиты должны жить без МК»

Принцип из мира функциональной безопасности (и просто здравый смысл для силовой электроники):

- аппаратный **overcurrent / desat** / защита драйвера
- аппаратное отключение **ШИМ/разрешения** при авариях
- **watchdog**, который гарантированно снимет управление при зависании
- по возможности отдельная **цепь разрешения** (*hardware interlock*), которую МК не может «проигнорировать»

Зачем: ПО может зависнуть или «поехать» по памяти — **силовая часть не должна**.

### 2.3. CAN становится частью контура управления → нужен «control-grade» протокол

Минимум, который резко повышает безопасность и отлаживаемость:

- **sequence number** у команд
- **timeout** на команду  
  *(N мс без команды → безопасный режим)*
- «**эхо**» применяемой команды/`seq` в телеметрии
- флаги **лимитов/насыщений/отказов датчиков**, чтобы ТК не «крутил уставку в стену»

Это не про сертификаты — это про то, чтобы внешний контур ТК не сделал систему нестабильной при редких сбоях.

### 2.4. Метрология тока/напряжения и калибровка

Если ТК считает сопротивление и делает динамическое управление, **качество измерений** становится частью качества сварки.

Есть ISO‑руководства по измерению/калибровке сварочного тока для контактной сварки:

- **ISO 17657-1:2005** *(актуальность подтверждена в 2024)*

Даже если не следовать «буква в букву», это полезно, чтобы:

- формализовать калибровку (**оффсет/масштаб**)
- определить, что такое «**точность измерения**» в ваших условиях
- не спорить потом на приёмке, почему токи «разные на стенде и в поле»

### 2.5. Детерминизм таймингов и воспроизводимость — будущий «золотой актив»

Если когда‑нибудь появится требование качества/сертификации, спросят не «какой у вас PI», а:

- какие гарантии по времени: **sample → compute → update PWM**
- как доказываете, что при нагрузке **CAN/логированием** контур не разваливается
- какие у вас **worst‑case задержки/джиттер**

Поэтому стоит с самого начала:

- изолировать **real‑time контур** в коротком **ISR**
- все «красивости» (фильтры телеметрии, упаковка CAN, запись во внешнюю память) — строго **ниже по приоритету** и **без блокировок**

---

## 3) Если требования появятся позже: «минимальный пакет», который стоит подготовить заранее

Это можно сделать почти без бюрократии — но оно экономит месяцы потом:

- **Risk register** на 1–2 страницы по логике ISO 12100:  
  *опасность → мера снижения → чем подтверждаем*
- **Safety requirements list**: что является safety‑функцией, а что нет
- **Traceability**: у каждого требования есть тест/проверка
- **V&V дисциплина**:
  - code review
  - статанализ
  - юнит‑тесты математики (фильтры/контроллер/проверки диапазонов)
- **Политика обновлений/версий**: возможность воспроизвести любую прошивку и логи

Если нужен ориентир по «машинной функциональной безопасности», то **ISO 13849-1:2023** и **IEC 62061:2021** — самые вероятные «точки притяжения» в машиностроении.

---

## 4) Про идею «цифрового осциллографа» с внешней памятью

Это практика, которая помогает и безопасности, и качеству, потому что даёт:

- доказательство корректности (лог можно приложить к дефекту)
- быструю диагностику редких «плавающих» аварий
- базу для улучшения алгоритмов и разговора с заказчиком/ТК

**Обязательное ограничение:** логирование не должно влиять на контур.

- буферы/**DMA**
- запись пакетами
- запрет блокировок в **ISR**
- счётчики пропусков/переполнений, чтобы всегда знать, что лог «полный»

---

## TL;DR (повтор, как итог)

Даже без формального требования **SIL/PL** я бы спроектировал ПО и плату так, чтобы:

- **критическое отключение энергии** не зависело от обычной логики/связи
- было ясно, какие функции у вас **safety** (снижают риск для людей/пожара), а какие просто защитные/технологические
- можно было **доказуемо воспроизвести** тайминги/события по логам

Понять, реализуешь ли ты safety‑функции, можно прагматично:

> если снижение риска в системе **опирается на действие** вашей платы/ПО — это **safety‑функция** (даже если вы не сертифицируетесь).

---

# Safety & Robustness by Design для твоей архитектуры  
*(МК → ШИМ 1–4 кГц, CAN, лог в память, выгрузка по RS‑485)*

## 0) Контекст стандартов (чтобы говорить на одном языке)

- **IEC 62135-1:2015** — базовые требования электробезопасности для оборудования контактной сварки.
- **ISO 12100:2010** — методология: опасности → оценка риска → меры снижения риска.
- Если safety‑функции выполняет система управления:  
  **ISO 13849-1:2023** (PL) и/или **IEC 62061:2021** (SIL).

Это не означает «вам срочно нужна сертификация». Это означает: эти документы задают **правильную архитектуру мышления**.

## 1) «Обязательный минимум» даже без сертификации

### 1.1. Чётко определить safe-state и «кто имеет право» включать энергию

Safe-state почти всегда:

- ШИМ отключён
- драйверы/силовая часть **аппаратно запрещены** (не только программно)
- причина/код аварии сохранены
- система не стартует «сама собой» без явного разрешения

### 1.2. Развести в архитектуре 3 уровня (главный выигрыш)

1. **Аппаратный уровень защиты** *(не зависит от МК)*:  
   `desat/overcurrent` драйвера, предохранители/автоматы, аппаратный **break** вход таймера, аппаратное снятие разрешения (*gate-enable*).

2. **Быстрый «защитный монитор» в МК** *(высший приоритет, короткий, без CAN/логики)*:  
   следит за током/напряжением/температурами/таймингами и гарантированно переводит в safe-state.

3. **Обычная прикладная логика**:  
   CAN, фильтры «для ТК», запись в память, сервисные режимы.

Ключ: даже если (3) зависла или CAN «залип» — (1)+(2) продолжают защищать.

### 1.3. CAN не должен быть «единственной тормозной педалью»

Если потеря связи может привести к опасному режиму:

- делай **timeout**: нет валидной команды N мс → мягко уводим `Iref` к 0 → выключаем силовую часть
- лучше, чтобы «силовая часть разрешена» была **отдельным входом** от верхнего уровня безопасности (интерлок/реле/контактор), а не «разрешение по CAN»

---

## 2) Как понять: есть ли у вас safety‑функции

### Быстрый критерий (самый практичный)

Ты реализуешь **safety‑функцию**, если:

- функция снижает риск опасного события (для человека/пожара/поражения током)
- без этой функции риск был бы неприемлем

Это соответствует логике **ISO 12100**: оценка риска → меры снижения риска.  
Если мера — действие системы управления, это и есть safety‑функция.  
**ISO 13849-1** описывает SRP/CS как выполняющие safety‑функции и включает требования к ПО.

### «Процедура на салфетке» (30–60 минут)

1. **Границы системы**: что ваша плата делает и чего не делает (5–10 строк).
2. **Опасности** (по ISO 12100):
   - поражение электричеством
   - пожар/перегрев
   - выброс расплава/искры
   - непреднамеренная подача энергии (самопроизвольное включение)
   - разрушение силовой части с вторичными последствиями
3. **Опасные события**: что должно пойти не так (например, завис МК и оставил ШИМ включённым).
4. **Меры снижения риска**:
   - если мера конструктивная (изоляция/зазоры/кожухи) — это не safety‑функция ПО
   - если мера «контроллер обязан отключить энергию при X» — это safety‑функция/часть safety‑функции
5. **Распределение ответственности**: кто выключает? драйвер? реле? ваш МК? ТК по CAN?  
   Если единственная защита — команда по CAN, это **красный флаг**.

### Примеры для источника

- «Отключить силовую часть при аварийном стопе/интерлоке» — почти всегда safety‑функция всей машины; ваша плата может быть исполнительным звеном (Enable от safety‑реле).
- «Отключить при перегреве/отсутствии охлаждения» — часто safety‑функция (пожар/ожоги), даже если сначала кажется «защитой железа».
- «Отключить при потере CAN‑команд» — зависит от сценария: если возможна опасная самоподача энергии → safety‑связанная; если максимум — брак точки → технологическая.
- «Ограничение `dI/dt` или `Imax`» — чаще защита оборудования/качества; но при риске разрушения может стать safety‑мерой.

Главная мысль: safety — это не «есть сертификат или нет», а «на это опирается снижение риска или нет».

---

## 3) Рекомендации, на которых стоит «упереться»

### 3.1. Аппаратное отключение ШИМ и силовой части (must-have)

- вход разрешения силовой части (**gate enable**) аппаратный, с логикой «0 = запрет»
- аппаратный **trip/break** в таймере ШИМ (мгновенно уводит выходы в безопасный уровень)
- отдельный путь отключения, **не зависящий** от CAN и «обычного» ПО

### 3.2. Тайминги как часть безопасности и качества

- real‑time контур (измерение → регулятор → PWM update) не зависит от нагрузки CAN/логирования
- мониторинг «контур жив»: если ISR перестал выполняться или измерение не обновляется — выключить выход

### 3.3. Диагностика ограничений в телеметрии (обязательно)

Чтобы ТК не «дожимал в стену»:

- флаги `saturation/limit` (duty limit, Udc low, thermal limit)
- `I_ref_used`, `u_control`
- `fault code` + timestamp

### 3.4. Логирование‑«осциллограф» — да, но безопасно

- запись через DMA/буферы, никаких блокировок в ISR
- счётчики: переполнение буфера, пропуск кадров, задержки
- при fault сохранять **предысторию** (например, последние 0.5–2 с) + пост‑аварийный хвост

---

## 4) Мини‑шаблон карты функций: safety / protective / quality

Три списка помогают не спорить словами:

- **Safety-related** (если риск снижается за счёт функции):  
  interlock/enable, участие в emergency‑stop цепи, отключение при крит. перегреве, watchdog‑shutdown, аппаратный trip по overcurrent.
- **Protective** (защита железа; часто делается почти так же строго):  
  `Imax`, `dI/dt`, `Udc brown-out` ограничения, защита от насыщения, timeout CAN.
- **Quality/control** (только технологичность):  
  фильтры I/V, телеметрия, расчёт статистик, профили тока от ТК.

Если сомневаешься, куда отнести — временно относишь **выше** (*safety-related/protective*) и строишь так, чтобы отключение было независимым.

---

## 5) Если позже потребуется формализация

У тебя уже будет база:

- логика ISO 12100 (опасности/риски/меры)
- выбор дорожки: **ISO 13849-1 (PL)** или **IEC 62061 (SIL)**
- аспекты электробезопасности по **IEC 62135-1**
