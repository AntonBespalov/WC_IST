# Пакет подтверждения проектных решений (Design Assurance Package, DAP)
## Источник MFDC — STM32G474 / AD7380 / Катушка Роговского / SKYPER 42R

---

## 1. Область применения (Scope)

Данный документ адаптирует принципы **Safety-by-Design** и функциональной безопасности к конкретной архитектуре источника сварочного тока MFDC:

- **Микроконтроллер:** STM32G474  
- **Измерение тока:** катушка Роговского + АЦП AD7380  
- **Драйверы силовых ключей:** SKYPER 42R (2 шт.)  
- **Силовые модули:** SEMiX252GB12  
- **Управление:** ШИМ 1–4 кГц  
- **Связь с ТК:** EtherCAT PDO, период команд/статуса **250 мкс (4 кГц)**  

Источник рассматривается как **быстрый детерминированный привод тока**, в то время как технологический комплекс (ТК) выполняет функции процессного управления сваркой.

Ключевой принцип безопасности:
> **Снятие энергии не должно зависеть исключительно от программного обеспечения или связи с ТК (EtherCAT).**

(Для проекта: критические аварии должны иметь аппаратный shutdown-path; связь с ТК (EtherCAT) не является “рубильником”.)

---

## 2. Обзор архитектуры системы

Архитектура источника строится по многоуровневому принципу:

- аппаратные защиты силовой части действуют независимо от МК;
- МК выполняет быстрый контур тока и мониторинг;
- высокоуровневая логика и задания поступают от ТК.

Даже при отказе ПО или потере связи источник обязан перейти в **безопасное состояние**.

---

## 3. Карта safety‑функций (HW / SW)

### SF‑1: Аварийное снятие энергии

**Назначение:** предотвращение опасной подачи сварочного тока.

**Аппаратная часть (HW):**
- защита DESAT / Overcurrent драйверов SKYPER 42R;
- аппаратная цепь разрешения силовой части (fail‑safe = OFF);
- вход аварийного останова (Break) таймера ШИМ.

**Программная часть (SW):**
- фиксация (latch) аварии;
- управляемый спад тока перед отключением (если позволяет время).

---

### SF‑2: Обнаружение отказа микроконтроллера

**Назначение:** предотвращение опасных режимов при зависании МК.

**HW:**
- независимый сторожевой таймер (Watchdog).

**SW:**
- обслуживание watchdog только из детерминированного real‑time контура;
- запись причины сброса и переход в безопасное состояние.

---

### SF‑3: Контроль сверхтока и аномальной формы тока

**Назначение:** защита от разрушения силовой части и опасных токов.

**HW:**
- аппаратные защиты драйверов.

**SW:**
- контроль достоверности измерений (AD7380 + катушка Роговского);
- контроль Imax и dI/dt;
- диагностика насыщения и ошибок измерения.

---

### SF‑4: Потеря управляющих команд (timeout связи с ТК)

**Назначение:** предотвращение самопроизвольной подачи энергии.

**HW:**
- отсутствует (информационный канал).

**SW:**
- контроль таймаута связи с ТК (EtherCAT PDO stale);
- плавное снижение уставки тока до нуля;
- отключение силовой части при длительном таймауте.

---

## 4. Реестр рисков (ISO 12100, сокращённый вариант)

### Опасность: поражение электрическим током / избыточный сварочный ток

- **Опасная ситуация:** зависание МК при активном ШИМ  
- **Риск до мер:** высокий  
- **Меры снижения риска:**
  - аппаратный вход Break ШИМ;
  - аппаратная цепь разрешения драйверов;
  - независимый watchdog  
- **Остаточный риск:** низкий  

---

### Опасность: пожар / перегрев

- **Опасная ситуация:** отказ охлаждения при продолжающейся сварке  
- **Меры снижения риска:**
  - температурный контроль;
  - тепловое отключение  
- **Остаточный риск:** низкий–средний  

---

### Опасность: непреднамеренная подача энергии

- **Опасная ситуация:** потеря или искажение команд ТК (EtherCAT PDO)  
- **Меры снижения риска:**
  - таймаут EtherCAT PDO;
  - безопасный запуск (ШИМ отключён по умолчанию)  
- **Остаточный риск:** низкий  

---

## 5. Детерминизм и гарантии таймингов

- real‑time контур (измерение → регулятор → обновление ШИМ) изолирован от EtherCAT и логирования;
- синхронизация выборки АЦП с ШИМ;
- документированный worst‑case бюджет задержек;
- логирование реализовано через DMA и никогда не блокирует ISR.

---

## 6. Стратегия верификации и валидации (V&V)

**Модульные тесты:**
- масштабирование тока;
- логика ограничений;
- пороги аварий.

**Интеграционные тесты:**
- потеря связи с ТК (EtherCAT);
- инъекция отказов (зависание АЦП, reset watchdog).

**Трассируемость:**
- каждая safety‑функция связана с конкретным тестом и результатом проверки.

---

## 7. Заключение

Данный пакет подтверждения проектных решений:

- обеспечивает чёткое разделение safety‑логики и обычного управления;
- опирается на аппаратное снятие энергии как основной механизм безопасности;
- совместим с требованиями **ISO 12100**, **ISO 13849‑1** и **IEC 62135‑1**;
- позволяет в будущем перейти к формальной сертификации без переработки архитектуры.

Документ предназначен для использования как внутренний инженерный артефакт,
а также как основа для аудита или сертификационного проекта.
