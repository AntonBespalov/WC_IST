# SAFETY CONCEPT (SC)
## Fail‑Safe остановка сварочного тока  
**STM32G4 + SKYPER 42 R + CBM706T**

---

## TL;DR

Сварочный ток должен **гарантированно прекращаться аппаратно**, даже если:

- микроконтроллер **завис**;
- прошивка **повреждена**;
- питание **«грязное»** (brown‑out / провалы / помехи);
- таймеры продолжают генерировать **ШИМ**.

Для этого применяется **слоистая fail‑safe архитектура** (defence‑in‑depth), где:

- **быстрые аварии** гасятся за **микросекунды**;
- отказ МК приводит к **аппаратному запрету драйверов**;
- **reset** используется для **восстановления**, а не для безопасности.

Выбранный внешний watchdog/supervisor **CBM706T** используется:

- как **источник аппаратной аварии (FAULT)**,
- а не просто как генератор **RESET**.

---

## 1. Назначение документа

Настоящий **Safety Concept** описывает архитектуру, принципы и механизмы, обеспечивающие:

- **гарантированную остановку сварочного тока** при отказах управления, питания или измерений,
- включая полный отказ (зависание) микроконтроллера.

Документ определяет:

- **безопасные состояния** (Safe State);
- **каналы обнаружения отказов**;
- **аппаратные реакции**;
- принципы **восстановления** (Recovery).

---

## 2. Границы системы (Scope)

### Входит в Scope

- источник сварочного тока **MFDC**;
- силовой инвертор с IGBT‑модулями;
- управление на **STM32G4**;
- драйверы затворов **SKYPER 42 R**;
- внешний watchdog/supervisor **CBM706T**;
- аппаратные цепи аварийного отключения.

### Не входит в Scope

- внешние механические защиты (двери, кожухи);
- безопасность оператора рабочего места;
- высший уровень ПЛК / технологический комплекс (ТК).

---

## 3. Основная safety‑цель (Safety Goal)

### SG‑1

При любом отказе управления или питания сварочный ток должен **прекратиться** и **не возобновляться самопроизвольно**.

### Декомпозиция SG‑1

- **SG‑1.1** — прекращение **ШИМ**;
- **SG‑1.2** — запрет управления **затворами**;
- **SG‑1.3** — удержание безопасного состояния до **осознанного восстановления**.

---

## 4. Безопасное состояние (Safe State)

**Safe State** — это состояние, при котором:

- силовые ключи **закрыты**;
- драйверы затворов **запрещены**;
- сварочный ток **отсутствует**;
- автоматическое восстановление **невозможно**.

**Важно:** **Reset микроконтроллера не считается безопасным состоянием.**

---

## 5. Базовые принципы безопасности (Safety Principles)

### 5.1 Fail‑safe по умолчанию
Если нет активного и осознанного разрешения — сварочный ток **невозможен**.

**Следствия:**
- нельзя полагаться на код для остановки тока;
- reset МК не является “безопасностью”;
- разрешение силовой части — отдельный сигнал.

### 5.2 Аппаратная независимость
Остановка тока не зависит от выполнения кода (RTOS/ISR/планировщик).

### 5.3 Слоистая защита (defence‑in‑depth)
Используются быстрые и медленные каналы отключения.

### 5.4 Разделение ролей
- **Reset → восстановление**
- **Fault → безопасность**

### 5.5 Latched‑OFF поведение
Любая авария приводит к **устойчивому OFF** до явной процедуры восстановления.

---

## 6. Архитектура безопасности (Overview)

### 6.1 Слои остановки сварочного тока

- **S1 — Быстрый аппаратный Stop ШИМ (µs)**  
  Асинхронно гасит PWM аппаратно, без участия CPU.

- **S2 — Аппаратный запрет драйверов затворов (µs–ms)** *(ключевой слой)*  
  Делает так, что наличие ШИМ не имеет значения, если МК не “жив”/не разрешён.

- **S3 — Внешний watchdog/supervisor CBM706T (ms)**  
  Обнаруживает отказ ПО или питания и инициирует **аппаратную аварию**.

- **S4 — Силовое обесточивание (ms…10 ms)** *(опционально)*  
  Последний рубеж: снятие питания драйверов, контактор DC‑link, разряд конденсаторов.

---

## 7. Реализация слоёв безопасности

### 7.1 S1 — Аппаратный Stop ШИМ (Break)

**Реализация:**
- Advanced timers **TIM1 / TIM8** (STM32G4)
- входы **BKIN / BKIN2**
- аппаратный сброс **MOE**
- безопасные уровни выходов задаются аппаратно (Off‑state)

**Источники Break:**
- аналоговый компаратор по току (**fast OCP**)
- **fault / desat** от драйвера
- внешние аварии (interlock/E‑STOP и т.п.)
- сигнал watchdog/supervisor (**CBM706T**) — опционально

**Свойства:**
- асинхронное срабатывание (не требует CPU)
- быстрый запрет PWM (µs)
- **Break не должен автоматически самосбрасываться**  
  (чтобы исключить самовключение при коротком импульсе аварии)

---

### 7.2 S2 — Запрет драйверов затворов (Primary Safety Layer)

**Компонент:** SKYPER 42 R  
**Критический вход:** **PRIM_nERROR_IN (SDI), Active LOW**  
**Поведение:** аппаратная защёлка (**latch**) ошибки

**Назначение:**
Сделать так, чтобы никакой ШИМ не имел значения, если система не имеет явного разрешения.

**Ожидаемое поведение при PRIM_nERROR_IN = LOW:**
- драйвер игнорирует входы **TOP/BOT**
- ключи остаются **выключенными**
- ошибка **защёлкивается** до явного сброса

**Роль в архитектуре:**
Это основной fail‑safe рубеж при зависании МК и/или “странном” поведении таймеров.

---

### 7.3 S3 — Внешний watchdog/supervisor (CBM706T)

CBM706T выполняет **две разные функции**, и их нельзя смешивать:

- **RESET_OUT → NRST STM32**  
  функция: **восстановление управляемости МК**

- **WDO/FAULT_OUT → запрет силовой части**  
  функция: **аппаратная безопасность** (Fault)

**Ключевой принцип:**  
**Reset ≠ безопасность.**  
Безопасность обеспечивается через **SDI (S2)** и/или **Break (S1)**.

---

### 7.4 S4 — Силовое обесточивание (опционально)

Используется как последний рубеж/дополнение:

- снятие питания драйверов
- контактор DC‑link
- разряд конденсаторов

**Время реакции:** миллисекунды.  
**Не заменяет** S1–S2, а дополняет их.

---

## 8. Роль CBM706T в fail‑safe архитектуре

### 8.1 CBM706T как элемент safety‑цепи

CBM706T рассматривается не как “просто watchdog”, а как часть **аппаратной safety‑цепи**, способная:

- фиксировать зависания/ошибки ПО (по heartbeat),
- фиксировать проблемы питания (brown‑out),
- формировать аппаратный **FAULT** на запрет сварки.

### 8.2 Основные сигналы и назначения

- **RESET_OUT**  
  → `NRST` STM32  
  *назначение:* восстановление МК

- **WDO / FAULT_OUT**  
  → `PRIM_nERROR_IN` (SDI) SKYPER 42 R  
  → *(опционально)* `BKIN` таймера  
  *назначение:* аппаратный запрет сварки

**Выход FAULT_OUT используется как Active LOW**  
(через open‑drain или транзисторный каскад — по схеме).

---

## 9. Поведение при отказах (Failure → Reaction)

### F‑1: Зависание МК

**Обнаружение:** watchdog timeout (пропал heartbeat).

**Реакция:**
1. CBM706T активирует **FAULT_OUT = LOW**
2. FAULT_OUT тянет **PRIM_nERROR_IN = LOW**  
   *(и при необходимости активирует BKIN)*
3. Драйвер:
   - выключает ключи
   - **защёлкивает ошибку (latch)**

**Результат:**
- даже если ШИМ продолжает идти,
- даже если FAULT_OUT потом отпустится,

силовая часть остаётся **выключенной** за счёт latch драйвера и политики Break.

---

### F‑2: Сбой питания / brown‑out

**Обнаружение:** supervisor CBM706T фиксирует недопустимое `VDD`.

**Реакция:**
- активируется **RESET_OUT** (перезапуск МК)
- активируется **FAULT_OUT** (запрет силовой части)

**Результат:**
Силовая часть запрещена до стабилизации питания и **явного** восстановления.

---

### F‑3: Перегрузка / КЗ

**Обнаружение:** аналоговый компаратор тока (fast OCP) и/или сигнал драйвера.

**Реакция:**
- **BKIN → PWM OFF (µs)**

**Дополнительно:**
- возможно/желательно удержание OFF через S2 (latch драйвера), чтобы импульсная авария стала устойчивым OFF.

---

### F‑4: Ошибка драйвера

**Обнаружение:** выход драйвера (например, `PRIM_nERROR_OUT` / fault).

**Реакция:**
- **BKIN** (S1) для мгновенного отключения PWM
- фиксация аварии ПО для диагностики и процедуры восстановления

---

## 10. Ключевой принцип: импульсная авария → устойчивое OFF

CBM706T может формировать:

- импульс FAULT_OUT,
- либо удержание в течение заданного времени.

**Архитектура не должна зависеть от длительности импульса.**

Это достигается комбинацией:

- latch‑логики внутри **SKYPER 42 R** (S2),
- отсутствием автосброса **Break** (S1),
- процедурой восстановления только через ПО/оператора.

---

## 11. Взаимодействие сигналов (логика)

### 11.1 Быстрый путь (fast trip)

`COMP / SKYPER nERROR_OUT → BKIN → PWM OFF`

### 11.2 Fail‑safe при отказе МК

`CBM706T FAULT_OUT → PRIM_nERROR_IN (SDI) → Gates OFF (latched)`

### 11.3 Восстановление

`CBM706T RESET_OUT → NRST STM32 → ПО: диагностика → разрешение силовой части`

---

## 12. Fail‑safe состояния по умолчанию (Power‑up / Reset / неопределённость)

При reset, старте, неопределённости:

- `PRIM_nERROR_IN = LOW`
- PWM запрещён
- входы драйвера подтянуты к безопасным уровням

**Разрешение сварки требует двух условий одновременно:**
1. валидный ШИМ (PWM разрешён и корректен)
2. снят аппаратный запрет (SDI поднят, fault‑цепь чистая)

---

## 13. Требования к ПО (Safety‑related SW constraints)

- watchdog **никогда** не “пинается” таймером или DMA
- heartbeat формируется **задачей‑супервизором**
- supervisor проверяет:
  - валидность измерений
  - состояние контуров управления
  - наличие аварийных флагов/таймаутов
- таймеры, DMA и прерывания не имеют права напрямую “поддерживать жизнь” watchdog

---

## 14. Практические инженерные правила (Implementation Notes)

- аварийные линии:
  - короткие
  - с понятной землёй/возвратными токами
  - без “логических фокусов” и неоднозначных уровней
- исключить сценарии “самовключения”:
  - запрет AOE/автовосстановлений там, где это опасно
  - явная процедура снятия latch и разрешения сварки

---

## 15. Итоговая формула архитектуры

**Reset нужен, чтобы продолжить работу.  
Авария нужна, чтобы гарантировать безопасность.  
Эти вещи нельзя смешивать.**

Связка:

**STM32G4 + SKYPER 42 R + CBM706T**

образует корректную промышленную fail‑safe архитектуру для MFDC‑сварки:

- предсказуемое поведение при отказах
- устойчивое **OFF‑состояние**
- готовая база для **FMEA/FMEDA**
- основа для развития в **ISO 13849‑1 (PL c/d)** или IEC‑ориентированный safety‑кейс

---

## 16. Статус документа

- Тип: **Safety Concept (SC)** / **FSC‑light**
- Уровень: архитектурный
- Готовность: база для FMEA / ISO 13849‑1

**Логичные следующие шаги (по желанию):**
- “Failure Mode → Reaction → Safe State” (структура для FMEA)
- Safety State Diagram (граф состояний)
- привязка к ISO 13849‑1 (PL c / PL d)
