# PCCOM 4.02 — профиль проекта (WC_IST)

Этот документ содержит проектные узлы/команды и соглашения поверх базовой спецификации PCcom 4.02.
Базовая спецификация: `docs/protocols/PCCOM4.02.md`.

### 3.1. Адреса в проекте SmartAxis.USPF

| Адрес PCcom4 / CAN | Адресат |
|---:|---|
| `0x01` | ПК / ТК |
| `0x03` | плата источника сварочного тока (УСПФ) |

## 11. Профиль проекта MFDC (плата ↔ ПК): сервис `SelfTest`

Этот раздел — **проектное расширение** поверх PCcom 4.02, описывающее сервисные команды для отладки и производственной диагностики (см. `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`, `docs/PROJECT_CONTEXT.md` и `docs/TEST_PLAN.md`).

### 11.1. Общие правила

- Все многобайтные поля в `Data` в этом профиле кодируются в **network order (MSB first)**.

#### 11.1.1. Политика настройки регулятора тока (tuning)

- Параметры настройки контура регулирования тока (коэффициенты регулятора и связанные с ними калибровки/константы) являются **сервисными** и допускаются к изменению **только через сервисное ПО по UART (PCcom)**.
- По CAN удалённая запись tuning-параметров запрещена (см. `docs/protocols/PROTOCOL_TK.md`): любые команды/операции, пытающиеся изменить коэффициенты/калибровки, должны быть отклонены и не должны приводить к изменениям ни в ОЗУ, ни в NVM.
- Применение изменений: on-the-fly запрещено; изменение tuning-параметров допускается только в `Service mode` и только при запрещённой сварке (не `ARMED/WELD`, PWM подтверждён как OFF). Применение — по явной команде `Apply/Commit` (либо через перезапуск по проектной политике).
- Целостность/валидация: формат данных tuning-параметров должен включать версию структуры и CRC; значения должны проходить жёсткую валидацию (диапазоны, запрет NaN/Inf, знаки/тип). При ошибке валидации/CRC/версии запись и применение запрещаются.
- Fail-safe для NVM: если при старте обнаружены некорректные tuning-данные (CRC/версия/валидация), устройство должно использовать безопасный набор по умолчанию и запрещать переход в режимы, где требуется корректный контур, до сервисного исправления.

### 11.2. Узел `MFDC Service` (`Node = 0x30`)

#### 11.2.4. `SelfTest.Run` (`Op = 0x10`, запись) / `RUN_SELFTEST`

Назначение: запуск встроенной самодиагностики для производства/сервиса. Команда **не должна** влиять на fast loop и не должна запускаться при активном ШИМ.

Условия допуска (gating):
- `state = IDLE`, PWM подтверждён как OFF.

Запрос:
- `Type = 0x03`
- `Data` = 2 байта:
  - `byte0`: `test_mask_lo` (битовая маска тестов)
  - `byte1`: `test_mask_hi`

Маска тестов (Draft 0.1):
- bit0: `ADC_NOISE_FLOOR` (I/U при PWM OFF)
- bit1: `VREFINT`
- bit2: `TEMPERATURE_PLAUSIBILITY` (обрыв/КЗ/диапазон)
- bit3: `SAFETY_PATH_BKIN_FLAG` (опционально, только если безопасно реализуемо)

Ответ:
- если успешно: `Type = 0x05`, `Data` = 2 байта `result_code` (u16), где `0x0000` = STARTED
- если ошибка: `Type = 0x08`, `Data` = 2 байта `error_code` (u16) (TBD)

#### 11.2.5. `SelfTest.Status` (`Op = 0x11`, чтение)

Назначение: получить статус/результаты self-test, запущенного `SelfTest.Run`.

Запрос:
- `Type = 0x01`
- `Data` отсутствует

Ответ:
- `Type = 0x04`, `Data` = 16 байт:
  - `byte0`: `selftest_state` (u8): 0=IDLE, 1=RUNNING, 2=DONE
  - `byte1`: `selftest_result` (u8): 0=OK, 1=FAIL, 2=INCONCLUSIVE
  - `byte2..3`: `fail_mask` (u16, MSB first) — биты тестов, которые не прошли
  - `byte4..5`: `warn_mask` (u16, MSB first) — биты тестов с предупреждением (опционально)
  - `byte6..7`: `adc_noise_i_rms_lsb` (u16) — RMS шума канала тока в LSB (Draft 0.1)
  - `byte8..9`: `adc_noise_u_rms_lsb` (u16) — RMS шума канала напряжения в LSB (Draft 0.1)
  - `byte10..11`: `vrefint_mV` (u16) — оценка VDD по VREFINT (мВ) (Draft 0.1)
  - `byte12`: `temp1_status` (u8): 0=OK, 1=OPEN, 2=SHORT, 3=OUT_OF_RANGE (Draft 0.1)
  - `byte13`: `temp2_status` (u8): аналогично (Draft 0.1)
  - `byte14..15`: `reserved` (=0)

### 11.3. Профиль SmartAxis.USPF (УСПФ): узлы и операции PCcom4.02

Источник: `docs/protocols/Протокол SmartAxis.USPF.PCcom4.02.xlsx`.

Примечание: таблицы ниже основаны на xlsx, но **актуализированы под реализацию PCcom4 в проекте** (в одной операции меняется/читается только один параметр). Поэтому часть `Op` и форматов может отличаться от исходной таблицы.

Обозначения:
- `DataLen` — длина поля `Data` (в байтах).
- `FrameBytes` — длина кадра на линии (в байтах), **включая** `PREAMBLE=0xFF` (в таблицах из xlsx она дана как «Кадр»).
- Для команд/сообщений с фиксированной длиной выполняется `FrameBytes = 9 + DataLen`.

#### 11.3.1. Узел `Система` (`Node = 0x01`) — проектные операции

> Операции `0x01..0x7F` описаны в разделе 7 как зарезервированные. Ниже — расширение профиля SmartAxis.USPF.

| Операция | `Op` | `DataLen` | `FrameBytes` | Доступ | NVM | Формат/примечание |
|---|---:|---:|---:|---|---|---|
| Таймаут потери связи | `0x80` | 4 | 13 | чтение/запись | flash | `int32`, единицы: мс, default: 3000 |
| Сброс настроек во flash к значениям по умолчанию | `0xA0` | 1 | 10 | запись | flash | записать любое значение (payload игнорируется) |
| Запись настроек во flash | `0xA1` | 1 | 10 | запись | flash | записать любое значение (payload игнорируется) |
| Keep alive (ПК→УСПФ) | `0xB0` | 0 | 9 | сообщение | нет | используется для контроля наличия связи |

#### 11.3.2. Узел `Имитация обмена с ТК по CAN` (`Node = 0x03`)

| Операция | `Op` | `DataLen` | `FrameBytes` | Доступ | Формат/примечание |
|---|---:|---:|---:|---|---|
| Сообщение от ТК к УСПФ | `0x01` | 32 | 41 | сообщение | размер и формат данных будут уточнены |
| Сообщение от УСПФ к ТК | `0x02` | 20 | 29 | сообщение | размер и формат данных будут уточнены |

#### 11.3.3. Узел `Настройка параметров` (`Node = 0x04`)

| Параметр | `Op` | `DataLen` | `FrameBytes` | Доступ | NVM | Формат |
|---|---:|---:|---:|---|---|---|
| Регулятор тока: `Kp` | `0x01` | 4 | 13 | чтение/запись | flash | `float` |
| Регулятор тока: `Ki` | `0x02` | 4 | 13 | чтение/запись | flash | `float` |
| Регулятор тока: `Kd` | `0x03` | 4 | 13 | чтение/запись | flash | `float` |

#### 11.3.4. Узел `Управление` (`Node = 0x05`)

Правило реализации (PCcom4, проектное): в одной операции меняется/читается только один параметр.

Для `ManualDuty`:
- при потере сервис-связи > **20 мс** устройство обязано перейти в safe state и отключить `ManualDuty`;
- под “связью” понимается приход **любой валидной** команды `ManualDuty.*` по тому же физическому интерфейсу/каналу, через который режим был включён.

| Операция | `Op` | `DataLen` | `FrameBytes` | Доступ | NVM | Формат/примечание |
|---|---:|---:|---:|---|---|---|
| `ManualDuty.Enable` — включить/выключить `ManualDuty` | `0x01` | 1 | 10 | чтение/запись | нет | `u8`: `0x00`=OFF, `0x01`=ON |
| `ManualDuty.DutyTargetPermille` — установить/прочитать `duty_target_permille` | `0x02` | 2 | 11 | чтение/запись | нет | `u16` (0…1000, 0.1%/LSB), little-endian |
| `ManualDuty.SlewRatePermillePerPeriod` — установить/прочитать `slew_rate_permille_per_period` | `0x03` | 2 | 11 | чтение/запись | нет | `u16` (0 ⇒ default 2‰/period; range 1…10‰/period), little-endian |
| Провести самодиагностику | `0x10` | 1 | 10 | чтение/запись/команда принята | нет | `u8`: `0x00`=выключить, `0x01`=включить |
| Результат самодиагностики | `0x11` | 20 | 29 | сообщение | нет | размер и формат данных будут уточнены |

#### 11.3.5. Узел `Цифровой осциллограф` (`Node = 0x06`)

| Операция | `Op` | `DataLen` | `FrameBytes` | Доступ | Формат/примечание |
|---|---:|---:|---:|---|---|
| Управление передачей данных в выбранном формате (наборе) | `0x01..0x0F` | 1 | 10 | чтение/запись | `u8`: `0x00`=OFF, `0x01`=ON |
| Набор / наборы данных | `0x11..0x1F` | 2..246 | 11..255 | сообщение | см. раздел 11.3.6 (данные осциллографирования) |

#### 11.3.6. Форматы данных (SmartAxis.USPF)

Таблица 1 — кодирование версий (2 байта):
- `byte0` (MSB): версия
- `byte1` (LSB): подверсия

Таблица 2 — версия ПО (4 байта, порядок SmartAxis.USPF):
- `byte0`: `REV_L` (ревизия LSB)
- `byte1`: `REV_H` (ревизия MSB)
- `byte2`: `MINOR`
- `byte3`: `MAJOR`

Таблица 3 — кодирование многобайтных чисел: `byte0=LSB … byteN=MSB` (little-endian).

Таблица 4 — данные осциллографирования:
- `byte0`: номер набора данных
- `byte1..N`: данные одного или нескольких наборов данных (байт 1 входит в данные)

Таблица 5 — результаты самодиагностики:
- `byte0..19`: результаты самодиагностики (детализация формата будет уточнена)


