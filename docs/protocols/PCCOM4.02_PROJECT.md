# PCCOM 4.02 — профиль проекта (WC_IST)

Этот документ содержит проектные узлы/команды и соглашения поверх базовой спецификации PCcom 4.02.
Базовая спецификация: `docs/protocols/PCCOM4.02.md`.

## 1. Адресация проекта

### 1.1. Адреса PCcom4 / CAN

| Адрес PCcom4 / CAN | Адресат |
|---:|---|
| `0x01` | ПК / ТК |
| `0x03` | плата источника сварочного тока (УСПФ) |

## 2. Политики проекта

### 2.1. Политика настройки параметров

- Настроечные параметры (коэффициенты контура регулирования тока, связанные с ними калибровки/константы, и другие параметры системы) являются **сервисными** и допускаются к изменению **только через сервисное ПО по UART (PCcom)**.
- По CAN удалённая запись tuning-параметров запрещена (см. `docs/protocols/PROTOCOL_TK.md`): любые команды/операции, пытающиеся изменить коэффициенты/калибровки, должны быть отклонены и не должны приводить к изменениям ни в ОЗУ, ни во flash-памяти.
- Применение изменений: on-the-fly разрешено только для параметров, не требующих перезапуска системы; изменение tuning-параметров допускается только в `Service mode` и только при запрещённой сварке (не `ARMED/WELD`, PWM подтверждён как OFF). Сохранение изменений в flash-памяти — по явной команде `Запись настроек во flash` (либо через перезапуск).
- Целостность/валидация: значения должны проходить жёсткую валидацию (диапазоны, запрет NaN/Inf, знаки/тип). При ошибке валидации/CRC/версии запись и применение запрещаются.
- Fail-safe для flash-памяти: если при старте обнаружены некорректные tuning-данные (CRC/версия/валидация), устройство должно использовать безопасный набор по умолчанию и запрещать переход в режимы, где требуется корректный контур, до сервисного исправления.

## 3. Узлы и операции PCcom4.02 в проекте WC_IST

Обозначения:
- Длина поля данных (DataLen) — длина поля `Data` (в байтах).
- Длина кадра на линии (включая `PREAMBLE=0xFF`) = `9 + DataLen`.

### 3.1. Узел `Система` (`Node = 0x01`) — проектные операции

> Операции `0x01..0x7F` описаны в базовой спецификации (`docs/protocols/PCCOM4.02.md` / раздел 7) как зарезервированные. Ниже — расширение профиля WC_IST.

| Команда | Операция | Длина поля данных | Доступ | Сохраняется во flash | Формат/примечание |
|---|---:|---:|---|---|---|
| Таймаут потери связи | `0x80` | 4 | чтение/запись | flash | `int32`, единицы: мс, default: 3000 |
| Сброс настроек во flash к значениям по умолчанию | `0xA0` | 1 | запись | flash | записать любое значение (поле данных игнорируется) |
| Запись настроек во flash | `0xA1` | 1 | запись | flash | записать любое значение (поле данных игнорируется) |
| Keep alive (ПК→УСПФ) | `0xB0` | 0 | сообщение | нет | используется для контроля наличия связи |

### 3.2. Узел `Имитация обмена с ТК по CAN` (`Node = 0x03`)

| Команда | Операция | Длина поля данных | Доступ | Формат/примечание |
|---|---:|---:|---|---|
| Сообщение от ТК к УСПФ | `0x01` | 32 | сообщение | размер и формат данных будут уточнены |
| Сообщение от УСПФ к ТК | `0x02` | 20 | сообщение | размер и формат данных будут уточнены |

### 3.3. Узел `Настройка параметров` (`Node = 0x04`)

| Параметр | Операция | Длина поля данных | Доступ | Сохраняется во flash | Формат |
|---|---:|---:|---|---|---|
| Регулятор тока: `Kp` | `0x01` | 4 | чтение/запись | да | `float` |
| Регулятор тока: `Ki` | `0x02` | 4 | чтение/запись | да | `float` |
| Регулятор тока: `Kd` | `0x03` | 4 | чтение/запись | да | `float` |

### 3.4. Узел `Управление` (`Node = 0x05`)

Правило реализации (PCcom4, проектное): в одной операции меняется/читается только один параметр.

Для `ManualDuty`:
- при потере сервис-связи > **20 мс** устройство обязано перейти в safe state и отключить `ManualDuty`;
- под “связью” понимается приход **любой валидной** команды `ManualDuty.*` по тому же физическому интерфейсу/каналу, через который режим был включён.

| Команда | Операция | Длина поля данных | Доступ | Сохраняется во flash | Формат/примечание |
|---|---:|---:|---|---|---|
| `ManualDuty.Enable` — включить/выключить `ManualDuty` | `0x01` | 1 | чтение/запись | нет | `u8`: `0x00`=OFF, `0x01`=ON |
| `ManualDuty.DutyTargetPermille` — установить/прочитать `duty_target_permille` | `0x02` | 2 | чтение/запись | нет | `u16` (0…1000, 0.1%/LSB), little-endian |
| `ManualDuty.SlewRatePermillePerPeriod` — установить/прочитать `slew_rate_permille_per_period` | `0x03` | 2 | чтение/запись | нет | `u16` (0 ⇒ default 2‰/period; range 1…10‰/period), little-endian |
| `SelfTest.Run` — запуск встроенной самодиагностики | `0x10` | 2 | запись/команда принята | нет | `u8` маска тестов: `test_mask_lo`, `test_mask_hi` |
| `SelfTest.Status` — статус/результаты самодиагностики | `0x11` | 0 | чтение | нет | запрос без `Data`; ответ `Data` = 16 байт (см. 3.4.2) |

#### 3.4.1. `SelfTest.Run` (`Операция = 0x10`, запись)

Назначение: запуск встроенной самодиагностики для производства/сервиса. Команда **не должна** влиять на fast loop и не должна запускаться при активном ШИМ.

Условия допуска (gating):
- `state = IDLE`, PWM подтверждён как OFF.

Запрос:
- `Type = 0x03`
- `Data` = 2 байта:
  - `byte0`: `test_mask_lo` (битовая маска тестов)
  - `byte1`: `test_mask_hi`

Маска тестов (Draft 0.1):
- bit0: `ADC_NOISE_FLOOR` (I/U при PWM OFF)
- bit1: `VREFINT`
- bit2: `TEMPERATURE_PLAUSIBILITY` (обрыв/КЗ/диапазон)
- bit3: `SAFETY_PATH_BKIN_FLAG` (опционально, только если безопасно реализуемо)

Ответ:
- если успешно: `Type = 0x05`, `Data` = 2 байта `result_code` (u16, MSB first), где `0x0000` = STARTED
- если ошибка: `Type = 0x08`, `Data` = 2 байта `error_code` (u16, MSB first) (TBD)

#### 3.4.2. `SelfTest.Status` (`Операция = 0x11`, чтение)

Назначение: получить статус/результаты self-test, запущенного `SelfTest.Run`.

Запрос:
- `Type = 0x01`
- `Data` отсутствует

Ответ:
- `Type = 0x04`, `Data` = 16 байт:
  - `byte0`: `selftest_state` (u8): 0=IDLE, 1=RUNNING, 2=DONE
  - `byte1`: `selftest_result` (u8): 0=OK, 1=FAIL, 2=INCONCLUSIVE
  - `byte2..3`: `fail_mask` (u16, MSB first) — биты тестов, которые не прошли
  - `byte4..5`: `warn_mask` (u16, MSB first) — биты тестов с предупреждением (опционально)
  - `byte6..7`: `adc_noise_i_rms_lsb` (u16) — RMS шума канала тока в LSB (Draft 0.1)
  - `byte8..9`: `adc_noise_u_rms_lsb` (u16) — RMS шума канала напряжения в LSB (Draft 0.1)
  - `byte10..11`: `vrefint_mV` (u16) — оценка VDD по VREFINT (мВ) (Draft 0.1)
  - `byte12`: `temp1_status` (u8): 0=OK, 1=OPEN, 2=SHORT, 3=OUT_OF_RANGE (Draft 0.1)
  - `byte13`: `temp2_status` (u8): аналогично (Draft 0.1)
  - `byte14..15`: `reserved` (=0)

### 3.5. Узел `Цифровой осциллограф` (`Node = 0x06`)

| Команда | Операция | Длина поля данных | Доступ | Формат/примечание |
|---|---:|---:|---|---|
| Управление передачей данных в выбранном формате (наборе) | `0x01..0x0F` | 1 | чтение/запись | `u8`: `0x00`=OFF, `0x01`=ON |
| Набор / наборы данных | `0x11..0x1F` | 2..246 | сообщение | см. 3.6 (данные осциллографирования) |

### 3.6. Форматы данных (SmartAxis.USPF)

Таблица 1 — кодирование версий (2 байта):
- `byte0` (MSB): версия
- `byte1` (LSB): подверсия

Таблица 2 — версия ПО (4 байта, порядок SmartAxis.USPF):
- `byte0`: `REV_L` (ревизия LSB)
- `byte1`: `REV_H` (ревизия MSB)
- `byte2`: `MINOR`
- `byte3`: `MAJOR`

Таблица 3 — кодирование многобайтных чисел: `byte0=LSB … byteN=MSB` (little-endian).

Таблица 4 — данные осциллографирования:
- `byte0`: номер набора данных
- `byte1..N`: данные одного или нескольких наборов данных (байт 1 входит в данные)

Таблица 5 — результаты самодиагностики (`SelfTest.Status`):
- `byte0..15`: статус/результаты self-test (см. 3.4.2)
