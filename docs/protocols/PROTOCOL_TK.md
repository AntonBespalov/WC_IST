# Протокол обмена с ТК (Источник ↔ Технологический комплекс)

Этот документ — единственный источник правды по формату кадров, таймингам, кодам статуса и политике ошибок.
Любые изменения протокола требуют обновления этого документа и тестов.

---

## 1) Транспорт и общие параметры
- Шина: **CAN** (CAN-FD TBD)
- Скорость/настройки: TBD (фиксируется после выбора скорости и нагрузки шины)
- Период команд ТК: **1 мс**
- Модель обмена:
  - [x] периодическая телеметрия + команды (1 кГц)
  - [ ] запрос-ответ
  - [ ] смешанная
- Временные требования:
  - Максимальная задержка ответа источника на команду: TBD (обычно ≤ 1 периода, т.е. ≤ 1 мс)
  - Таймаут отсутствия команд:
    - soft-timeout: TBD (обычно 3–5 мс) → controlled stop / спад `I_ref_used`
    - hard-timeout: TBD (обычно 10–20 мс) → запрет сварки + FAULT (latch по политике)

Примечание (отладка):
- При стендовой отладке без реального ТК взаимодействие по CAN может имитироваться с ПК; CAN-кадры могут передаваться как полезная нагрузка внутри PCcom4 по USB-UART (см. `docs/protocols/PCCOM4.02.md`). Тайминги 1 мс в этом режиме не гарантируются.

---

## 2) Состояния устройства (state machine)
Перечень состояний и что разрешено в каждом:
- IDLE: PWM OFF, сварка запрещена; допускается приём конфигурации/диагностика.
- ARMED: готовность к старту (условия safety OK, latch отсутствует), PWM ещё OFF.
- WELD: активный цикл сварки, PWM ON (если enable=1 и safety разрешил).
- FAULT: latched-off (PWM OFF, драйверы запрещены), ждёт recovery по политике.
- (другие): ________

Условия переходов:
- IDLE → ARMED: ________
- ARMED → WELD: ________
- * → FAULT: ________
- FAULT → IDLE/ARMED: ________ (recovery политика)

---

## 3) Команда ТК → Источник (Command Frame)
### 3.1 Поля
- `seq` (счётчик последовательности): u8/u16 TBD (монотонно увеличивается)
- `mode` (режим): TBD (минимум: IDLE/ARMED/WELD или подрежимы процесса)
- `enable` (разрешение сварки): 0/1
- `I_ref_cmd` (уставка тока): единицы/масштаб TBD (рекомендуется фиксированный масштаб, напр. 0.1 А/LSB)
- `limits` (опционально): `I_max`, `dI/dt_max`, длительность импульса и др. (TBD)
- `fault_reset` (опционально): запрос на recovery (0/1) (TBD)
- `flags` (битовые флаги): TBD
- `crc` (если используется поверх CAN payload): TBD

### 3.2 Правила валидации
- Диапазоны уставок: TBD (в А, согласно физическим лимитам)
- Недопустимые комбинации флагов: TBD
- Политика `seq`:
  - что считается пропуском/повтором: повтор/скачок назад → кадр не применять
  - применять ли “старую” уставку: да, но только в пределах soft-timeout; при hard-timeout — stop/fault
- CRC/контроль целостности: реакция при ошибке TBD (минимум: счётчик + отказ применения кадра)

### 3.3 Семантика команд
- Что означает `enable=1`: разрешение на сварку при выполнении условий safety/gating (см. `docs/SAFETY.md`).
- Что означает `enable=0`: немедленный запрет сварки (PWM OFF; политика controlled stop vs hard-off — TBD).
- Команда `fault_reset`: запрос на снятие latch при выполнении условий recovery (см. `docs/SAFETY.md` и DN-001 в `docs/design-notes/DN-001_MFDC_Current_Control.md`).
- Команда “конфигурация/параметры”: ________ (если есть)

---

## 4) Ответ Источник → ТК (Status/Telemetry Frame)
### 4.1 Поля
- `seq_applied` (подтверждение seq): последнее применённое `seq`
- `state` (текущее состояние): IDLE/ARMED/WELD/FAULT
- `status_word` (битовое слово): ready/busy + режимы + сервисные флаги (TBD)
- `fault_word` (битовое слово): только HARD/SOFT faults (TBD)
- `limit_word` (битовое слово): только LIMIT причины (TBD)
- `fault_code` (опционально): enum последней причины (TBD)
- `I_ref_used` (уставка, реально поданная в контур): масштаб TBD
- `I_per` (средний ток за период PWM): масштаб TBD
- `U_per` (среднее U за период PWM): масштаб TBD
- `P_per` (средняя мощность за период, `mean(I*U)`): масштаб TBD (опционально)
- `temp`/прочее: TBD
- `counters`: счётчики ошибок ADC/COMMS/OVERRUN/log-overrun (TBD)

### 4.2 Правила формирования
- Частота ответа: **1 кГц** (синхронно с командным доменом)
- Что отправляется в FAULT: `state=FAULT`, актуальные fault/limit слова, диагностические счётчики, последняя причина.
- Стабильность значений: в статусе отдавать агрегированные по периоду значения (`I_per`, `U_per`), а RAW — только в отдельном режиме/логе (если нужен).

---

## 5) Политика ошибок и таймаутов
- Потеря команд:
  - soft-timeout → controlled stop (спад `I_ref_used`) + status flag
  - hard-timeout → запрет сварки + FAULT (по политике latch)
- Ошибка CRC/кадра: кадр не применять; счётчик + status flag
- Повторы/пропуски seq: повтор/скачок назад — не применять; пропуск — применять новый, но отражать в status/counters (TBD)
- Bus-off/ошибки линии: перевод в stop/fault по политике (TBD)
- Несовместимая конфигурация/режим: кадр не применять; status flag + fault_code (TBD)

---

## 6) Коды ошибок (fault_code) и битовые флаги (fault_flags)
Перечень (минимум):
- DRIVER_FAULT (SKYPER): HARD-FAULT, latch
- OC_FAST / HW_TRIP: HARD-FAULT, latch
- ADC_SPI_TIMEOUT / ADC_RANGE / ADC_STUCK: HARD-FAULT или SOFT-FAULT (по политике), минимум запрет сварки
- COMMS_TIMEOUT_HARD: HARD-FAULT или FAULT-state (по политике)
- COMMS_TIMEOUT_SOFT: controlled stop
- CMD_INVALID: отказ применения кадра + status flag (без сварки)
- CTRL_OVERRUN: минимум stop; часто latch (по политике safety)
- THERMOSTAT / OVERTEMP: stop/fault (по политике)

Опиши:
- какие из них критические (аппаратный shutdown)
- какие защёлкиваются (latch)
- как восстанавливаются

---

## 7) Тестовые сценарии протокола (обязательный минимум)
- Нормальный цикл 1 мс: ________
- Потеря команд N мс: ________
- CRC error burst: ________
- Повторы/пропуски seq: ________
- FAULT → отчёт → recovery: ________
