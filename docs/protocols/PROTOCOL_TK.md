# Протокол обмена с ТК (Источник ↔ Технологический комплекс)

Этот документ — единственный источник правды по формату кадров, таймингам, кодам статуса и политике ошибок.
Любые изменения протокола требуют обновления этого документа и тестов.

Примечание по терминам: далее «Источник» (контроллер) может также обозначаться как «ИСТ», «УСПФ» или «плата источника сварочного тока» (см. `docs/GLOSSARY.md`).

---

## 1) Транспорт и общие параметры
- Шина: **classic CAN** (CAN-FD TBD)
- CAN-ID: **11-bit standard** (Draft 0.1)
- Скорость/настройки: **500 kbit/s** (Draft 0.1, подтвердить по нагрузке/помехам)
- CAN-ID (Draft 0.1, чтобы убрать блокирующие TBD):
  - `CAN_ID_CMD = 0x100` (ТК → Источник, домен 1 мс)
  - `CAN_ID_STATUS = 0x101` (Источник → ТК, домен 1 мс)
- Период команд ТК: **1 мс**
- Модель обмена:
  - [x] периодическая телеметрия + команды (1 кГц)
  - [ ] запрос-ответ
  - [ ] смешанная
- Временные требования:
  - Максимальная задержка ответа источника на команду: **≤ 1 мс** (≤ 1 периода)
  - Таймаут отсутствия команд:
    - soft-timeout: **5 мс** (Draft 0.1) → controlled stop / спад `I_ref_used`
    - hard-timeout: **20 мс** (Draft 0.1) → запрет сварки + FAULT (latch по политике)

Примечание (отладка):
- При стендовой отладке без реального ТК взаимодействие по CAN может имитироваться с ПК; CAN-кадры могут передаваться как полезная нагрузка внутри PCcom4 по USB-UART (см. `docs/protocols/PCCOM4.02.md`). Тайминги 1 мс в этом режиме не гарантируются.

---

## 2) Состояния устройства (state machine)
Перечень состояний и что разрешено в каждом:
- IDLE: PWM OFF, сварка запрещена; допускается приём конфигурации/диагностика.
- ARMED: готовность к старту (условия safety OK, latch отсутствует), PWM ещё OFF.
- WELD: активный цикл сварки, PWM ON (если enable=1 и safety разрешил).
- FAULT: latched-off (PWM OFF, драйверы запрещены), ждёт recovery по политике.
- (другие): не используются в Draft 0.1.

Условия переходов:
- IDLE → ARMED: `enable=1` + валидная команда + отсутствует latch (см. `docs/SAFETY.md` / раздел 6).
- ARMED → WELD: start по технологической логике при `enable=1` и gating OK (переход в PWM ON внутри детерминизма PWM-домена).
- * → FAULT: любой HARD-FAULT / аппаратный trip / критичный fault по политике latch (см. `docs/SAFETY.md`).
- FAULT → IDLE: `fault_reset=1` (если предусмотрено) + условия recovery выполнены (см. `docs/SAFETY.md` / раздел 5).

---

## 3) Команда ТК → Источник (Command Frame)
### 3.1 Поля
- `seq` (счётчик последовательности): **u16** (Draft 0.1, монотонно увеличивается по модулю 65536)
- `mode` (запрошенный режим): **u8** (Draft 0.1)
  - `0` = IDLE
  - `1` = ARMED
  - `2` = WELD
- `enable` (разрешение сварки): 0/1
- `I_ref_cmd` (уставка тока): **u16**, масштаб **0.1 А/LSB** (Draft 0.1)
- `limits` (опционально): `I_max`, `dI/dt_max`, длительность импульса и др. (TBD)
- `fault_reset` (опционально): запрос на recovery (0/1) (Draft 0.1; применимо только в `state=FAULT` и только по политике `docs/SAFETY.md`)
- `flags` (битовые флаги): **u8**, Draft 0.1 = 0 (резерв)
- `crc` (если используется поверх CAN payload): Draft 0.1 = 0 (не используется; целостность обеспечивает CRC CAN)

### 3.2 Правила валидации
- Диапазоны уставок: `I_ref_cmd` в пределах `0 … I_ref_max` (TBD, фиксируется проектом); масштаб 0.1 А/LSB фиксирован.
- Недопустимые комбинации: `flags != 0` → кадр не применять (Draft 0.1).
- Политика `seq`:
  - что считается пропуском/повтором: повтор/скачок назад → кадр не применять
  - применять ли “старую” уставку: да, но только в пределах soft-timeout; при hard-timeout — stop/fault
- CRC/контроль целостности: для classic CAN отдельный payload CRC не используется; любые нарушения кадра отфильтрует CAN. `crc != 0` трактуется как `CMD_INVALID` (Draft 0.1).

### 3.3 Семантика команд
- Что означает `enable=1`: разрешение на сварку при выполнении условий safety/gating (см. `docs/SAFETY.md`).
- Что означает `enable=0`: запрет сварки; PWM OFF не позже чем через **2 периода PWM** (Draft 0.1). Controlled stop (спад `I_ref_used`) допускается, но всегда ограничен `soft-timeout/hard-timeout` политикой.
- Команда `fault_reset`: запрос на снятие latch при выполнении условий recovery (см. `docs/SAFETY.md` и DN-001 в `docs/design-notes/DN-001_MFDC_Current_Control.md`).
- Настройка коэффициентов регулятора тока (и связанных tuning-параметров) по CAN **запрещена**: команды записи/commit для таких параметров в CAN-протоколе отсутствуют. По CAN допускается только чтение (диагностика), если такие поля/кадры предусмотрены проектом. Запись/изменение tuning выполняется только через сервисное ПО по UART (PCcom), см. `docs/protocols/PCCOM4.02_PROJECT.md` / раздел 2.1.

---

## 4) Ответ Источник → ТК (Status/Telemetry Frame)
### 4.1 Поля
- `seq_applied` (подтверждение seq): последнее применённое `seq`
- `state` (текущее состояние): IDLE/ARMED/WELD/FAULT
- `status_word` (битовое слово): **u16** (Draft 0.1)
  - bit0 `READY`
  - bit1 `CMD_REJECTED`
  - bit2 `COMMS_SOFT_TIMEOUT_ACTIVE`
  - bit3 `COMMS_HARD_TIMEOUT_ACTIVE`
  - bit4 `BUS_OFF_ACTIVE`
  - bit5 `ADC_INVALID`
  - bit6 `CTRL_OVERRUN`
  - bit7 `MANUAL_DUTY_ACTIVE`
  - bit8 `SEQ_GAP_DETECTED`
- `fault_word` (битовое слово): **u16** (Draft 0.1, только faults)
  - bit0 `DRIVER_FAULT`
  - bit1 `HW_TRIP`
  - bit2 `ADC_FAULT`
  - bit3 `COMMS_TIMEOUT_HARD`
  - bit4 `CTRL_OVERRUN`
  - bit5 `OVERTEMP`
- `limit_word` (битовое слово): **u16** (Draft 0.1, только limits)
  - bit0 `LIMIT_DUTY`
  - bit1 `LIMIT_DI_DT`
  - bit2 `LIMIT_BY_VS` (volt-seconds)
  - bit3 `SATURATION_SUSPECTED`
- `fault_code` (опционально): enum последней причины (TBD; в Draft 0.1 достаточно `fault_word` + `status_word`)
- `I_ref_used` (уставка, реально поданная в контур): **u16**, масштаб **0.1 А/LSB** (Draft 0.1)
- `duty_used_permille` (опционально): фактически применённая скважность (0.1%/LSB, 0…1000); актуально для `ManualDuty` и диагностики duty-limit (см. раздел 8)
- `I_per` (средний ток за период PWM): **u16**, масштаб **0.1 А/LSB** (Draft 0.1)
- `U_per` (среднее U за период PWM): **u16**, масштаб **0.1 В/LSB** (Draft 0.1)
- `P_per` (средняя мощность за период, `mean(I*U)`): **u16**, масштаб **1 Вт/LSB** (Draft 0.1, опционально)
- `temp`/прочее: TBD
- `counters`: Draft 0.1 (минимум, u16 saturating): `cnt_cmd_reject`, `cnt_seq_gap`, `cnt_adc_fault`, `cnt_comms_fault`, `cnt_ctrl_overrun`, `cnt_log_overrun`

### 4.1.1 Пояснения к полям (семантика)

- `seq_applied`: “эхо” последней **принятой и применённой** команды (после валидации и правил `seq`). Если кадр команды отвергнут — `seq_applied` не меняется.
- `state`: фактическое состояние источника на момент формирования кадра статуса (для протокола Draft 0.1: IDLE/ARMED/WELD/FAULT).
- `status_word`: агрегированные признаки “качества” и контекста:
  - `READY`: источник готов принять команду/разрешить сварку при выполнении gating.
  - `CMD_REJECTED`: последняя команда отвергнута валидатором/правилами `seq` (см. также `cnt_cmd_reject`).
  - `COMMS_SOFT_TIMEOUT_ACTIVE`: нет валидных команд дольше `soft-timeout`, выполняется controlled stop (спад `I_ref_used`).
  - `COMMS_HARD_TIMEOUT_ACTIVE`: нет валидных команд дольше `hard-timeout`, сварка запрещена/переход в FAULT по политике.
  - `BUS_OFF_ACTIVE`: CAN в состоянии bus-off или запрещён по политике восстановления; сварка запрещена.
  - `ADC_INVALID`: измерения считаются невалидными (timeout/stuck/out-of-range по диагностике) и сварка запрещена по политике.
  - `CTRL_OVERRUN`: был overrun критического цикла (минимум stop; политика может быть latch).
  - `MANUAL_DUTY_ACTIVE`: активен сервисный режим `ManualDuty` (см. раздел 8).
  - `SEQ_GAP_DETECTED`: обнаружен пропуск `seq` (применён новый кадр, но с gap); отражается счётчиком `cnt_seq_gap`.
- `fault_word`: активные/защёлкнутые faults (класс C0/C1 по `docs/SAFETY.md`), которые запрещают сварку и требуют recovery по политике.
- `limit_word`: причины ограничения (LIMIT) без latch (напр. volt-seconds/di/dt/duty limit); важно для устойчивости и диагностики, но само по себе не является “аппаратной аварией”.
- `fault_code`: опциональный enum “последней причины” (Draft 0.1 оставляет как TBD; приоритет у `fault_word`/`status_word`).
- `I_ref_used`: уставка, реально поданная в контур (после gating/лимитов/спадов по timeout), **0.1 А/LSB**.
- `duty_used_permille`: фактически применённая скважность (после ограничителей/slew-rate), **0.1%/LSB**.
- `I_per`, `U_per`: агрегированные величины **за период PWM** (см. `docs/measurements/MEASUREMENT_ARCHITECTURE_RU.md`), **0.1 А/LSB** и **0.1 В/LSB**.
- `P_per`: средняя мощность за период как `mean(I*U)` (опционально), **1 Вт/LSB**.
- `temp`: резерв под температуры/питания и др. “медленные” каналы (TBD).
- `counters` (u16 saturating, монотонные):
  - `cnt_cmd_reject`: сколько кадров команды отвергнуто (валидация/формат/флаги/некорректные значения/правила `seq`).
  - `cnt_seq_gap`: сколько раз применён кадр с gap по `seq`.
  - `cnt_adc_fault`: сколько раз фиксировалась невалидность измерений (ADC timeout/stuck/out-of-range) или вход в соответствующую политику stop/fault.
  - `cnt_comms_fault`: сколько раз входили в состояния soft/hard-timeout и/или bus-off обработку (точная детализация может быть расширена).
  - `cnt_ctrl_overrun`: сколько раз был overrun критического цикла.
  - `cnt_log_overrun`: сколько раз логирование/очереди не успевали (дроп/переполнение).

### 4.2 Правила формирования
- Частота ответа: **1 кГц** (синхронно с командным доменом)
- Что отправляется в FAULT: `state=FAULT`, актуальные fault/limit слова, диагностические счётчики, последняя причина.
- Стабильность значений: в статусе отдавать агрегированные по периоду значения (`I_per`, `U_per`), а RAW — только в отдельном режиме/логе (если нужен).

---

## 5) Политика ошибок и таймаутов
- Потеря команд:
  - soft-timeout → controlled stop (спад `I_ref_used`) + status flag
  - hard-timeout → запрет сварки + FAULT (по политике latch)
- Сервисный режим `ManualDuty` (если включён): отсутствие сервис-команд/keepalive по интерфейсу активации > **20 мс** ⇒ запрет сварки + переход в safe state (см. раздел 8 и `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`)
- Ошибка CRC/кадра: кадр не применять; счётчик + status flag
- Повторы/пропуски seq: повтор/скачок назад — не применять; пропуск — применить новый, установить `SEQ_GAP_DETECTED` и увеличить `cnt_seq_gap`
- Bus-off/ошибки линии: **без ABOM** (Draft 0.1).
  - При событии Bus-Off: источник прекращает передачу, запрещает сварку (gating) и формирует `BUS_OFF_ACTIVE`.
  - Восстановление: программная переинициализация CAN не чаще, чем раз в `T_busoff_backoff_ms` (Draft 0.1: 250 мс, диапазон 100–500 мс).
  - При повторяющихся Bus-Off: эскалация в fault по политике (TBD).
- Несовместимая конфигурация/режим: кадр не применять; status flag + fault_code (TBD)

---

## 6) Коды ошибок (fault_code) и битовые флаги (fault_flags)
Перечень (минимум):
- DRIVER_FAULT (SKYPER): HARD-FAULT, latch
- OC_FAST / HW_TRIP: HARD-FAULT, latch
- ADC_SPI_TIMEOUT / ADC_RANGE / ADC_STUCK: HARD-FAULT или SOFT-FAULT (по политике), минимум запрет сварки
- COMMS_TIMEOUT_HARD: HARD-FAULT или FAULT-state (по политике)
- COMMS_TIMEOUT_SOFT: controlled stop
- CMD_INVALID: отказ применения кадра + status flag (без сварки)
- CTRL_OVERRUN: минимум stop; часто latch (по политике safety)
- THERMOSTAT / OVERTEMP: stop/fault (по политике)

Опиши:
- какие из них критические (аппаратный shutdown)
- какие защёлкиваются (latch)
- как восстанавливаются

---

## 7) Тестовые сценарии протокола (обязательный минимум)
- Нормальный цикл 1 мс: последовательные `seq`, `seq_applied` догоняет, статус стабилен.
- Потеря команд: soft-timeout (5 мс) → controlled stop; hard-timeout (20 мс) → запрет сварки + FAULT (по политике).
- Burst невалидных кадров/format errors: серия (бурст) подряд идущих командных кадров, которые отвергаются валидатором/правилами протокола (например: неверный CAN-ID, недопустимые `flags != 0`, уставка вне допустимого диапазона, нарушение правил `seq` (повтор/скачок назад), некорректные зарезервированные поля). Ожидаемое поведение: кадры не применяются, растёт `cnt_cmd_reject`, сварка не разрешается/гасится по политике.
- Повторы/пропуски `seq`: повтор/скачок назад — reject; пропуск — применить новый и отразить в counters/status.
- Bus-off: запрет сварки + молчание; recovery только после backoff; отсутствие “спама”.
- FAULT → отчёт → recovery: `state=FAULT`, потом `fault_reset=1` при выполнении условий → возврат в IDLE.

---

## 8) Сервисные команды (опционально): режим `ManualDuty`

Назначение: стендовая отладка ШИМ/силовой части через ручную скважность при сохранении safety-инвариантов (см. `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`).

### 8.1. Транспорт

Рекомендуется выделить **отдельные CAN-ID** под сервис (не пересекать с 1 мс доменом ТК):

- `CAN_ID_SVC_CMD`: сервис-команды.
- `CAN_ID_SVC_STATUS`: сервисная телеметрия (опционально).

CAN-ID и формат (standard/extended) фиксируются проектом.
Draft 0.1 (чтобы убрать блокирующие TBD):
- `CAN_ID_SVC_CMD = 0x110` (classic CAN)
- `CAN_ID_SVC_STATUS = 0x111` (classic CAN, опционально)

### 8.2. Правила допуска (gating)

Источник **SHALL** принимать сервисные команды `ManualDuty` только при выполнении всех условий:
- `state = IDLE` (сварка запрещена, PWM OFF);
- активных latch/fault, запрещающих запуск, нет (по политике safe state);
- команда валидна по формату и диапазонам.

При любом fault, приводящем к safe state, источник **SHALL** немедленно отключить ШИМ и выйти из `ManualDuty` (по политике аварий).

### 8.3. Формат `SVC_CMD` для `ManualDuty` (8 байт, classic CAN)

`SVC_CMD` (Tx: сервис → источник), payload 8 байт:

- `byte0`: `svc_seq` (u8) — счётчик сервиса (монотонно увеличивается).
- `byte1`: `svc_op` (u8):
  - `0x00` — `KEEPALIVE`
  - `0x01` — `ENABLE`
  - `0x02` — `DISABLE`
  - `0x03` — `SET_DUTY`
- `byte2..3`: `duty_target_permille` (u16, MSB first), 0…1000 (0.1%/LSB). Для `ManualDuty` диапазон применения: **100…500** (10–50%).
- `byte4..5`: `slew_rate_permille_per_period` (u16, MSB first), ограничитель изменения скважности “на период ШИМ” в единицах 0.1%/период:
  - 0 ⇒ использовать default **2‰/период**
  - допустимый диапазон: **1…10‰/период**
  - вне диапазона ⇒ команда не применяется (ошибка валидации)
- `byte6`: `flags` (u8): бит0 `apply_now=0` (зарезервировано, в `ManualDuty` применяется строго по периоду через preload); остальные биты — резерв.
- `byte7`: `reserved` (=0).

### 8.4. Семантика “связи” и таймаут 20 мс

В режиме `ManualDuty` источник **SHALL** считать “связью” приход любого **валидного** `SVC_CMD` (любой `svc_op`, включая `KEEPALIVE`).

Если в течение **20 мс** не пришло ни одного валидного `SVC_CMD` по интерфейсу, через который режим `ManualDuty` был включён, источник **SHALL** перейти в safe state и отключить `ManualDuty`.

### 8.5. Телеметрия (минимум)

Источник **SHOULD** отражать активность `ManualDuty` в стандартной телеметрии:
- `status_word`: бит `MANUAL_DUTY_ACTIVE` (Draft 0.1: bit7).
- (опционально) `duty_used_permille` (u16, 0.1%/LSB) — фактически применённая скважность.

Если используется отдельный `CAN_ID_SVC_STATUS`, его формат фиксируется проектом (TBD), но **минимум** должен включать: признак активности `ManualDuty`, `duty_used_permille`, возраст сервиса (мс).
