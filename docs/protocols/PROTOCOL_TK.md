# Протокол обмена с ТК (Источник ↔ Технологический комплекс)

Этот документ — единственный источник правды по формату кадров, таймингам, кодам статуса и политике ошибок.
Любые изменения протокола требуют обновления этого документа и тестов.

---

## 1) Транспорт и общие параметры
- Шина: **CAN** (CAN-FD TBD)
- Скорость/настройки: TBD (фиксируется после выбора скорости и нагрузки шины)
- Период команд ТК: **1 мс**
- Модель обмена:
  - [x] периодическая телеметрия + команды (1 кГц)
  - [ ] запрос-ответ
  - [ ] смешанная
- Временные требования:
  - Максимальная задержка ответа источника на команду: TBD (обычно ≤ 1 периода, т.е. ≤ 1 мс)
  - Таймаут отсутствия команд:
    - soft-timeout: TBD (обычно 3–5 мс) → controlled stop / спад `I_ref_used`
    - hard-timeout: TBD (обычно 10–20 мс) → запрет сварки + FAULT (latch по политике)

Примечание (отладка):
- При стендовой отладке без реального ТК взаимодействие по CAN может имитироваться с ПК; CAN-кадры могут передаваться как полезная нагрузка внутри PCcom4 по USB-UART (см. `docs/protocols/PCCOM4.02.md`). Тайминги 1 мс в этом режиме не гарантируются.

---

## 2) Состояния устройства (state machine)
Перечень состояний и что разрешено в каждом:
- IDLE: PWM OFF, сварка запрещена; допускается приём конфигурации/диагностика.
- ARMED: готовность к старту (условия safety OK, latch отсутствует), PWM ещё OFF.
- WELD: активный цикл сварки, PWM ON (если enable=1 и safety разрешил).
- FAULT: latched-off (PWM OFF, драйверы запрещены), ждёт recovery по политике.
- (другие): ________

Условия переходов:
- IDLE → ARMED: ________
- ARMED → WELD: ________
- * → FAULT: ________
- FAULT → IDLE/ARMED: ________ (recovery политика)

---

## 3) Команда ТК → Источник (Command Frame)
### 3.1 Поля
- `seq` (счётчик последовательности): u8/u16 TBD (монотонно увеличивается)
- `mode` (режим): TBD (минимум: IDLE/ARMED/WELD или подрежимы процесса)
- `enable` (разрешение сварки): 0/1
- `I_ref_cmd` (уставка тока): единицы/масштаб TBD (рекомендуется фиксированный масштаб, напр. 0.1 А/LSB)
- `limits` (опционально): `I_max`, `dI/dt_max`, длительность импульса и др. (TBD)
- `fault_reset` (опционально): запрос на recovery (0/1) (TBD)
- `flags` (битовые флаги): TBD
- `crc` (если используется поверх CAN payload): TBD

### 3.2 Правила валидации
- Диапазоны уставок: TBD (в А, согласно физическим лимитам)
- Недопустимые комбинации флагов: TBD
- Политика `seq`:
  - что считается пропуском/повтором: повтор/скачок назад → кадр не применять
  - применять ли “старую” уставку: да, но только в пределах soft-timeout; при hard-timeout — stop/fault
- CRC/контроль целостности: реакция при ошибке TBD (минимум: счётчик + отказ применения кадра)

### 3.3 Семантика команд
- Что означает `enable=1`: разрешение на сварку при выполнении условий safety/gating (см. `docs/SAFETY.md`).
- Что означает `enable=0`: немедленный запрет сварки (PWM OFF; политика controlled stop vs hard-off — TBD).
- Команда `fault_reset`: запрос на снятие latch при выполнении условий recovery (см. `docs/SAFETY.md` и DN-001 в `docs/design-notes/DN-001_MFDC_Current_Control.md`).
- Команда “конфигурация/параметры”: ________ (если есть)

---

## 4) Ответ Источник → ТК (Status/Telemetry Frame)
### 4.1 Поля
- `seq_applied` (подтверждение seq): последнее применённое `seq`
- `state` (текущее состояние): IDLE/ARMED/WELD/FAULT
- `status_word` (битовое слово): ready/busy + режимы + сервисные флаги (TBD)
- `fault_word` (битовое слово): только HARD/SOFT faults (TBD)
- `limit_word` (битовое слово): только LIMIT причины (TBD)
- `fault_code` (опционально): enum последней причины (TBD)
- `I_ref_used` (уставка, реально поданная в контур): масштаб TBD
- `duty_used_permille` (опционально): фактически применённая скважность (0.1%/LSB, 0…1000); актуально для `ManualDuty` и диагностики duty-limit (см. раздел 8)
- `I_per` (средний ток за период PWM): масштаб TBD
- `U_per` (среднее U за период PWM): масштаб TBD
- `P_per` (средняя мощность за период, `mean(I*U)`): масштаб TBD (опционально)
- `temp`/прочее: TBD
- `counters`: счётчики ошибок ADC/COMMS/OVERRUN/log-overrun (TBD)

### 4.2 Правила формирования
- Частота ответа: **1 кГц** (синхронно с командным доменом)
- Что отправляется в FAULT: `state=FAULT`, актуальные fault/limit слова, диагностические счётчики, последняя причина.
- Стабильность значений: в статусе отдавать агрегированные по периоду значения (`I_per`, `U_per`), а RAW — только в отдельном режиме/логе (если нужен).

---

## 5) Политика ошибок и таймаутов
- Потеря команд:
  - soft-timeout → controlled stop (спад `I_ref_used`) + status flag
  - hard-timeout → запрет сварки + FAULT (по политике latch)
- Сервисный режим `ManualDuty` (если включён): отсутствие сервис-команд/keepalive по интерфейсу активации > **20 мс** ⇒ запрет сварки + переход в safe state (см. раздел 8 и `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`)
- Ошибка CRC/кадра: кадр не применять; счётчик + status flag
- Повторы/пропуски seq: повтор/скачок назад — не применять; пропуск — применять новый, но отражать в status/counters (TBD)
- Bus-off/ошибки линии: перевод в stop/fault по политике (TBD)
- Несовместимая конфигурация/режим: кадр не применять; status flag + fault_code (TBD)

---

## 6) Коды ошибок (fault_code) и битовые флаги (fault_flags)
Перечень (минимум):
- DRIVER_FAULT (SKYPER): HARD-FAULT, latch
- OC_FAST / HW_TRIP: HARD-FAULT, latch
- ADC_SPI_TIMEOUT / ADC_RANGE / ADC_STUCK: HARD-FAULT или SOFT-FAULT (по политике), минимум запрет сварки
- COMMS_TIMEOUT_HARD: HARD-FAULT или FAULT-state (по политике)
- COMMS_TIMEOUT_SOFT: controlled stop
- CMD_INVALID: отказ применения кадра + status flag (без сварки)
- CTRL_OVERRUN: минимум stop; часто latch (по политике safety)
- THERMOSTAT / OVERTEMP: stop/fault (по политике)

Опиши:
- какие из них критические (аппаратный shutdown)
- какие защёлкиваются (latch)
- как восстанавливаются

---

## 7) Тестовые сценарии протокола (обязательный минимум)
- Нормальный цикл 1 мс: ________
- Потеря команд N мс: ________
- CRC error burst: ________
- Повторы/пропуски seq: ________
- FAULT → отчёт → recovery: ________

---

## 8) Сервисные команды (опционально): режим `ManualDuty`

Назначение: стендовая отладка ШИМ/силовой части через ручную скважность при сохранении safety-инвариантов (см. `docs/design-notes/DN-002_MFDC_ManualDuty_Service_Mode.md`).

### 8.1. Транспорт

Рекомендуется выделить **отдельные CAN-ID** под сервис (не пересекать с 1 мс доменом ТК):

- `CAN_ID_SVC_CMD`: сервис-команды.
- `CAN_ID_SVC_STATUS`: сервисная телеметрия (опционально).

CAN-ID и формат (standard/extended) фиксируются проектом (TBD).

### 8.2. Правила допуска (gating)

Источник **SHALL** принимать сервисные команды `ManualDuty` только при выполнении всех условий:
- `state = IDLE` (сварка запрещена, PWM OFF);
- активных latch/fault, запрещающих запуск, нет (по политике safe state);
- команда валидна по формату и диапазонам.

При любом fault, приводящем к safe state, источник **SHALL** немедленно отключить ШИМ и выйти из `ManualDuty` (по политике аварий).

### 8.3. Формат `SVC_CMD` для `ManualDuty` (8 байт, classic CAN)

`SVC_CMD` (Tx: сервис → источник), payload 8 байт:

- `byte0`: `svc_seq` (u8) — счётчик сервиса (монотонно увеличивается).
- `byte1`: `svc_op` (u8):
  - `0x00` — `KEEPALIVE`
  - `0x01` — `ENABLE`
  - `0x02` — `DISABLE`
  - `0x03` — `SET_DUTY`
- `byte2..3`: `duty_target_permille` (u16, MSB first), 0…1000 (0.1%/LSB). Для `ManualDuty` диапазон применения: **100…500** (10–50%).
- `byte4..5`: `slew_rate_permille_per_period` (u16, MSB first), ограничитель изменения скважности “на период ШИМ” в единицах 0.1%/период:
  - 0 ⇒ использовать default **2‰/период**
  - допустимый диапазон: **1…10‰/период**
  - вне диапазона ⇒ команда не применяется (ошибка валидации)
- `byte6`: `flags` (u8): бит0 `apply_now=0` (зарезервировано, в `ManualDuty` применяется строго по периоду через preload); остальные биты — резерв.
- `byte7`: `reserved` (=0).

### 8.4. Семантика “связи” и таймаут 20 мс

В режиме `ManualDuty` источник **SHALL** считать “связью” приход любого **валидного** `SVC_CMD` (любой `svc_op`, включая `KEEPALIVE`).

Если в течение **20 мс** не пришло ни одного валидного `SVC_CMD` по интерфейсу, через который режим `ManualDuty` был включён, источник **SHALL** перейти в safe state и отключить `ManualDuty`.

### 8.5. Телеметрия (минимум)

Источник **SHOULD** отражать активность `ManualDuty` в стандартной телеметрии:
- `status_word`: бит `MANUAL_DUTY_ACTIVE` (позиция TBD).
- (опционально) `duty_used_permille` (u16, 0.1%/LSB) — фактически применённая скважность.

Если используется отдельный `CAN_ID_SVC_STATUS`, его формат фиксируется проектом (TBD), но **минимум** должен включать: признак активности `ManualDuty`, `duty_used_permille`, возраст сервиса (мс).
