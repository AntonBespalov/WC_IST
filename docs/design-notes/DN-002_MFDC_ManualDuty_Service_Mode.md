# DN-002 — Сервисный режим ручной скважности ШИМ (ManualDuty)

**Документ:** DN-002  
**Название:** Сервисный режим ручной скважности ШИМ (ManualDuty)  
**Версия:** 1.1  
**Статус:** Draft Design Note  
**Дата:** 2026-02-01  

---

## 1. Назначение документа

Этот Design Note фиксирует требования к **сервисному режиму** управления ШИМ через ручную скважность (`ManualDuty`) для отладки силовой части/ШИМ и диагностики на стенде.

Режим `ManualDuty` не предназначен для штатной работы и не должен ослаблять политику безопасного состояния и аварий (см. `docs/PROJECT_CONTEXT.md` / разделы 4 и 6).

---

## 2. Контекст исполнения и временной домен

- Временной домен: **PWM-контур**.
- Контекст исполнения: быстрый контур (детерминированный, без RTOS).
- Применение duty: **строго синхронно с периодом ШИМ** через preload/shadow регистры (как в штатном режиме), без “асинхронной” записи в CCR.
- `ManualDuty` является **источником задания duty**; регулятор тока при этом выключен, но вся safety-обвязка остаётся активной.

---

## 3. Требования (SHALL / SHALL NOT / SHOULD)

### 3.1. Вход/выход режима

- Источник **SHALL** входить в `ManualDuty` только по сервисной команде и только из безопасного состояния/IDLE (см. `docs/PROJECT_CONTEXT.md` / раздел 4).
- Источник **SHALL** выходить из `ManualDuty` по явной сервисной команде “disable”.
- Источник **SHALL** переходить в safe state при потере “связи” с сервисом: если в течение **20 мс** не получено keepalive/команды по тому же интерфейсу, через который режим был включён.
- Источник **SHALL NOT** автоматически возобновлять ШИМ после критического fault (latched-off до явного recovery), независимо от `ManualDuty` (см. `docs/PROJECT_CONTEXT.md` / раздел 4 и 6).

### 3.2. Ограничения скважности и динамики

- `duty_used` **SHALL** быть ограничен диапазоном **10–50%**.
- Изменение `duty_used` **SHALL** быть ограничено настраиваемым slew-rate `slew_rate_permille_per_period` (ограничитель скорости изменения) в единицах **0.1% на период ШИМ**.
  - Значение по умолчанию: **2‰/период** (0.2%/период).
  - Допустимый диапазон: **1…10‰/период** (0.1…1.0%/период). Значения вне диапазона должны отвергаться валидатором команды.
  - Значение 0 трактуется как “использовать значение по умолчанию”.
- Источник **SHOULD** запрещать значения, приводящие к “пограничным” режимам (например, 0%/100% и иные явно опасные значения), даже если они формально лежат в диапазоне.

### 3.3. Применение duty в TIM1
 
- Новое значение duty **SHALL** применяться строго на границе периода (момент update), используя preload (shadow) — чтобы обеспечить одинаковый детерминизм со штатным режимом.
- Источник **SHALL** обеспечивать наблюдаемость: фиксировать момент применения duty через `DBG0/DBG1` (настраиваемый debug-пин, событие `PWM_APPLY`), а для аварий — `BKIN_RAW` и/или вход в софт-обработчик (см. `docs/PROJECT_CONTEXT.md` / раздел 7).

### 3.4. Политика аварий

- Все существующие fault-gates/interlocks **SHALL** оставаться активными.
- Аппаратные защиты драйверов (DESAT/OCP/driver fault) **SHALL NOT** маскироваться режимом `ManualDuty` и имеют приоритет над сервисной командой/оператором.
- Критические аварии **SHALL** отключать силовую часть аппаратно через TIM1 BKIN/BKIN2 (без зависимости от RTOS/тасок), как в штатном режиме (см. `docs/PROJECT_CONTEXT.md` / раздел 2 и 4).

---

## 4. Риски и edge cases
 
- Ошибка синхронизации (CCR обновляется не на update event) → глитчи на ШИМ; выявляется осциллографом по `DBG0/DBG1` (событие `PWM_APPLY`) vs `PWM_OUT`.
- Потеря связи/зависание сервиса → неконтролируемое удержание ШИМ; предотвращается таймаутом 20 мс и переходом в safe state.
- Ошибка измерений (ADC invalid/stuck) при активном ШИМ → должна приводить к безопасному поведению по политике аварий.

---

## 5. План проверок (Proof / Done)

### 5.1. On-target измерения (обязательно)
 
- Осциллограф: `PWM_OUT` + `DBG0/DBG1` (событие `PWM_APPLY`) — подтверждение применения duty строго на границе периода.
- Лог/trace: timestamp, `duty_used`, признак режима `ManualDuty`, fault bitmap — подтверждение корректного входа/выхода и реакции на таймаут.

### 5.2. Fault-injection (минимум, подтверждённый набор)

1) `BKIN` trip.  
2) Driver fault (DESAT/OC/driver).  
3) Watchdog/reset сценарий (безопасное поведение, без авто-возобновления энергии).  
4) Service timeout > 20 мс по интерфейсу активации.  
5) `ADC invalid/stuck`.  
6) Если интерфейс — CAN/ТК: CAN timeout/bus-off в режиме `ManualDuty`.

---

## 6. Rollback

- Отключить `ManualDuty` сервисной командой “disable” и убедиться, что источник вернулся в safe state/IDLE.
- В случае регрессии — отключить доступность команды `ManualDuty` (feature flag/compile-time) без изменения аппаратного shutdown-пути.

