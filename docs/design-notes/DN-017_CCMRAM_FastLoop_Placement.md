# DN-017_CCMRAM_FastLoop_Placement — CCM RAM для fast loop (draft)

Статус: deferred (draft)  
Триггер реализации: только при измеренной корреляции jitter/latency fast loop с нагрузкой (лог/коммуникации/прочее) на железе.  
Дата: 2026-02-17  
Владелец: TBD  
Связано: TBD  

---

## 1) Context / Problem
- Fast loop работает в PWM-домене и требует детерминированных таймингов (см. `docs/ARCHITECTURE.md`, `docs/ENGINEERING_CONTRACT.md`).
- В текущей линковке CCM не используется, вся память свалена в общий RAM.
- Цель — снизить джиттер и латентность fast loop через размещение критичных данных/стека в CCMSRAM.
Примечание: CCM полезен только для CPU-only данных. Эффект ожидается при наличии contention/латентностных “шипов” в SRAM во время реальной нагрузки; без стендовых измерений реализация не обязательна.

## 2) Goal / Non-goals
### Goal
- Подготовить инфраструктуру (линкер + startup init/zero) и обеспечить возможность точечного переноса критичных CPU-only структур fast loop в CCM; применять перенос только при наличии измеримого выигрыша по L3 метрикам на железе.

### Non-goals
- Не менять алгоритм регулятора и его параметры.
- Не менять safety-политику (BKIN/DRV_EN/латентность отключения).
- Не переносить DMA-буферы в CCM.
- Не менять протоколы/логирование.

## 3) Decision (что делаем)
- Добавить регион CCMSRAM и секции для CCM в линкер: `.ccm_bss` (BSS в CCM, требуется обнуление) и опционально `.ccm_data` (инициализируемые данные, если понадобятся).
- Startup обязан обслуживать CCM-секции: обнулять диапазон `.ccm_bss`, а при наличии `.ccm_data` — копировать init-образ из Flash в CCM.
- NOLOAD допускается только для секций, которые намеренно не инициализируются и полностью заполняются кодом до использования. Для `control_ctx_t` и любых BSS-структур fast loop NOLOAD не использовать.
- Размещать `control_ctx_t` и критичные fast loop структуры в `.ccmram`.
- Сохранить DMA-буферы и capture-буфер в SRAM1/2.
- Явный запрет: любые буферы/области памяти, адрес которых используется DMA (ADC/UART/SPI), не могут находиться в CCM.
- Решение по MSP: использовать CCM при условии отсутствия конфликтов с `sysmem.c`/heap.

## 4) Rationale (почему так)
- CCMSRAM даёт меньшую задержку доступа и снижает конкуренцию за SRAM1.
- CCM снижает вариативность доступа к “горячим” CPU-only данным и уменьшает влияние фоновой DMA-активности, но эффект проявится только при наличии contention, подтверждаемого измерениями.
- CCM недоступен для DMA, поэтому ограничиваемся CPU-only данными.

## 5) Interfaces / Data / Timing impact
- Внешние интерфейсы не меняются.
- Появляется новая секция памяти `.ccm_bss`.
- Ожидаем снижение или отсутствие ухудшения jitter/latency fast loop.

## 6) Risks / Edge cases
- Переполнение CCM или MSP-стека → HardFault.
- Ошибочное размещение DMA-буфера в CCM → ошибки DMA/данных.
- Пропуск инициализации данных в CCM → нестабильность.
- Если startup не обнуляет `.ccm_bss` / не копирует `.ccm_data`, возможны “плавающие” ошибки из-за мусора в структуре управления.
- Переезд MSP в CCM требует контроля глубины стека прерываний; без guard/high-water возможны трудноуловимые HardFault.

## 7) Test plan / Proof / Rollback
### Test plan / Proof
- Unit/host: map/nm проверка адресов секций и символов.
- SIL: не требуется.
- On-target измерения (GPIO/осциллограф/trace): jitter `control_tick`, длительность `control_fast_step`, `ADC_START→ADC_READY`, `PWM_APPLY` фаза.
- On-target (sanity): тест DMA на буферах в SRAM и запрет DMA на CCM (негативный тест/проверка адресов).
- On-target (startup): проверка корректной инициализации CCM: BSS в CCM = нули на старте; DATA в CCM (если есть) = ожидаемые константные значения.
- HIL/bench: подтверждение `BKIN_RAW→PWM_OUT safe` без ухудшений.
- Критерий принятия: перенос в CCM выполняется только если на железе выявлены измеримые шипы jitter/latency и показано улучшение worst-case после переноса (при той же нагрузке).

### Rollback
- Вернуть линковку к RAM-only и убрать `.ccmram` атрибуты.
- Проверить восстановление baseline jitter/latency.

## 8) Status / Implementation links
- Status: deferred (draft)
- Links: TBD

Решение отложено до первых стендовых L3 измерений. Реализация выполняется только при явной необходимости (регресс от нагрузки/логов или недостаточный запас по таймингу fast loop).
