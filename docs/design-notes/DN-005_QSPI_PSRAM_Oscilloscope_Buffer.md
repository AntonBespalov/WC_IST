Статус: draft  
Дата: 2026-02-10  
Владелец: <name>  
Связано:  
- `docs/PROJECT_CONTEXT.md`  
- `docs/CONTEXT_SNAPSHOT.md`  
- `docs/ARCHITECTURE.md`  
- `docs/TEST_PLAN.md`  
- `docs/protocols/PCCOM4.02.md`  
- `docs/protocols/PCCOM4.02_PROJECT.md` (узел `0x06`)  
- `docs/safety/Unified_Safety_by_Design_MFDC.md`  

---

## 1) Context / Problem
- Требуется увеличить глубину буферизации данных сервисного “цифрового осциллографа”,
  передаваемых по USB-UART (PCcom4), чтобы выдерживать бурсты/провалы пропускной способности
  и дать возможность pre/post-trigger.
- Внутренняя SRAM ограничена и должна оставаться в первую очередь ресурсом для детерминизма (fast loop) и безопасного выполнения.
- В проекте уже есть сервисный канал “плата ↔ ПК” по USB-UART (FT232H) и профиль PCcom4
  с узлом `Цифровой осциллограф` (`Node=0x06`) — формат данных внутри наборов требует фиксации.
- По умолчанию считаем путь RT-чувствительным: обмен/буферизация **не должны** ухудшать
  детерминизм fast loop (см. `docs/PROJECT_CONTEXT.md` / разделы про двухконтурную архитектуру
  и наблюдаемость).

## 2) Goal / Non-goals
### Goal
- Использовать микросхему APS6404L-3SQR-SN как внешнюю **PSRAM** по QSPI/QUADSPI для расширения буфера “цифрового осциллографа”.
- Обеспечить архитектурное разделение: fast loop не блокируется и не зависит от QSPI/USB-UART
  (данные попадают в SRAM-буфер, дальнейшая запись/выдача — в slow loop).
- Зафиксировать в документации: назначение, границы применения, интерфейсные ожидания, и план разработки/верификации.

### Non-goals
- Не делать из PSRAM “память для прошивки/кода” (XIP) и не переносить критические структуры fast loop во внешнюю память.
- Не решать задачу “пережить power-loss и сохранить логи”: PSRAM — память энергозависимая; долговременное хранение вне цели этого изменения.
- Не менять политику safe state / аппаратный shutdown-path (TIM1 BKIN/BKIN2 и др.) и не вводить авто-рестарт после критических fault.

## 3) Decision (что делаем)
- Добавляем внешнюю память APS6404L-3SQR-SN (PSRAM, QSPI) как **вторичный буфер** для данных осциллографа (service/diagnostics path).
- Принципиальная архитектура тракта данных:
  - producer(ы) формируют записи осциллографа и складывают их в SRAM кольцевой буфер фиксированного формата/размера (без динамической памяти);
  - low-priority task (slow loop) асинхронно “сбрасывает” данные из SRAM в PSRAM (и/или напрямую в USB-UART), управляя watermarks и backpressure;
  - чтение из PSRAM и выдача в PC выполняется только в контексте slow loop.
- Работа с QSPI:
  - QSPI операции выполняются **только из task-контекста** (по ответам gate-вопросов), без обращений из ISR fast loop;
  - выбор режима доступа (indirect/DMA vs memory-mapped) фиксируется в реализации,
    но по умолчанию предпочтение режиму, который позволяет ограничить длительность транзакций
    и избежать “неожиданных” stall на шине.
- Протокол PCcom4:
  - опираемся на `docs/protocols/PCCOM4.02_PROJECT.md` / узел `0x06` (управление streaming и сообщения `Scope.Data`);
  - формат “набора данных” и правила фрагментации/нумерации/таймстемпов фиксируются
    как часть реализации (может потребоваться расширение проектного профиля PCcom4).
- Политика отказов:
  - отказ/неисправность PSRAM или QSPI не должен влиять на сварку: функция осциллографа
    деградирует (выключается/сбрасывается/сигнализирует ошибку), fast loop продолжает работать
    согласно safety-политике.

## 4) Rationale (почему так)
- PSRAM по QSPI даёт существенно большую ёмкость буфера, чем “разумный” статический резерв SRAM,
  и позволяет переживать временные провалы пропускной способности USB-UART.
- Разделение на SRAM (детерминизм/быстрый producer) и PSRAM (ёмкость/slow loop) минимизирует
  риск влияния на fast loop и соответствует принципу “не блокировать fast loop сервисом”.
- Альтернативы:
  - только SRAM: проще, но ограничивает глубину записи/бурсты и увеличивает риск переполнения;
  - FRAM по QSPI: неэнергозависима и удобна для record/replay, но обычно существенно меньше
    по объёму/другие компромиссы; для задачи буферизации осциллографа ключевой параметр —
    ёмкость и скорость;
  - только “стрим сразу на ПК”: в реальности нестабильно при бурстах/ошибках связи; нужна защита от backpressure.

## 5) Interfaces / Data / Timing impact
- **PCcom4 / USB-UART**:
  - узел `0x06` уже зарезервирован под осциллограф; требуется уточнить формат payload “набора
    данных” (ширина слова, порядок полей, признаки, кратность, packing) и добавить/зафиксировать
    необходимые метаданные (seq/timebase/overflow flags).
- **Данные/структуры**:
  - фиксируется формат записи “осциллографа” (минимум: `seq`, `timestamp`, источники каналов/маска, значения каналов, флаги качества/overflow).
  - вводятся счётчики/статусы: переполнение SRAM, переполнение PSRAM, ошибки QSPI, уровень заполнения буферов (для диагностики через PCcom4).
- **Тайминги**:
  - QSPI/USB-UART активность не должна ухудшать worst-case длительность шага управления
    и джиттер запуска fast loop; это должно быть подтверждено измерениями
    (см. `docs/TEST_PLAN.md` / проверки по PCcom4 и jitter).
  - ограничения на chunk size/частоту операций сброса должны быть выбраны так, чтобы не
    “захватить” CPU на длительное время в slow loop и не нарушить обработку CAN/диагностики.

## 6) Risks / Edge cases
- PSRAM/QSPI не инициализируется, деградирует, даёт битые данные → функция осциллографа должна отключаться с диагностикой; сварка не зависит от этого.
- Переполнение буферов при бурсте данных/медленном канале → требуется политика:
  drop oldest/newest, останов stream, выставление флага overflow, сохранение последних N мс
  (pre-trigger) и/или post-trigger.
- Скрытая зависимость fast loop от сервисного тракта (общие блокировки, приоритеты,
  отключения прерываний, длительные критические секции) → основной риск; ловим измерениями
  jitter/latency и аудитом критических секций.
- Ошибки фрагментации PCcom4 (потеря/перестановка/дубли) и длительные bursts команд → требуется негативное тестирование протокола и устойчивое поведение на стороне устройства.
- Reset/Watchdog во время активного stream/записи → после рестарта устройство обязано стартовать в safe state; осциллограф по умолчанию OFF; нет “авто-возобновления” передачи.

## 7) Test plan / Proof / Rollback
### Test plan / Proof
- Unit/host:
  - тесты логики SRAM ring buffer (SPSC), watermarks, политики overflow (drop/stop) и формата записи (packing/endianness).
- SIL:
  - прогон “producer → буфер → consumer” на трассах/синтетике с моделированием backpressure
    (медленный consumer) и проверкой, что fast-loop-подобный шаг не блокируется
    (логика времени моделируется).
- On-target измерения (GPIO/осциллограф/trace):
  - измерение jitter/latency fast loop при режимах: (1) осциллограф OFF,
    (2) осциллограф ON и поток в USB-UART, (3) осциллограф ON + активный сброс в PSRAM;
  - измерение throughput: запись/чтение PSRAM (в т.ч. DMA) и фактическая скорость выдачи по USB-UART; фиксация условий (baudrate/формат данных);
  - контроль “не блокировать fast loop”: выбранные события на `DBG0/DBG1` (конфигурация события фиксируется в протоколе испытаний) + сравнение с `PWM_OUT`/временными метками.
- HIL/bench:
  - длительный прогон (soak) с бурстами данных осциллографа + параллельно активный CAN-обмен (если включён) и проверка отсутствия деградации основных функций;
  - fault-injection (минимум): имитация ошибок QSPI (timeout/error), принудительное переполнение
    буферов, ошибки CRC/формата PCcom4, reset во время stream; ожидаемое поведение:
    безопасная деградация функции осциллографа без влияния на сварку.

### Rollback
- Feature-flag/конфиг сборки: отключить использование PSRAM и вернуться к режиму
  “SRAM only / stream to PC”, не меняя аппаратный shutdown-path и политику safe state.
- Документация: пометить DN как obsolete/откатить изменения в `docs/PROJECT_CONTEXT.md` (раздел про внешнюю память) в одном PR, если решение отменено.

## 8) Status / Implementation links
- Status: draft
- Links: TBD (issue/PR)
  - План работ (в рамках отдельного PR/серии PR):
    - Обновить `docs/PROJECT_CONTEXT.md` (раздел “Наблюдаемость и логирование”) и
      `docs/GLOSSARY.md` (термины FRAM/PSRAM/внешняя память) согласно принятому решению.
    - Зафиксировать формат “Scope.Data” (узел `0x06`) в `docs/protocols/PCCOM4.02_PROJECT.md`.
    - Добавить план и артефакты измерений в `docs/TEST_PLAN.md` (jitter/throughput/негативные кейсы).



