# DN-003 — Профили калибровки измерения тока вторички (I_weld) по `profile_id`

Статус: draft  
Дата: 2026-02-05  
Владелец: TBD  
Связано: `docs/PROJECT_CONTEXT.md`, `docs/protocols/PROTOCOL_TK.md`, `docs/protocols/PCCOM4.02.md`  

---

## 1) Context / Problem
В системе присутствуют измерения тока первички и вторички; управление сваркой выполняется по току вторички (`I_weld`, см. `docs/PROJECT_CONTEXT.md` / раздел 3).  
Сварочные трансформаторы могут иметь разные коэффициенты трансформации (и/или иные различия “типа”), из‑за чего допускается необходимость разных преобразований “код АЦП → Амперы” для канала `I_weld`. Требуется механизм выбора такого преобразования по `profile_id` без передачи самих профилей по CAN.

Контекст исполнения:
- преобразование `ADC_code → I` живёт в измерительном пайплайне быстрого домена (PWM‑домен), до агрегации `I_per` за период (см. `docs/PROJECT_CONTEXT.md` / раздел 3);
- выбор активного профиля — конфигурационное действие, разрешённое только в `IDLE/safe state` (см. `docs/PROJECT_CONTEXT.md` / раздел 2/4/6 по safe state и gating).

## 2) Goal / Non-goals
### Goal
- Ввести “профиль” как табличное преобразование `ADC_code → I_weld` с кусочно‑линейной интерполяцией и экстраполяцией на краях.
- Хранить профили в NVM с атомарностью при power-loss (Active/Backup) и гарантировать, что рантайм не использует невалидный профиль.
- По CAN разрешить только выбор `profile_id` (без чтения/записи профиля), применяемый только в `IDLE/safe state`.

### Non-goals
- Не передавать профиль (таблицу точек) по CAN.
- Не вводить контроль “коррекции ±2%” и иные метрики “похожести” профиля на базовый пересчёт.
- Не вводить ограничения на наклон `ΔI/Δcode` как критерий валидации.

## 3) Decision (что делаем)
### 3.1 Профиль `I_weld`
Профиль задаётся набором точек `points[]` (длина `num_points`), каждая точка:
- `adc_code` — код АЦП (формат соответствует реальному АЦП канала `I_weld`, signed/unsigned фиксируется в реализации);
- `I_0p1A` — ток в единицах `0.1 A/LSB` (целое, диапазон **0…50 кА**).

Ограничения:
- `num_points`: **2…20**
- `I_0p1A`: **0…500_000** (т.е. 0…50 000.0 A)
- `adc_code`: строго возрастающая последовательность (`adc_code[i+1] > adc_code[i]`)

Профиль применяется после базовой коррекции нуля (offset) канала `I_weld`:
- `adc_code_corr = adc_code_raw - adc_offset0`
- далее `I = ProfileEval(adc_code_corr)`

Примечание: коррекция offset считается “пер-изделие”, а профиль — “пер-тип трансформатора”.

### 3.2 Алгоритм `ProfileEval`
- Внутри диапазона: найти сегмент `[i, i+1]`, где `adc_code[i] <= adc_code_corr < adc_code[i+1]`, и выполнить линейную интерполяцию по `I_0p1A`.
- Слева от диапазона: экстраполировать по прямой через первые две точки `[0, 1]`.
- Справа от диапазона: экстраполировать по прямой через последние две точки `[n-2, n-1]`.
- Результат зажать (clamp) в диапазон **0…50 кА**.

### 3.3 Хранение в NVM (Active/Backup)
Профили хранятся в NVM с контролем целостности и безопасными дефолтами (см. `docs/PROJECT_CONTEXT.md` / раздел 5):
- формат записи минимум: `magic + version + crc32 + payload`.
- схема устойчивости к power-loss: Active/Backup (две копии).
- boot‑логика: загрузить Active если валиден; иначе Backup; иначе hardcoded safe defaults.

### 3.4 Интерфейсы управления
#### PCcom (UART)
Загрузка/чтение/управление профилями выполняется только через PCcom (см. `docs/protocols/PCCOM4.02.md`):
- `ProfileList`
- `ProfileRead(profile_id)`
- `ProfileWrite(profile_id, num_points, points[])` → `OK/ERR(code)`
- `ProfileErase(profile_id)` (опционально)
- `ProfileSetActive(profile_id)` (только `state=IDLE`) → `OK/ERR(code)`
- `ProfileGetActive()`

При ошибке записи/валидации профиль не сохраняется и не становится активным; активный профиль не изменяется.

#### CAN (ТК)
По CAN разрешён только выбор активного `profile_id`. Рекомендуемый транспорт — сервисный домен `SERVICE_REQ (0x060)` (см. `docs/protocols/PROTOCOL_TK.md` / раздел 8: сервисные команды отделены от 1 кГц домена):
- добавить `svc_op = SET_PROFILE_ID` (opcode назначается проектом);
- payload содержит `profile_id` (u8) и `svc_seq` (u8);
- применимость: только при `state=IDLE/safe state`, иначе reject/игнор (без изменения активного профиля);
- если `profile_id` не существует в NVM/каталоге — reject/игнор.

Наблюдаемость/диагностика:
- опционально добавить в `FB_STATUS (0x030)` диагностическое поле `profile_id_active` (u8), чтобы ТК мог подтвердить выбор без чтения профиля.

## 4) Rationale (почему так)
- Профиль как таблица `ADC_code → I` обеспечивает:
  - одинаковый механизм для разных “типов” трансформаторов;
  - отсутствие необходимости сложных моделей/коэффициентов в быстром домене;
  - детерминированную стоимость вычисления (поиск сегмента + линейная арифметика).
- Запрет записи профиля по CAN снижает риск “случайной конфигурации” и соответствует политике протокола (см. `docs/protocols/PROTOCOL_TK.md` / запрет tuning по CAN).
- Active/Backup и CRC позволяют пережить power-loss без перехода в неопределённые калибровки (см. `docs/PROJECT_CONTEXT.md` / раздел 5).

## 5) Interfaces / Data / Timing impact
- Быстрый домен:
  - добавляется вычисление `ProfileEval(adc_code_corr)` для `I_weld`.
  - экстраполяция на краях требует деления на `Δadc_code`; при `num_points>=2` и строгой монотонности `Δadc_code != 0`.
- CAN:
  - добавляется сервисная операция выбора `profile_id` в `SERVICE_REQ`.
  - (опционально) расширяется `FB_STATUS` полем `profile_id_active`.
- PCcom:
  - добавляются/фиксируются сервисные команды управления профилями.

## 6) Risks / Edge cases
- Экстраполяция может дать нефизичный рост/падение при “плохих” крайних точках; эффект ограничивается clamp 0…50 кА, но возможно ухудшение качества управления (качество данных профиля — ответственность процедуры подготовки на производстве).
- При отсутствии ограничения на наклон возможны “почти вертикальные” сегменты, приводящие к резкой чувствительности (профиль валиден формально).
- Без обязательного `profile_id_active` в телеметрии возможен “тихий” reject выбора профиля по CAN (если ТК ошибся `profile_id` или попытался применить не в IDLE).

## 7) Test plan / Proof / Rollback
### Test plan / Proof
- Unit/host:
  - `ProfileEval`: интерполяция внутри диапазона, экстраполяция слева/справа, clamp 0…50 кА.
  - валидатор профиля: `num_points` 2…20, строгая монотонность `adc_code`, диапазон `I_0p1A`, CRC/version.
- On-target (измерения/наблюдаемость):
  - запись профиля через PCcom → reboot → профиль сохраняется и применяется.
  - попытка записи невалидного профиля через PCcom → профиль отвергнут, активный не изменён.
  - CAN `SET_PROFILE_ID` в `IDLE` → активный меняется; в `ARMED/WELD` → reject/игнор.
- Fault-injection:
  - битый Active слот NVM → загрузка Backup; битые оба → safe defaults.
  - power-loss в процессе записи → после reboot остаётся предыдущий валидный профиль (Active/Backup).

### Rollback
- Откат профиля: выбрать предыдущий `profile_id` (PCcom или CAN в IDLE).
- Откат к дефолтам: стереть/сбросить профили через PCcom; при отсутствии валидных — загрузятся safe defaults (см. `docs/PROJECT_CONTEXT.md` / раздел 5).

## 8) Status / Implementation links
- Status: draft
- Links: TBD

