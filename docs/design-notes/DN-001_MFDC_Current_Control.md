# DN-001 — Контур тока MFDC-источника (Design Note)

**Документ:** DN-001  
**Название:** Контур тока MFDC-источника как детерминированный привод тока  
**Версия:** 1.0  
**Статус:** Formal Design Note  
**Дата:** 2026-01-29  

---

## 1. Назначение документа

Настоящий Design Note фиксирует **обязательные архитектурные требования** к программному обеспечению источника MFDC-сварки.

Документ предназначен для:
- разработчиков embedded-ПО источника;
- архитектурного и safety-review;
- обеспечения воспроизводимости поведения при масштабировании и сопровождении.

Формулировки вида **SHALL / SHALL NOT / SHOULD** являются **нормативными**.

---

## 2. Границы ответственности

### 2.1. Источник MFDC

Источник MFDC **SHALL**:
- реализовывать быстрый и детерминированный контур тока;
- обеспечивать слежение `I_sec → I_ref_used` в пределах физических ограничений;
- сигнализировать о насыщениях, лимитах и отказах.

Источник MFDC **SHALL NOT**:
- принимать процессные решения (энергия, качество ядра, сопротивление);
- изменять профиль уставки с целью «улучшения» процесса;
- скрывать насыщения и лимиты от ТК.

### 2.2. Технологический комплекс (ТК)

ТК:
- формирует `I_ref_cmd(t)`;
- интерпретирует флаги источника;
- принимает решения при недостижимости уставки.

---

## 3. Временная архитектура (Real-Time Contract)

### 3.1. Измерение

Источник **SHALL**:
- выполнять измерение тока и напряжения в фиксированной фазе ШИМ;
- использовать аппаратный триггер АЦП от таймера ШИМ;
- обеспечивать постоянную задержку `sample → compute → PWM update`.

Источник **SHALL NOT**:
- выполнять измерения в произвольные моменты времени;
- зависеть от CAN, логирования или RTOS-задач в fast loop.

---

## 4. Контур тока

### 4.1. Регулятор

Источник **SHALL**:
- использовать PI-регулятор по току;
- иметь ограничение управляющего воздействия `u ∈ [u_min, u_max]`;
- реализовывать anti-windup.

Источник **SHALL NOT**:
- интегрировать ошибку при ухудшении насыщения;
- допускать неконтролируемый рост интегратора.

### 4.2. Feedforward

Источник **SHALL**:
- поддерживать feedforward по `Udc`, если измерение доступно;
- ограничивать вклад feedforward раньше PI.

Источник **SHALL NOT**:
- увеличивать `u_ff` при `Udc < Udc_crit` без ограничения;
- пытаться компенсировать невозможные режимы.

---

## 5. Уставка тока

Источник **SHALL**:
- применять ограничитель скорости изменения `dI/dt`;
- публиковать `I_ref_used` в телеметрии.

Источник **SHALL NOT**:
- скрыто фильтровать уставку;
- формировать «красивые» профили без явной команды ТК.

---

## 6. Измерение тока (катушка Роговского)

Источник **SHALL**:
- детектировать отказ датчика тока (обрыв, залипание, выход за диапазон);
- запрещать ШИМ при недоверии к измерению;
- поддерживать процедуру авто-рецентровки нуля.

Источник **SHALL NOT**:
- продолжать управление при невалидном токе;
- использовать отчётно-фильтрованный сигнал в fast loop.

---

## 7. CAN-взаимодействие

Источник **SHALL**:
- контролировать timeout команд;
- различать soft-timeout и hard-timeout;
- публиковать `seq_applied`.

Источник **SHALL NOT**:
- зависеть от частоты CAN для устойчивости контура;
- удерживать активный ШИМ при hard-timeout.

---

## 8. Насыщение и лимиты

Источник **SHALL**:
- выставлять флаги насыщения (`LIMIT_HI / LIMIT_LO`);
- фиксировать длительные насыщения (`TRACKING_BAD`).

Источник **SHALL NOT**:
- пытаться «дожимать» ток в насыщении;
- скрывать причину недостижения уставки.

---

## 9. Безопасное состояние

Источник **SHALL**:
- переходить в безопасное состояние при:
  - отказе датчика;
  - потере CAN;
  - критическом падении Udc;
- отключать ШИМ аппаратно и программно.

---

## 10. Трассируемость

Источник **SHALL**:
- логировать управляющие решения (`u`, `I_ref_used`, flags);
- фиксировать события отказов (EVENT_FAULT);
- иметь версионирование форматов логов.

---

## 11. Итог

Любое отклонение от требований настоящего DN **SHALL** рассматриваться как архитектурный дефект и проходить отдельный review.
