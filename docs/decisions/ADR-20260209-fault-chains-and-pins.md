# ADR-TEMPLATE — Architecture Decision Record (шаблон)

Статус: draft  
Дата: 2026-02-09  
Владелец: Bespalov  
Связано: TBD (issue/PR/commit/links)  

---

## 1) Context / Problem
- Нужно зафиксировать **fault-цепи** (какие аппаратные/программные события обязаны приводить к safe state) и **минимальный набор пинов/сигналов**, которыми эти цепи управляются/наблюдаются.
- Цель: defence-in-depth (слоистая защита), чтобы сварочный ток прекращался аппаратно даже при отказе МК/ПО/питания (см. `docs/PROJECT_CONTEXT.md`, `docs/safety/SAFETY_CONCEPT_CBM706T_RU.md`).
- Контекст архитектуры: fast loop (PWM/измерение/fast protections) не зависит от RTOS; slow loop — FreeRTOS; критические аварии должны “рубить” силовую часть аппаратно (см. `docs/ARCHITECTURE.md`).
- Что нельзя нарушать (safety/тайминги/совместимость):
  - **Reset ≠ safe state**: reset МК используется для восстановления, но безопасность обеспечивается отдельными аппаратными цепями.
  - Критические аварии должны выключать силовую часть **аппаратно** (TIM1 BKIN/BKIN2 и/или аппаратный запрет драйверов), не завися от RTOS/задач/обмена.
  - Нет автоперезапуска после критического fault (latch-OFf до осознанного recovery).
- Триггеры пересмотра решения:
  - изменение драйверов затворов/их интерфейсов (например, SDI/enable),
  - изменение супервизора/внешнего watchdog,
  - добавление новых критичных источников аварий (interlock, силовой контакт, HV discharge и т.п.),
  - переход на другой таймер/схему PWM (TIM1 → TIM8 и т.п.).

## 2) Decision (что выбрали)
- Выбранный вариант: **Вариант A — минимальный, но слоистый**.
  - S1 (быстрый stop PWM): **TIM1 BKIN + TIM1 BKIN2** — два независимых break-входа.
  - S2 (primary safety layer): **аппаратный запрет драйверов через SDI** (например, SKYPER `PRIM_nERROR_IN` / SDI, active LOW, latch), управляемый wired-OR “тянем вниз” несколькими источниками.
  - S3 (супервизор/WDG): внешний супервизор (CBM706T) формирует:
    - `RESET_OUT` → `NRST` (восстановление),
    - `FAULT_OUT` → (1) SDI-line (запрет драйверов) и (2) BKIN2 (stop PWM).
  - МК выдаёт heartbeat `WDI` в супервизор отдельным пином.
  - МК может дополнительно тянуть SDI-line вниз (через open-drain/транзистор) для управляемого safe stop/локальных fault-классов.
- Scope: фиксируется минимальный набор сигналов, их роли и электрические требования (open-drain, уровни), а также требования к доказательствам.

## 3) Options considered (варианты)
### Вариант A
- Идея:
  - Использовать одновременно BKIN и BKIN2 для разных классов аппаратных причин.
  - SDI драйвера = общий “рубильник драйверов” (S2), который тянется в LOW несколькими источниками (МК + супервизор + опционально силовые компараторы/интерлок).
  - FAULT супервизора заводится на SDI и BKIN2 аппаратно.
- Плюсы:
  - Defence-in-depth: отказ МК/ПО/сети не мешает безопасному отключению.
  - Разделение причин (BKIN vs BKIN2) повышает диагностируемость без дополнительных GPIO.
  - Гибкость фильтрации/полярности/источников: можно отдельно обрабатывать “силовые быстрые” и “системные” аварии.
- Минусы/риски:
  - Нужно аккуратно сделать уровни/электрику SDI (обычно подтяжка к +5 В на стороне драйвера → только open-drain/транзистор).
  - Требуется дисциплина “latched OFF” (чтобы не получилось самовосстановление от краткого импульса).

### Вариант B
- Идея:
  - Только один break вход (BKIN), а все источники аварии объединить (wired-OR/логика) в одну линию.
  - SDI использовать только для “управляемого” запрета от МК (без супервизора на SDI).
- Плюсы:
  - Меньше пинов на TIM1 (можно не разводить BKIN2).
  - Меньше вариантов конфигурации break.
- Минусы/риски:
  - Потеря разделения причин и возможность “одним компромиссом” по фильтрации/полярности ухудшить реакцию на часть аварий.
  - Если МК завис, а супервизор делает только reset, можно получить нежелательное “reset без safe state” (против принципа Reset ≠ Safety).

### (опционально) Вариант C
- Идея:
  - Делать safety только через запрет драйверов (SDI/DRV_EN), а break использовать минимально/не использовать.
- Плюсы:
  - Меньше завязки на TIM1 break-логику.
- Минусы/риски:
  - Потеря аппаратного stop PWM как отдельного слоя (S1): хуже наблюдаемость, больше EMI/непредсказуемых режимов “таймер генерирует, но драйверы игнорируют”.
  - Хуже масштабируется для “быстрых силовых” защит, где break естественнее.

## 4) Decision criteria (критерии выбора)
- Safety: независимый аппаратный safe state при зависании МК/ПО/питании.
- Детерминизм: минимальная задержка отключения (µs для S1), отсутствие зависимости от RTOS/ISR.
- Диагностируемость: возможность отличать классы аварий без лишних GPIO.
- Пин-экономия: минимальное число GPIO, предпочтение аппаратным связям (FAULT→BKIN2/SDI).
- Простота верификации: возможность измерить на железе “FAULT/BKIN → PWM_OUT off” и “SDI low → драйверы запрещены”.

## 5) Rationale (почему так)
- Вариант A удовлетворяет критериям лучше всего:
  - реализует слоистую защиту S1/S2/S3, где каждый слой автономен;
  - использует BKIN2 как “второй независимый вход рубильника” и как способ разделить системные/силовые причины аварии;
  - минимизирует число **GPIO МК**: большинство связей делается аппаратно (FAULT_OUT в BKIN2 и SDI-line).
- Вариант B отклонён, потому что смешивает разные аварии в одну линию и повышает риск “reset вместо безопасности”.
- Вариант C отклонён, потому что убирает аппаратный stop PWM как отдельный слой и ухудшает наблюдаемость/управляемость.

## 6) Consequences / Risks
- Позитивные последствия:
  - При зависании МК супервизор инициирует **аппаратный запрет драйверов** и/или break, независимо от ПО.
  - МК может безопасно инициировать stop, не полагаясь на “успеем обработать” в задачах.
  - Разделение BKIN/BKIN2 помогает анализу причин fault без добавления отдельных статусных линий.
- Негативные последствия/долг:
  - Требуется явно определить электрическую схему SDI-line (уровни +5 В, open-drain, общий GND, устойчивость к помехам).
  - Нужны документированные правила recovery (как снимается latch драйвера и latch fault-политики в ПО).
- Риски отказа/edge cases и как их обнаруживаем:
  - Обрыв/плохой контакт линии BKIN2 или SDI-line → тест self-test/производственный тест + диагностика флагов break.
  - Ошибочное push-pull управление SDI при +5 В подтяжке → DRC/ревью схемы + простая проверка осциллографом уровней.
  - Дребезг interlock/FAULT → фильтрация/топология источника, измерение устойчивости на стенде.

## 7) Interfaces / Data / Timing impact
- Сигналы и роли (минимум):
  - `TIM1_BKIN` (вход, AF): быстрые “силовые” причины (driver fault / fast OCP / HW trip) — по проекту.
  - `TIM1_BKIN2` (вход, AF): “системные” причины (CBM706T `FAULT_OUT`, interlock/E-STOP, hard-timeout).
  - `SKYPER_SDI` (аппаратная линия, active LOW, latch): primary safety layer запрета драйверов.
  - `WDI/HEARTBEAT` (GPIO out МК → CBM706T): доказательство “МК жив”.
  - `RESET_OUT` (CBM706T → NRST): восстановление управляемости.
  - `FAULT_OUT` (CBM706T): аппаратная безопасность; подключается в SDI-line и BKIN2.
- Электрические требования:
  - SDI-line должна поддерживать wired-OR “тянем вниз”: источники (МК/супервизор/интерлок) должны быть open-drain/open-collector или через транзистор.
  - При reset/boot МК не должен непреднамеренно снимать запрет драйверов; safe-by-default обеспечивается схемой подтяжек.
- Тайминги/джиттер:
  - S1 (BKIN/BKIN2) должен выключать PWM аппаратно в микросекундном масштабе; подтверждается измерением `BKIN_RAW → PWM_OUT`.
  - S2 (SDI) должен гарантировать запрет драйверов независимо от PWM/CPU; подтверждается измерением реакции драйвера на SDI low.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host:
  - Проверка логики `safety_supervisor`/state machine: “fault latched → weld disallowed” и отсутствие автосброса.
- SIL:
  - Прогон сценариев потери связи/невалидных измерений/overrun → корректная эскалация в safe state.
- On-target измерения (GPIO/осциллограф/trace):
  - Измерить задержку `BKIN_RAW` и `BKIN2_RAW` → `PWM_OUT` (off).
  - Измерить реакцию `SDI_LINE` low → запрет драйвера (по доступному сигналу/нагрузке).
  - Проверить, что при reset МК SDI остаётся в “запрещено” до явного разрешения (safe-by-default).
- HIL/bench:
  - Fault-injection минимум 5:
    1) зависание МК (останов heartbeat) → CBM706T FAULT → SDI/BKIN2,
    2) кратковременный “дрожащий” interlock → отсутствие самовосстановления,
    3) driver fault → BKIN (и/или отдельный источник),
    4) принудительный SDI low от МК → безопасный stop + latch по политике,
    5) обрыв/залипание одной из линий (эмулировать) → диагностируемое состояние + запрет сварки.

### Rollback
- В случае проблем с разделением BKIN/BKIN2 допускается временно объединить источники на один break вход (Вариант B) с обязательной фиксацией причины и планом возврата к Варианту A.

## 9) Status / Follow-ups
- Status: draft | accepted | implemented | obsolete
- Follow-ups: TODO список задач (если есть)
  - Зафиксировать в `docs/PROJECT_CONTEXT.md` конкретные назначения источников BKIN/BKIN2 и электрические требования к SDI-line.
  - Добавить в `docs/TEST_PLAN.md` (если/когда появится) измерения shutdown latency и сценарии fault-injection.
  - Уточнить, какие сигналы драйвера доступны для наблюдения “SDI сработал” на отладочной и боевой платах.
- Links: PR/commit/issue

