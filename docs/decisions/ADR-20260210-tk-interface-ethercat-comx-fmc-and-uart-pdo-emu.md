# ADR-TEMPLATE — Architecture Decision Record (шаблон)

Статус: draft  
Дата: 2026-02-10  
Владелец: Bespalov  
Связано: `docs/decisions/ADR-20260209-tk-ethercat-pdo-emu-over-udp-batching.md`, TBD (issue/PR/commit)  

---

## 1) Context / Problem
- Требуется заменить штатный интерфейс взаимодействия с ТК: **CAN FD → EtherCAT**.
- EtherCAT реализуется через модуль **COMX 100CA-RE**, подключение к MCU по **FMC** (доступ к process image / регистрам модуля).
- Сохраняем возможность имитации циклического управления “как EtherCAT PDO” для разработки/отладки с ПК под Windows, но **не через отдельный Ethernet/UDP**, а через **USB-UART (PCcom4)**.
- Контекст проекта по доменам и safety: см. `docs/CONTEXT_SNAPSHOT.md` (fast loop = PWM период; slow loop = 1 мс команды; аппаратный shutdown-path через TIM1 BKIN/BKIN2).
- Ограничения/инварианты (нельзя сломать):
  - аппаратный safe state / shutdown-path (TIM1 BKIN/BKIN2) неизменен; критические аварии не “софтверные”.
  - потеря/невалидность команд от ТК (или их “устаревание”) ⇒ безопасный останов/запрет сварки по watchdog; без авто-рестарта после критических fault (latch до явного recovery).
  - обработка EtherCAT/эмуляции не должна блокировать fast loop/критичные ISR; при перегрузке допустимы дроп/метрики качества, но не “варка вслепую”.
- Триггеры пересмотра:
  - если понадобится жёсткая синхронизация уровня EtherCAT DC/SYNC с привязкой к PWM/измерениям (а COMX/FMC-интеграция не даёт нужного детерминизма/наблюдаемости),
  - если USB-UART окажется недостаточным по пропускной способности для нужной телеметрии/осциллографа (см. альтернативы буферизации в design notes, напр. `docs/design-notes/DN-005_QSPI_PSRAM_Oscilloscope_Buffer.md`),
  - если ТК потребует функциональность beyond PDO (mailbox/CoE/диагностика), требующую иной архитектуры на стороне MCU/COMX.

## 2) Decision (что выбрали)
- Выбранный вариант: **Вариант A**.
- Scope: что меняем / что не меняем.
  - Меняем: транспорт и контракт обмена с ТК на **EtherCAT PDO через COMX 100CA-RE (FMC)**.
  - Оставляем: fast loop/PWM/аварии и аппаратный shutdown-path (BKIN/BKIN2, DRV_EN/INH если используется) без изменений по принципам из `docs/CONTEXT_SNAPSHOT.md`.
  - Для разработки/ПК-инструментов: сохраняем “PDO-like” обмен, но переносим его на **PCcom4 поверх USB-UART** (стримовый транспорт), переиспользуя уже определённые структуры `TkPdo.Emu.*` из ADR от 2026-02-09 (см. ссылки в разделе 7).

## 3) Options considered (варианты)
### Вариант A
- Идея:
  - Production/штатно: EtherCAT Slave = COMX 100CA-RE; MCU обслуживает PDO через FMC (process image), в **task-контексте**, ISR — только “разбудить/поставить флаг”.
  - Dev/отладка: “EtherCAT PDO-like” поверх USB-UART как PCcom4 stream (без UDP и без batching).
- Плюсы:
  - Соответствует целевому требованию “CAN FD → EtherCAT” без введения параллельного Ethernet-сервиса.
  - Минимизирует риск влияния на fast loop: heavy обработка в task, ISR минимальный.
  - USB-UART остаётся унифицированным сервисным каналом (PCcom4 уже принят в проекте).
- Минусы/риски:
  - Требуется чётко определить watchdog/валидность/возраст команд для EtherCAT PDO (и доказать измерениями).
  - Интеграционные риски COMX/FMC (инициализация, обмен, обработка зависаний/ошибок модуля, наблюдаемость).
  - USB-UART может ограничить скорость “цифрового осциллографа”/телеметрии (нужен план деградации и/или буферизация).

### Вариант B
- Идея:
  - EtherCAT через COMX/FMC (как в A) + отдельный сервисный Ethernet (как в ADR 2026-02-09) для осциллографа и PDO-эмуляции по UDP.
- Плюсы:
  - Выше пропускная способность для телеметрии/осциллографа, меньше нагрузка на UART.
  - Можно сохранить уже описанный UDP-профиль без миграции на UART.
- Минусы/риски:
  - Дополнительный интерфейс/стек/поверхность отказов; выше риск побочных эффектов на RT и сложнее доказательства.
  - Удорожание/усложнение аппаратуры и тестов (раздельный Ethernet помимо EtherCAT).

### Вариант C
- Идея:
  - На первом этапе не внедрять COMX/EtherCAT; оставить CAN FD штатно, а “PDO-like” делать только по USB-UART (PCcom4) для ранней отладки.
- Плюсы:
  - Быстрый bring-up без аппаратной/интеграционной части EtherCAT.
- Минусы/риски:
  - Не удовлетворяет целевому требованию замены интерфейса ТК на EtherCAT; риск “временное станет постоянным”.
  - Разрыв между dev-эмуляцией и реальным EtherCAT (риски миграции позже).

## 4) Decision criteria (критерии выбора)
- Safety: детерминированный safe stop при потере/устаревании команд, без “варки вслепую”, без авто-рестарта после критических fault.
- RT-изоляция: отсутствие влияния на fast loop (PWM-домен) и критичные ISR; ограниченная и измеримая нагрузка в slow loop.
- Детерминизм и наблюдаемость: возможность измерить возраст команды, джиттер, задержки применения; наличие счётчиков качества связи/ошибок.
- Интеграционный риск: сложность COMX/FMC и обработка отказов модуля/шины.
- Сопровождаемость/совместимость: минимальная “зоопарковость” транспортов; переиспользование PCcom4 для dev/сервиса.
- Пропускная способность телеметрии: достаточность USB-UART или наличие понятного пути масштабирования.

## 5) Rationale (почему так)
- Вариант A напрямую закрывает “CAN FD → EtherCAT” и при этом не требует параллельного Ethernet-сервиса, который увеличивает поверхность риска и объём доказательств.
- Вариант A сохраняет dev-ценность предыдущей идеи “PDO-like” для Windows, но делает её через USB-UART (PCcom4), что лучше согласуется с ограничением “не блокировать fast loop” и с уже принятым сервисным интерфейсом.
- Вариант B отклонён из‑за дополнительной сложности/рисков (ещё один Ethernet-стек/обмен), при том что необходимость высокой пропускной способности телеметрии может быть решена буферизацией/альтернативными путями (отдельное решение/ADR при необходимости).
- Вариант C отклонён, потому что не выполняет целевую замену штатного интерфейса ТК на EtherCAT и создаёт риск затягивания миграции.

## 6) Consequences / Risks
- Позитивные последствия:
  - Единый целевой интерфейс с ТК: EtherCAT PDO через COMX/FMC.
  - “PDO-like” режим для ПК остаётся, но становится проще по инфраструктуре (USB-UART), и его легче изолировать от RT-домена.
- Негативные последствия/долг:
  - Нужно спроектировать и зафиксировать: PDO mapping (команды/статусы), правила валидности, таймауты, счетчики качества.
  - Нужно определить поведение при частичных отказах: зависание COMX, ошибки FMC/доступа, “застывший” process image.
- Риски отказа/edge cases и как их обнаруживаем:
  - Stale command (PDO не обновляется): детект по seq/age + watchdog_trip counter + статусный флаг “link timeout active”.
  - Неконсистентный снимок process image (гонка чтения): использовать снапшот/двухфазное чтение (seq до/после) и счётчик “inconsistent_read”.
  - Перегрузка slow loop: метрики длительности обработки + флаг overruns; при деградации — controlled stop/запрет сварки по политике.
  - Ограничение USB-UART: счётчики overflow/drop и явная деградация (“данные не полные”), без влияния на управление.

## 7) Interfaces / Data / Timing impact
- Какие интерфейсы/форматы/контракты меняются:
  - Штатный обмен с ТК: CAN FD больше не является источником команд; вместо него — EtherCAT PDO (COMX 100CA-RE).
  - Dev/PC обмен “PDO-like”: транспорт меняется с UDP/Ethernet на USB-UART (PCcom4 stream).
- Контракты данных (высокоуровнево):
  - EtherCAT PDO: определить RxPDO (команды/уставки/enable/mode/seq) и TxPDO (статус/измерения/ошибки/seq_echo/качество связи).
  - USB-UART emu: переиспользовать `TkPdo.Emu.RxFrame` (32 байта) и `TkPdo.Emu.TxFrame` (20 байт), определённые в `docs/decisions/ADR-20260209-tk-ethercat-pdo-emu-over-udp-batching.md` (раздел “Interfaces / Data / Timing impact”), но транспортировать их как PCcom4 frames по UART (стрим, без batching).
- Влияние на тайминги/джиттер/бюджеты + что измерять:
  - Период/джиттер EtherCAT-обновлений и “возраст команды” на момент применения в slow loop (метрика `cmd_age_max_us`).
  - Задержка “новый PDO доступен → команда принята → команда применена” (в пределах slow loop).
  - Граница worst-case: определить и зафиксировать `Tk.LinkTimeoutMs` (TBD по требованиям и измерениям).
- Обратная совместимость/миграция:
  - Не требуется.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host:
  - Логика валидности команды: seq/age/timeout, детект “inconsistent snapshot” при чтении process image.
  - Парсер PCcom4 stream для UART (ресинхронизация по 0xFF, CRC16, валидация фиксированных DataLen для `TkPdo.Emu.*`) — см. `docs/protocols/PCCOM4.02.md`.
- SIL:
  - Модель обмена: “пришёл новый PDO (seq) → обновили cmd → применили в slow loop → сформировали статус/seq_echo”; watchdog при пропусках/зависании.
- On-target измерения (GPIO/осциллограф/trace):
  - GPIO события (пример): `COMX_IRQ`, `PDO_SNAPSHOT_OK`, `CMD_APPLIED`, `WATCHDOG_TRIP`.
  - Измерить:
    - распределение периода прихода/обновления PDO (и его джиттер),
    - задержку `COMX_IRQ → CMD_APPLIED`,
    - максимальный возраст команды и время реакции safe stop при обрыве.
- HIL/bench (fault-injection, минимум 5):
  1) потеря EtherCAT линка,
  2) зависание/стоп обновления process image со стороны COMX,
  3) “застывший” seq (обновления не происходят),
  4) искусственные задержки обработки в slow loop (имитация перегрузки),
  5) ошибки UART/битые CRC в режиме emu.
  - Ожидаемое: safe stop по политике, корректные флаги/счётчики, отсутствие влияния на fast loop и аппаратный shutdown-path.

## 9) Status / Follow-ups
- Status: draft | accepted | implemented | obsolete
- Follow-ups: TODO список задач (если есть)
  - Зафиксировать EtherCAT PDO mapping (RxPDO/TxPDO) и правила валидности/таймаутов (`Tk.LinkTimeoutMs`, критерии “валидная команда”).
  - Определить механизм “атомарного” чтения process image через FMC (seq-before/seq-after, снапшот в буфер).
  - Обновить/добавить проектный профиль для PCcom4 по UART для `TkPdo.Emu.*` (ссылки и точные форматы брать из ADR 2026-02-09; транспорт поменять на UART, убрать UDP batching).
  - План измерений таймингов (на железе) и набор fault-injection сценариев для приёмки решения.
  - Пометить `docs/decisions/ADR-20260209-tk-ethercat-pdo-emu-over-udp-batching.md` как частично устаревший: “идея/форматы `TkPdo.Emu.*` актуальны, транспорт UDP/Ethernet — obsolete (заменён на USB-UART)”.
- Links: PR/commit/issue
