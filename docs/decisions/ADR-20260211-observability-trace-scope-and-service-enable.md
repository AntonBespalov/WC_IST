# ADR-20260211-observability-trace-scope-and-service-enable — Наблюдаемость (Trace/Scope) с безопасной буферизацией и включением сервиса по PCcom4

Статус: draft  
Дата: 2026-02-11  
Владелец: TBD  
Связано: TBD (issue/PR/commit/links)  

---

## 1) Context / Problem
- Требуется механизм наблюдаемости, который позволяет собирать целостный набор данных для последующего анализа на ПК: события и параметры из разных модулей, а также “осциллографические” окна высокочастотных выборок АЦП.
- Система имеет разные временные домены (fast PWM без RTOS и slow 1 мс в FreeRTOS; см. `docs/PROJECT_CONTEXT.md`): данные должны быть коррелируемы по времени между доменами.
- Ограничения (инварианты), которые нельзя нарушать:
  - fast-домен (PWM) должен оставаться детерминированным: без блокировок, без тяжёлой сериализации, без обращения к USB-UART/PCcom4 и без обращения к внешней памяти QSPI из fast/ISR (см. также `docs/design-notes/DN-004_MFDC_Control_Core.md` и `docs/design-notes/DN-005_QSPI_PSRAM_Oscilloscope_Buffer.md`).
  - наблюдаемость не участвует в shutdown-path силовой части: аппаратные защиты (BKIN/DRV_EN/INH и т.п.) остаются независимыми (см. `docs/PROJECT_CONTEXT.md` / safety и `docs/decisions/ADR-20260209-fault-chains-and-pins.md`).
  - по умолчанию штатная работа не должна включать сервисный обмен с ПК и не должна выполнять логирование/осциллографирование; обмен идёт только с ТК по EtherCAT (протокол см. `docs/protocols/PROTOCOL_TK_ETHERCAT.md`).
- Высокочастотный пример: AD7380 до 400 кГц (период 2.5 мкс), максимум 2 канала. Требуемый режим: окна pre 5–10 мс и post 100–200 мс. Дополнительно присутствуют более медленные каналы (например, AD7606).
- Сервисный интерфейс “плата ↔ ПК”: USB-UART через FT232H с протоколом PCcom4 (см. `docs/PROJECT_CONTEXT.md` и `docs/protocols/PCCOM4.02.md`, профиль проекта `docs/protocols/PCCOM4.02_PROJECT.md`).
- Триггеры осциллографа: команда с ПК, fault, установка целевого тока с ТК.
- Триггеры пересмотра решения:
  - появляется требование “всегда включённая” телеметрия/сервисный обмен по умолчанию;
  - меняется транспорт сервиса (не USB-UART/PCcom4) или появляются требования к гарантированному без-потерь стриму сырых данных;
  - подтверждённый замер таймингов показывает недопустимый джиттер fast-домена при включённой наблюдаемости.

## 2) Decision (что выбрали)
- Выбранный вариант: разделить наблюдаемость на два потока и реализовать буферизацию через SPSC по контекстам исполнения:
  - `Trace` — универсальные записи (events/параметры) для разных модулей с частотами порядка kHz и ниже.
  - `Scope` — высокочастотные сырые выборки АЦП (например, AD7380 400 кГц) только в виде окон pre/post-trigger; запись блоками через DMA.
  - Буферизация: вариант A (SPSC) — отдельные кольцевые буферы по контекстам (как минимум fast/ISR/task), а склейка/отправка/запись в PSRAM выполняются только в slow task.
  - Временная привязка: гибрид `fast_seq` + `timestamp_ticks` (единый счётчик от free-running таймера) в каждой записи/метаданных блока.
- Включение сервиса:
  - По умолчанию наблюдаемость полностью выключена (нет логирования, нет запуска Scope/DMA, нет TX по UART).
  - UART RX + лёгкий PCcom4 stream-парсер всегда активны, но принимают только команду включения сервиса (`Service.Enable=ON`).
  - `Service.Enable=ON` действует до reset (одноразовая debug-сессия).
- Scope (осциллограф) 400 кГц:
  - Армирование Scope по `enable_cmd` от ТК (до фактического формирования сварочного тока), чтобы гарантировать pre 5–10 мс.
  - Триггеры во время активного захвата игнорируются (ведётся `dropped_triggers` и, опционально, “последняя причина”).
  - Триггер от fault сохраняет окно best effort, даже если силовая часть уже выключена аппаратно (наблюдаемость не должна влиять на shutdown-path).

Scope: затрагиваются сервисный стек (PCcom4 проектный профиль), модуль наблюдаемости (буферы/состояния/метрики), интерфейсы с источниками данных (control/ADC/fault), а также тесты/план верификации. Не меняются: контуры управления/пороговые защиты и аппаратный shutdown-path.

## 3) Options considered (варианты)
### Вариант A
- Идея: единый общий буфер/поток логов, куда пишут все источники (MPSC), и единый consumer отправляет это на ПК.
- Плюсы:
  - единый упорядоченный поток “из коробки”;
  - проще протокол на ПК (одна лента событий).
- Минусы/риски:
  - сложная синхронизация (MPSC) и высокая цена атомиков/critical section в fast/ISR;
  - рост джиттера и ухудшение worst-case для fast-домена;
  - повышенный риск редких гонок/полузаписанных сообщений без аккуратного commit-протокола и memory barriers;
  - объединение “Trace” и “Scope” провоцирует ошибочную попытку логировать высокочастотные сэмплы как “записи”, что не масштабируется по полосе и памяти.

### Вариант B
- Идея: разделить `Trace` и `Scope`, использовать SPSC буферы по контекстам (fast/ISR/task), а объединение/упаковку/отправку выполнять только в slow task; high-rate ADC писать блоками через DMA и хранить окно в SRAM/PSRAM.
- Плюсы:
  - минимальный RT-риск: fast/ISR делают O(1) запись в RAM без блокировок и без обращения к сервисным/внешним интерфейсам;
  - простая доказуемость и тестируемость (SPSC, явные деградации при переполнении);
  - естественная масштабируемость: новые источники почти всегда добавляются в `Trace`, high-rate остаётся отдельным `Scope`;
  - поддержка pre/post-trigger окон и работы с PSRAM по QSPI в slow task (см. `docs/design-notes/DN-005_QSPI_PSRAM_Oscilloscope_Buffer.md`).
- Минусы/риски:
  - требуется явная политика переполнения (drop + счётчики) и метрики заполнения;
  - в отсутствие “merge” на МК, упорядочивание между источниками обеспечивается на ПК по timestamp (или merge в slow task).

### Вариант C
- Идея: SPSC “буфер на модуль/источник” (N отдельных буферов), с индивидуальными квотами/политиками drop; consumer опрашивает N источников и формирует поток на ПК.
- Плюсы:
  - максимальная изоляция источников: “болтливый” модуль не вытесняет “критичный”;
  - проще квотирование и включение/выключение конкретных источников;
  - удобнее вводить разные глубины буферов (например, для отдельных диагностик).
- Минусы/риски:
  - рост сложности конфигурации и обслуживания (N буферов, N опросов, больше метаданных в RAM);
  - при росте числа источников усложняется доказательство нагрузки consumer и соблюдение бюджетов времени;
  - при малом числе источников даёт слабый выигрыш относительно “по контекстам” и может быть преждевременным усложнением.

## 4) Decision criteria (критерии выбора)
- Детерминизм fast-домена и минимизация джиттера (RT safety-by-design).
- Разделение ответственности: observability не влияет на shutdown-path и контур управления.
- Масштабируемость по источникам и типам данных (events vs high-rate samples).
- Простота верификации (unit + on-target измерения) и воспроизводимость.
- Ограничения пропускной способности USB-UART/PCcom4: невозможность “всегда стримить” сырые 400 кГц выборки.
- Возможность “best effort” диагностики вокруг fault (pre/post окна) при условии отсутствия влияния на safety.
- Дефолтное отключение наблюдаемости в штатном режиме.

## 5) Rationale (почему так)
- Вариант B удовлетворяет критериям детерминизма: fast/ISR не делают тяжёлых операций и не блокируются, что соответствует архитектуре “fast без RTOS / slow в RTOS” из `docs/PROJECT_CONTEXT.md`.
- Разделение `Trace` и `Scope` предотвращает неправильное смешение разных классов данных: события/параметры масштабируются как записи, а 400 кГц АЦП требует блочного DMA и оконного режима.
- Гибрид временных меток (`fast_seq` + `timestamp_ticks`) позволяет коррелировать домены и события на ПК без требования идеального “единого порядка” на МК.
- Выбор SPSC по контекстам снижает риск гонок по сравнению с MPSC и делает поведение при переполнении/ошибках управляемым (drop + счётчики).
- Включение сервиса через “одноразовую сессию до reset” даёт управляемый режим диагностики без постоянного сервисного обмена в штатной работе.

## 6) Consequences / Risks
- Позитивные последствия:
  - наблюдаемость совместима с RT и safety: не влияет на fast loop и аппаратный shutdown-path;
  - поддержка fault-ориентированной диагностики (окна pre/post) и анализа на ПК;
  - простое расширение источников `Trace` без переработки `Scope`.
- Негативные последствия/долг:
  - требуется реализовать и поддерживать таймбазу `timestamp_ticks` (переполнение, единицы измерения) и правила корреляции на ПК;
  - при переполнениях возможна потеря данных/триггеров (преднамеренная деградация), нужна видимость через счётчики;
  - вводится необходимость описать форматы `Scope.Data` и команду включения сервиса в проектном профиле PCcom4.
- Риски отказа/edge cases и как их обнаруживаем:
  - переполнение буферов Trace/Scope → `dropped_*` счётчики, watermark, диагностика через сервис;
  - ошибка QSPI/PSRAM → scope отключается/деградирует, фиксируются ошибки (без влияния на сварку);
  - активный захват + новый триггер → `dropped_triggers++`, фиксация последней причины;
  - сбой/рассинхронизация PCcom4 stream → CRC/ресинхронизация по правилам `docs/protocols/PCCOM4.02.md`, счётчики ошибок.

## 7) Interfaces / Data / Timing impact
- Интерфейсы/форматы/контракты:
  - `Trace`: единый формат записи (заголовок: `timestamp_ticks`, `fast_seq`, `source_id`, `event_id`, `len`, далее `payload[len]`), политика drop и счётчики.
  - `Scope`: метаданные блока DMA (например `t0_ticks`, `fast_seq0`, `sample_count`, `channel_count`, `reason`, `capture_id`), а сырые выборки — как массивы фиксированного типа (например u16).
  - PCcom4: использовать узел осциллографа `Node=0x06` (`Scope.StreamControl`, `Scope.Data`) из `docs/protocols/PCCOM4.02_PROJECT.md` и уточнить формат `Scope.Data`. Добавить/зафиксировать команду включения сервиса `Service.Enable` (узел/операция — TBD в проектном профиле).
- Влияние на тайминги/джиттер:
  - в fast/ISR допускается только O(1) запись в SRAM (включая чтение таймбазы); любые операции UART/QSPI/упаковка/CRC выполняются в slow task.
  - обязательны on-target измерения длительности и джиттера fast-пути в режимах OFF/ON (см. `docs/PROJECT_CONTEXT.md` про измерения джиттера и `docs/TEST_PLAN.md`).
- Обратная совместимость/миграция:
  - базовый транспорт и фрейминг PCcom4 сохраняются (см. `docs/protocols/PCCOM4.02.md`), изменения вносятся в проектный профиль `docs/protocols/PCCOM4.02_PROJECT.md`.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host:
  - тесты SPSC ring-buffer (push/pop, переполнение, wrap-around, счётчики drop);
  - тесты state machine `Scope` (IDLE → CAPTURING_POST → READY/UPLOAD, игнор триггеров, best-effort поведение).
- SIL:
  - (если применимо) воспроизведение логов/сценариев на модели времени, проверка отсутствия блокировок fast-пути при включённой наблюдаемости.
- On-target измерения (GPIO/осциллограф/trace):
  - измерить длительность/джиттер fast loop при OFF и при включённом Trace/Scope (включая чтение таймбазы);
  - измерить throughput записи/чтения PSRAM по QSPI и фактическую скорость выдачи по USB-UART.
- HIL/bench:
  - длительный прогон с активными захватами Scope и контролем отсутствия влияния на управление;
  - fault-injection: переполнение буферов, ошибки QSPI/PSRAM, ошибки/ресинхронизация PCcom4 stream, reset во время передачи.

### Rollback
- Быстрый откат: отключить наблюдаемость флагом/конфигурацией сборки и/или оставить только минимальный RX+парсер `Service.Enable`, сохранив прежние контуры управления и политику safety.
- Откат протокола: убрать/откатить изменения `docs/protocols/PCCOM4.02_PROJECT.md`, оставив совместимость с базовым `docs/protocols/PCCOM4.02.md`.

## 9) Status / Follow-ups
- Status: draft | accepted | implemented | obsolete
- Follow-ups: TODO список задач (если есть)
  - Определить источники `timestamp_ticks`/`fast_seq` (какой таймер, частота, переполнение) и правила корреляции на ПК.
  - Зафиксировать форматы `Scope.Data` и команду `Service.Enable` в `docs/protocols/PCCOM4.02_PROJECT.md`.
  - Реализовать минимальный always-on PCcom4 stream-парсер для приёма `Service.Enable` (RX-only до включения).
  - Реализовать Trace (SPSC по контекстам) и Scope (DMA blocks + SRAM pre + PSRAM capture + выгрузка пачками).
  - Обновить `docs/PROJECT_CONTEXT.md` (раздел про наблюдаемость) и `docs/TEST_PLAN.md`, чтобы явно отразить “default OFF” и план измерений/доказательств.
- Links: PR/commit/issue
