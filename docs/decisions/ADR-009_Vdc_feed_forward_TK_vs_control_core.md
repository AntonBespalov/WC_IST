# ADR-009_Vdc_feed_forward_TK_vs_control_core — Vdc feed-forward: ТК vs control_core

Статус: draft  
Дата: 2026-02-17  
Владелец: TBD  
Связано: `docs/PROJECT_CONTEXT.md`, `docs/GLOSSARY.md`, `docs/ARCHITECTURE.md`, `docs/ENGINEERING_CONTRACT.md`, `docs/TEST_PLAN.md`

---

## 1) Context / Problem
- Нужно выбрать место реализации Vdc feed-forward (компенсация просадки DC-link): в ТК (цикл 250 мкс) или в `control_core` (PWM-домен, fast loop).
- Проблема: просадка Vdc при резком росте тока возникает в масштабе микросекунд, а ТК узнает о ней не быстрее периода обмена 250 мкс + задержки стека, что может привести к заметному провалу тока.
- Ограничения/инварианты (нельзя нарушать):
  - safety-путь выключения силовой части остаётся аппаратным (`TIM1 BKIN/BKIN2`, при наличии `DRV_EN/INH`), без изменений;
  - fast loop остаётся детерминированным, O(1), без блокировок;
  - инвариант измерений: I/U — усреднённые по периоду PWM (см. `docs/PROJECT_CONTEXT.md` / «Тайминги»);
  - не вводить новых требований к протоколу ТК, если это не критически необходимо.
- Триггеры пересмотра решения:
  - период/задержка обмена с ТК уменьшатся до уровня одного периода PWM или меньше;
  - появится аппаратный/встроенный компенсатор DC-link на силовой части;
  - измерение Vdc станет доступно ТК без существенной задержки и с гарантированной валидностью;
  - выявится недопустимая чувствительность к шуму/ошибкам измерения Vdc в fast loop.

## 2) Decision (что выбрали)
- Выбранный вариант: **Вариант B** — Vdc feed-forward в `control_core` (PWM-домен).
- Scope: что меняем / что не меняем.
  - Меняем:
    - вводим коэффициент масштабирования управляющего воздействия по Vdc в fast loop;
    - добавляем параметр `v_dc_nominal` [В] в `control_cfg_t` (значение по умолчанию TBD, ориентир 540.0f).
  - Не меняем:
    - тайминги fast loop и аппаратный shutdown-path;
    - протокол ТК и формат обмена;
    - структуру аварий/latched fault-политику.

## 3) Options considered (варианты)
### Вариант A
- Идея:
  - Компенсация Vdc выполняется на стороне ТК: ТК пересчитывает команду и присылает уже скорректированное значение раз в 250 мкс.
- Плюсы:
  - Централизованный контроль и настройка на стороне ТК.
  - Нет дополнительных вычислений в fast loop.
- Минусы/риски:
  - Задержка минимум 250 мкс + стек, что сопоставимо или больше переходного процесса Vdc.
  - Зависимость качества регулирования от связи/джиттера обмена.
  - Потенциальный провал тока при быстрых просадках Vdc.

### Вариант B
- Идея:
  - В fast loop применяется feed-forward масштабирование управляющего воздействия по отношению `Vdc_nominal / Vdc_measured` до этапа ограничений.
- Плюсы:
  - Реакция в пределах следующего периода PWM.
  - Независимость от задержек EtherCAT/ТК.
  - Минимальные изменения интерфейсов и протокола.
- Минусы/риски:
  - Требуется контроль валидности/качества измерения Vdc.
  - Возможное усиление шума и риск неверного масштаба при ошибках измерения.

## 4) Decision criteria (критерии выбора)
- Латентность относительно периода PWM и динамики просадки Vdc.
- Детерминизм fast loop (O(1), без ухудшения WCET/джиттера).
- Safety-инварианты: сохранение аппаратного shutdown-path, корректная обработка невалидного Vdc.
- Минимизация изменений в протоколе/интерфейсе ТК.
- Проверяемость: возможность измерить эффект и доказать отсутствие регрессий.

## 5) Rationale (почему так)
- Вариант B обеспечивает компенсацию в следующем периоде PWM, что соответствует требуемой скорости реакции на микросекундные просадки Vdc; Вариант A слишком медленный из‑за 250 мкс цикла ТК.
- Вариант B не увеличивает зависимость качества регулирования от связи и остаётся устойчивым к джиттеру обмена.
- Вариант B требует минимальных изменений интерфейса (добавление `v_dc_nominal`), сохраняя существующий протокол ТК.
- Вариант A отклонён из‑за задержки и риска провалов тока при резких изменениях Vdc.

## 6) Consequences / Risks
- Позитивные последствия:
  - Повышается инвариантность “актуатора” к качеству питающей сети.
  - Снижается чувствительность к задержкам и джиттеру обмена с ТК.
  - Улучшается стабильность тока при резких просадках DC-link.
- Негативные последствия/долг:
  - Нужно обеспечить валидность измерения Vdc и определить поведение при ошибках/срывах измерений.
  - Добавляется новый параметр конфигурации, требующий управления и документирования.
- Риски отказа/edge cases и как их обнаруживаем (наблюдаемость/счётчики/логи):
  - `Vdc` залип/обрыв/сатурация → неверный масштаб: фиксировать флаги валидности/диапазона, вводить счётчики `vdc_invalid_count`.
  - Шум Vdc → дрожание duty: контролировать спектр/вариацию `duty` и `vdc_factor`.
  - Частые упоры в `u_max` → потеря линейности: логировать долю времени в насыщении (`u_sat_ratio`).

## 7) Interfaces / Data / Timing impact
- Какие интерфейсы/форматы/контракты меняются:
  - Внутренняя конфигурация: добавляется `control_cfg_t.v_dc_nominal` [В].
  - Внешний протокол ТК не меняется, если `v_dc_nominal` берётся из локальной конфигурации/дефолта.
- Влияние на тайминги/джиттер/бюджеты (если применимо) + что именно измерять:
  - Добавляется константное число операций (деление, умножение, сравнение) в fast loop; ожидается O(1) без изменения структуры периодов.
  - Измерять: `fast_loop_wcet`, `fast_loop_jitter`, долю времени в насыщении `u_max` до/после.
- Обратная совместимость/миграция (если применимо):
  - При `v_dc_nominal == Vdc_measured` (или `v_dc_factor = 1.0`) поведение эквивалентно текущему.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host:
  - проверка расчёта `vdc_factor` на крайних значениях: `Vdc=0`, `Vdc<10 В`, `Vdc=Vdc_nominal`, `Vdc` сильно выше/ниже нормы;
  - отсутствие NaN/Inf и корректная деградация к `vdc_factor = 1.0` при невалидном Vdc;
  - инвариант: результат остаётся в пределах `u_min/u_max` после clamp.
- SIL:
  - модельный сценарий “step Vdc drop” и сравнение отклика тока при compensation ON/OFF;
  - подтверждение восстановления тока не позднее 1–2 периодов PWM.
- On-target измерения (GPIO/осциллограф/trace):
  - вызвать резкую просадку Vdc (ступенчатая нагрузка), измерить `Vdc`, `duty`, `I_weld`;
  - критерий: уменьшение провала тока по сравнению с baseline и восстановление в пределах 1–2 периодов PWM;
  - подтвердить отсутствие ухудшения `fast_loop_wcet/jitter` и отсутствие влияния на `BKIN`-реакцию.
- HIL/bench:
  - fault-injection (минимум 5):
    1) `Vdc` залипает на 0 В;
    2) `Vdc` залипает на завышенном значении;
    3) пропуски/timeout измерений `Vdc`;
    4) шумовое “дрожание” `Vdc` в пределах 5–10%;
    5) резкие ступени `Vdc` 10–20% при активной сварке;
  - ожидаемое: корректная деградация к безопасному поведению (clamp/feature off/diagnostics), отсутствие неконтролируемого роста duty.

### Rollback
- Отключить feed-forward, установив `vdc_factor = 1.0` (фича‑флаг/конфигурация).
- Вернуть поведение без компенсации, сохранив остальную логику fast loop без изменений.

## 9) Status / Follow-ups
- Status: draft
- Follow-ups: TODO список задач (если есть)
  - Обновить `docs/ARCHITECTURE.md` (позиционирование feed-forward в fast loop) после принятия решения.
  - Добавить в `docs/TEST_PLAN.md` отдельный набор тестов “Vdc droop compensation”.
  - Уточнить источник и политику установки `v_dc_nominal` (локальный дефолт или параметр ТК).
- Links: PR/commit/issue
