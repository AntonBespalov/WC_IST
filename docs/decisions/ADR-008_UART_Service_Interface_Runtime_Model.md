# ADR-008_UART_Service_Interface_Runtime_Model — Работа по сервисному интерфейсу UART (PCcom4)

Статус: draft  
Дата: 2026-02-16  
Владелец: TBD  
Связано: `docs/PROJECT_CONTEXT.md`, `docs/ARCHITECTURE.md`, `docs/protocols/PCCOM4.02.md`, `docs/protocols/PCCOM4.02_PROJECT.md`, `docs/protocols/PROTOCOL_TK_ETHERCAT.md`, `docs/decisions/ADR-003_TK_EtherCAT_PDO_Emu_Over_UDP_Batching.md`, `docs/decisions/ADR-004_TK_Interface_EtherCAT_COMX_FMC_and_UART_PDO_Emu.md`, `docs/decisions/ADR-005_Observability_Trace_Scope_and_Service_Enable.md`

---

## 1) Context / Problem
- Нужно зафиксировать целевую runtime-модель сервисного интерфейса `USB-UART + PCcom4` для задач:
  - настройка параметров и commit во flash,
  - сервисные режимы (`ManualDuty`, `SelfTest`),
  - dev-эмуляция `TkPdo.Emu.*`,
  - наблюдаемость/осциллограф (`Scope.*`).
- Ограничения/инварианты (нельзя нарушать):
  - fast loop и async fault-path остаются детерминированными; UART-сервис не должен блокировать PWM-домен;
  - критический stop силовой части остаётся аппаратным (`BKIN/BKIN2`, при наличии `DRV_EN/INH`);
  - команды, влияющие на энергию/ШИМ/flash, должны быть gated условиями безопасности (`IDLE`, подтверждённый `PWM OFF`, без активного latched fault).
- В проекте уже принято: основной обмен с ТК идёт по EtherCAT PDO (COMX/FMC), сервис с ПК идёт по PCcom4 поверх UART.
- Проблема: без явной runtime-политики (кто/где парсит, какие операции разрешены по умолчанию, как деградируем при перегрузке) возрастает риск нарушения RT/safety при внедрении сервиса.
- Сигналы, что решение устарело:
  - требуется детерминированный цикл уровня 250 мкс по сервисному каналу Windows-host;
  - требуется транспорт сервиса не UART/PCcom4;
  - вводятся требования аутентификации/ролевого доступа для сервисных команд.

## 2) Decision (что выбрали)
- Выбранный вариант: **Вариант A**.
- Scope: что меняем / что не меняем.
  - Меняем:
    - вводим явную runtime-модель “always-on RX, gated service session”;
    - парсер PCcom4 и диспетчер команд выполняются в slow task-контексте; ISR/DMA только доставка байтов в буфер;
    - вводим классы команд: `read-only`, `service-control`, `energy-affecting`, `flash-affecting` с разными условиями допуска;
    - фиксируем backpressure-политику TX (drop/decimation + счётчики), чтобы сервис не влиял на fast loop.
  - Не меняем:
    - контур управления током (PWM-домен), аппаратный shutdown-path, политику latch/recovery;
    - статус EtherCAT как основного интерфейса ТК.

## 3) Options considered (варианты)
### Вариант A
- Идея:
  - UART RX и stream-ресинхронизация всегда активны, но по умолчанию доступен только безопасный минимум операций.
  - Сервисная сессия включается явно (`Service.Enable`), действует до reset/disable.
  - Команды `ManualDuty`, `TkPdo.Emu.CmdWeld`, запись параметров/flash допускаются только после safety-gating и с отдельными watchdog/таймаутами по профилю.
  - Все тяжёлые операции (CRC, парсинг payload, валидация, сериализация TX, scope) выполняются вне fast/ISR.
- Плюсы:
  - Минимальный риск влияния на RT-домены.
  - Сохраняется совместимость с PCcom4-профилем и существующими узлами.
  - Явная деградация при перегрузке: drop + метрики качества.
- Минусы/риски:
  - Больше состояний и правил gating (нужны тесты матрицы допусков).
  - Нужен строгий контроль таймаутов/счётчиков качества связи.

### Вариант B
- Идея:
  - Полнофункциональный сервис всегда активен (RX/TX/команды без отдельной сессии), часть логики допускается в прерываниях ради минимальной задержки.
- Плюсы:
  - Простая операторская модель (“подключился и работаешь”).
  - Ниже задержка реакции на отдельные сервисные команды.
- Минусы/риски:
  - Повышенный риск джиттера/overrun fast loop.
  - Сложнее доказать, что сервис не деградирует safety и timing.
  - Выше вероятность ошибок от несанкционированных/случайных сервисных операций в нештатный момент.

### Вариант C
- Идея:
  - Сервисный UART доступен только в отдельной debug-сборке; в production прошивке отключён.
- Плюсы:
  - Минимальный runtime-риск в production.
  - Упрощение части safety-обоснований в боевом режиме.
- Минусы/риски:
  - Расхождение debug/prod поведения и рост интеграционного риска.
  - Потеря сервисопригодности на стенде/в эксплуатации без перепрошивки.

## 4) Decision criteria (критерии выбора)
- Safety: не нарушать аппаратный shutdown-path и gating для “энергетических”/flash-команд.
- RT: отсутствие влияния на fast loop и критичные ISR, контролируемый WCET slow task.
- Протокольная совместимость: использование каноники PCcom4 и проектного профиля без “второго протокола”.
- Наблюдаемость: наличие метрик качества канала/перегрузки/таймаутов для диагностики.
- Сопровождаемость: одна модель поведения для dev/bench/prod без расхождения прошивок.

## 5) Rationale (почему так)
- Вариант A лучше всего удовлетворяет safety и RT-критериям: критичный путь остаётся аппаратным, а сервисная нагрузка изолируется в slow task.
- Вариант A согласуется с уже принятыми направлениями проекта:
  - EtherCAT как основной интерфейс ТК;
  - PCcom4 как сервисный протокол поверх UART;
  - default-off для “тяжёлой” наблюдаемости при always-on приёме управляющих сервисных команд.
- Вариант B отвергнут из-за повышенного риска деградации таймингов и усложнения доказательств.
- Вариант C отвергнут из-за операционного долга и расхождения поведения между debug/prod.

## 6) Consequences / Risks
- Позитивные последствия:
  - единая и воспроизводимая модель сервиса UART для всех режимов стенда/отладки;
  - снижение вероятности случайного включения опасных сервисных операций;
  - прозрачная диагностика качества канала через счётчики/флаги.
- Негативные последствия/долг:
  - требуется поддерживать state machine сервисной сессии и матрицу допусков операций;
  - требуется дисциплина по бюджетам времени slow task и политике backpressure.
- Риски отказа/edge cases и как их обнаруживаем (наблюдаемость/счётчики/логи):
  - flood входящего UART-потока: `rx_overflow`, `rx_crc_err`, `parser_resync_count`, `cmd_reject_count`;
  - зависание/пауза host-приложения: `watchdog_trip`, переход в safe state по политике timeout;
  - попытка flash/energy-команды в запрещённом состоянии: `gating_reject_count` + код причины в ответе;
  - перегрузка TX-выгрузки scope/log: `tx_drop_count`, `scope_drop_count`, watermark буферов.

## 7) Interfaces / Data / Timing impact
- Какие интерфейсы/форматы/контракты меняются:
  - Транспорт остаётся `USB-UART + PCcom4` (без нового wire-протокола).
  - Фиксируется runtime-контракт допуска операций:
    - `read-only` операции доступны всегда;
    - `service-control` (включение сессии) доступны всегда;
    - `energy-affecting` (`ManualDuty.*`, `TkPdo.Emu.*`) и `flash-affecting` доступны только при выполнении safety-gating.
  - Для сессии вводится явный флаг состояния (`service_session_active`) и причины отказа для отклонённых команд.
- Влияние на тайминги/джиттер/бюджеты (если применимо) + что именно измерять:
  - ISR/DMA: только приём байтов и уведомление задачи (без CRC/валидации payload).
  - slow task (1 мс домен): разбор кадров, валидация, dispatch, формирование ответов.
  - fast loop (PWM-домен): не изменяется; команды применяются через уже существующий механизм “последняя валидная на границе периода PWM”.
  - Измерять: `fast_loop_wcet`, `fast_loop_jitter`, `service_task_wcet`, `cmd_age_us`, `rx_overflow`, `tx_drop_count`.
- Обратная совместимость/миграция (если применимо):
  - Базовый фрейминг PCcom4 сохраняется.
  - Для ПК-инструментов требуется поддержка явного шага `Service.Enable` и обработки кодов отказа по gating.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host:
  - парсер stream: частичные кадры, ресинхронизация, CRC16, неверный `DataLen`;
  - матрица допусков команд по состояниям (`IDLE/ARMED/WELD/FAULT`, `service_session_active`, `PWM OFF/ON`);
  - watchdog/timeout логика для `ManualDuty` и `TkPdo.Emu.*`;
  - backpressure policy: корректная инкрементация счётчиков drop/overflow без блокировок.
- SIL:
  - модель событий “burst RX + active control loop” с проверкой, что fast path не блокируется;
  - сценарии “валидная команда → latch/apply → статус” с проверкой `seq`/`cmd_age_us`.
- On-target измерения (GPIO/осциллограф/trace):
  - сравнить `fast_loop_wcet/jitter` при `UART service OFF` и при стресс-трафике UART (flood);
  - подтвердить, что `cnt_ctrl_overrun` не растёт в стресс-сценариях;
  - измерить `COMX_IRQ → CMD_LATCHED` в EtherCAT-домене под одновременной нагрузкой UART и подтвердить соответствие цели 250 мкс;
  - подтвердить, что `BKIN_RAW → PWM_OUT safe` не деградирует при активном сервисе UART.
- HIL/bench:
  - fault-injection (минимум 5):
    1) отключение USB-UART/пауза host-приложения 50–200 мс при активном `ManualDuty`,
    2) поток битых CRC/мусора в UART stream,
    3) burst валидных команд выше возможностей обработки,
    4) попытка `FlashCommit` в `ARMED/WELD` (должен быть reject),
    5) out-of-order/replay `seq` для `TkPdo.Emu.CmdWeld`,
    6) TX-backpressure (ПК не читает порт) при активном `Scope.Stream`.
  - ожидаемое: корректный safe stop по таймаутам, валидные коды отказа, отсутствие влияния на критичный shutdown-path и fast loop.

### Rollback
- Отключить mutating-команды сервиса feature-flag’ом, оставив только `read-only` диагностику.
- Временно отключить `ManualDuty`/`TkPdo.Emu.*` на UART, сохранив EtherCAT как единственный источник команд.
- Вернуть предыдущую версию runtime-политики сервиса без изменения аппаратного shutdown-path и fast loop.

## 9) Status / Follow-ups
- Status: draft
- Follow-ups: TODO список задач (если есть)
  - Зафиксировать в `docs/protocols/PCCOM4.02_PROJECT.md` операцию `Service.Enable/Disable`, коды `gating reject` и флаг `service_session_active`.
  - Уточнить в `docs/ARCHITECTURE.md` бюджет `service_task_wcet` и точки инструментирования (`DBG0/DBG1` профили).
  - Добавить в `docs/TEST_PLAN.md` отдельный набор тестов “UART flood + EtherCAT load + safety invariants”.
  - Синхронизировать `docs/PROJECT_CONTEXT.md` (разделы интерфейсов/наблюдаемости) с финальной политикой сессии сервиса.
- Links: PR/commit/issue
