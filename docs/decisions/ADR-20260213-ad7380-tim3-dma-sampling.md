# ADR-20260213-ad7380-tim3-dma-sampling — AD7380 sampling via TIM3 PWM + DMA (100 samples per PWM period)

Статус: draft  
Дата: 2026-02-13  
Владелец: Антон  
Связано: MFDC fast-loop (TIM1), AD7380 bring-up, измерение I_weld/U_weld  

---

## 1) Context / Problem
Необходимо реализовать равномерную дискретизацию вторичных тока и напряжения
(I_weld и U_weld) через AD7380 (2-wire режим) внутри одного периода ШИМ MFDC-инвертора.

Текущие требования:
- Частота ШИМ (TIM1): 4 кГц → период 250 мкс.
- Количество выборок за период: 100.
- Частота семплирования: 400 кГц (шаг 2.5 мкс).
- 16 бит данных на канал.
- Минимальный джиттер и отсутствие нагрузки CPU на частоте 400 кГц.

Инварианты:
- Регулятор вызывается 1 раз на период PWM (детерминизм).
- Кадрирование AD7380 должно быть корректным (CS LOW во время 16 тактов SCK).
- SPI2 (slave) должен принимать строго синхронно с SPI1.

Сигналы пересмотра решения:
- Изменение числа выборок (например, 500 вместо 100).
- Переход на другую частоту PWM.
- Замена МК или АЦП.

---

## 2) Decision (что выбрали)

Выбран вариант:
**TIM3 (PWM CH2) генерирует CS, TIM3_UP инициирует DMA-запрос,
DMA пишет 16-бит dummy в SPI1->TXDR, что запускает генерацию 16 тактов SCK.**

Архитектура:

Схема:
TIM1 period start
    ↓ (TRGO)
TIM3 reset → CNT=0
    ↓
CS LOW начинается
    ↓
TIM3_UP
    ↓
DMA пишет 1 слово в SPI1->TXDR
    ↓
SPI1 генерит 16 SCK
    ↓
SPI1_RX + SPI2_RX DMA забирают данные
    ↓
CS остаётся LOW ещё ~0.3 мкс запаса
    ↓
CS HIGH


- TIM1 → TRGO(Update) → TIM3 Reset Mode (синхронизация начала периода).
- TIM3:
  - Частота 400 кГц.
  - CH2 = PWM Generation.
  - Polarity = Low (CS активный LOW).
  - Pulse ≈ 320 тиков (~1.8 мкс LOW).
- DMA:
  - TIM3_UP → Memory-to-Peripheral → запись в SPI1->TXDR.
  - SPI1_RX DMA → приём SDO_A.
  - SPI2_RX DMA → приём SDO_B.

Scope:
- Меняется механизм съёма данных AD7380.
- Не меняется fast-loop контракт (1 вызов на период).
- Не меняются CAN/протоколы.

---

## 3) Options considered

### Вариант A — Прерывание таймера 400 кГц
Идея: запуск SPI/DMA в IRQ TIM3.

Плюсы:
- Простая логика.

Минусы/риски:
- Высокая нагрузка CPU.
- Джиттер от входа/выхода из IRQ.
- Риск пропусков при высокой загрузке.

### Вариант B — Аппаратный NSS от SPI
Идея: использовать SPI master NSS pulse.

Плюсы:
- Меньше таймеров.

Минусы:
- Сложнее контролировать длительность CS.
- Менее гибко для фазовой синхронизации с PWM.

### Вариант C — TIM3 PWM + TIM3_UP → DMA (выбранный)
Плюсы:
- Нулевой CPU-overhead на семпл.
- Фиксированная фаза относительно PWM.
- Полный контроль окна CS.

Минусы:
- Более сложная конфигурация (таймер + 3 DMA).

---

## 4) Decision criteria

- Равномерная сетка выборок.
- Минимальный джиттер.
- Нулевая нагрузка CPU на частоте Fs.
- Корректное кадрирование AD7380.
- Простота масштабирования (100 → 500 точек).

---

## 5) Rationale (почему так)

TIM3_UP совпадает с началом периода таймера (CNT=0),
что соответствует началу CS-LOW (PWM mode 1 + Polarity=Low).

Таким образом:
- DMA запускается строго в начале CS-LOW.
- SPI1 генерирует 16 тактов внутри окна CS.
- SPI2 slave синхронно принимает второй канал.
- Регулятор остаётся детерминированным.

Отказ от IRQ устраняет джиттер и экономит CPU.

---

## 6) Consequences / Risks

Позитивные:
- Детерминированная дискретизация.
- Низкая нагрузка CPU.
- Масштабируемость.

Негативные:
- Требования к разводке (SCK, CS, SDOB).
- Необходим строгий порядок старта DMA.

Риски:
- Если DMA событие выбрано TIM3_CH2 вместо TIM3_UP — SCK выйдет за пределы CS.
- Если SPI2 не взведён до первого кадра — потеря старших бит.
- Если ARR неверно рассчитан — будет не 100 точек.

Наблюдаемость:
- Осциллограф: CS и SCK.
- Проверка 16 тактов на каждый CS LOW.
- Счётчик принятых слов за период.

---

## 7) Interfaces / Data / Timing impact

Интерфейсы:
- PE3 → CS AD7380 → перемычка → PB12 (SPI2_NSS).
- PA5 → SCK → перемычка → PB13.
- PA6 ← SDO_A.
- PB15 ← SDO_B.
- PB14 не используется.

Тайминги:
- PWM: 4 кГц.
- Семплирование: 400 кГц.
- CS LOW ≈ 1.8 мкс.
- 16 SCK внутри LOW.

Обратная совместимость:
- Внешние интерфейсы не меняются.

---

## 8) Tests / Proof / Evidence / Rollback

### Tests / Proof / Evidence
- Unit: проверка вычисления I_per, U_per.
- SIL: проверка вызова регулятора 1 раз на период.
- On-target:
  - Осциллограф CS/SCK.
  - Проверка ровно 100 кадров.
- HIL:
  - Проверка устойчивости при сварочном токе.

### Rollback
- Вернуться к IRQ-методу (вариант A).
- Уменьшить частоту Fs.

---

## 9) Status / Follow-ups

Status: draft

Follow-ups:
- Проверить TIM3 ARR на точные 400 кГц.
- Проверить порядок запуска SPI2_RX DMA перед первым циклом.
- Добавить счётчик кадров на период PWM.

Links: TBD
