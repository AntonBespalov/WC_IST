# ADR-007 — Logging windowed via PSRAM + UART

Статус: draft  
Дата: 2026-02-13  
Владелец: Anton Bespalov  
Связано: —  

---

## 1) Context / Problem
- Нужно передавать по сервисному интерфейсу (FT232H UART) три потока: PDO-эмуляция (PCcom4), внутренние переменные контура, сырые данные AD7380.
- UART 10 МБод 8N1 даёт примерно 1.0 MB/s полезных данных, что меньше потока ADC (≈1.6 MB/s), поэтому непрерывный стрим невозможен.
- Окно захвата: 10 мс до + 200 мс после (≈0.35–0.40 MB), допускается выгрузка после события.
- SRAM ограничен, поэтому нужен внешний буфер PSRAM APS6404L-3SQR-SN.
- Инвариант PSRAM: tCEM = 8 мкс (CE# low pulse width). Требуется поднимать CE# после операций; нельзя держать CE# низким дольше.

## 2) Decision (что выбрали)
- Выбран вариант оконного логирования: pre-ring в SRAM + post-window в PSRAM, выгрузка по UART после события.
- PSRAM доступ через QSPI indirect + DMA, транзакции чанками с контролем tCEM (стартовый чанк 256 B при 84 MHz, уточняется измерениями).
- Триггеры окна: команда с ПК, старт сварки, факт fault.

## 3) Options considered (варианты)
### Вариант A
- Идея: непрерывный UART-стрим.
- Плюсы: простота.
- Минусы/риски: не проходит по полосе (1.0 MB/s vs 1.6 MB/s), риск потерь и влияния на RT.

### Вариант B
- Идея: окно + PSRAM + UART (chosen).
- Плюсы: соблюдение RT, полоса хватает при post-выгрузке, контроль tCEM.
- Минусы/риски: задержка выгрузки (~0.35–0.45 с на окно), ограничение частоты событий.

### Вариант C
- Идея: memory-mapped PSRAM.
- Плюсы: удобный доступ.
- Минусы/риски: риск нарушения tCEM и блокировки refresh, хуже контролируется CE#.

## 4) Decision criteria (критерии выбора)
- Соблюдение RT-ограничений (ISR/DMA только O(1)).
- Пропускная способность UART и целостность данных.
- Строгое соблюдение tCEM и требований CE#.
- Минимальные изменения в контурах управления.

## 5) Rationale (почему так)
- Вариант B удовлетворяет полосе при оконном подходе и не трогает критичные RT-пути.
- Вариант A отклонён из-за недостаточной полосы.
- Вариант C отклонён из-за риска нарушения tCEM.

## 6) Consequences / Risks
- Позитивные последствия: стабильное окно диагностики, отсутствие блокировок ISR.
- Негативные последствия/долг: пост-выгрузка занимает ~0.4 с, серия частых событий может накапливать очередь.
- Риски отказа/edge cases и как их обнаруживаем: переполнение PSRAM-кольца и недовывод по UART; обнаружение по счётчикам drop/backlog.

## 7) Interfaces / Data / Timing impact
- Добавляются кадры логирования поверх PCcom4: PDO, control-vars, ADC-raw.
- Формат кадров: заголовок type/seq/timestamp/len/flags + payload.
- Тайминги: QSPI транзакции чанками < tCEM, UART DMA пост-событийно.
- Обратная совместимость: базовый сервисный канал остаётся, добавляются новые типы кадров.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host: —  
- SIL: —  
- On-target измерения (GPIO/осциллограф/trace): измерить CE# low time и подтвердить tCEM; подтвердить размер окна и целостность данных; измерить время выгрузки UART.  
- HIL/bench: —  

### Rollback
- Отключение оконного логирования флагом/конфигом, возврат к минимальному PDO.

## 9) Status / Follow-ups
- Status: draft
- Follow-ups: определить точную f_qspi, уточнить chunk_size по измерениям, оценить максимальную частоту событий.
- Links: —
