# ADR-20260209 — Выбор MCU: STM32G474 vs STM32H723

Статус: draft  
Дата: 2026-02-09  
Владелец: Bespalov  
Связано: TBD (issue/PR/commit/links)  

---

## 1) Context / Problem
- Нужно выбрать целевую платформу (МК) для проекта источника сварочного тока: продолжать на **STM32G474** (текущая платформа по `docs/PROJECT_CONTEXT.md`) или перейти на **STM32H723**.
- Решение влияет на:
  - распределение пинов и доступность периферии,
  - детерминизм fast loop (PWM/измерения/регулятор),
  - риски интеграции DMA (особенно для SPI-трактов АЦП),
  - сложность портирования/валидации и объём доказательств.
- Исходные данные по pinout (как отправная точка, допускаются изменения pinmap):
  - `docs/g474_cubemx/uspf_421243_064.{ioc,txt}`
  - `docs/h723_cubemx/uspf_421243_064_nucleo.{ioc,txt}` (вариант под Nucleo; не является “финальной платой”, но показывает осуществимость распределения ресурсов).
- Ограничения/инварианты, которые нельзя нарушать (см. `docs/PROJECT_CONTEXT.md` / разделы 2, 4–6 и `docs/ARCHITECTURE.md` / P2–P3):
  - **Аппаратный shutdown-path** для критических аварий: TIM1 **BKIN/BKIN2**, целевая реакция микросекундного масштаба (проверяется измерением).
  - Архитектура “fast loop без RTOS + slow loop FreeRTOS”; критичный контур не должен зависеть от планировщика.
  - Контракт таймингов: шаг управления **1 раз на период PWM** (1–4 кГц) + обмен с ТК **1 мс** по CAN FD.
  - Нет авто-рестарта после критического fault (latched-off до явного recovery).
  - Нельзя “варить вслепую”: устойчиво невалидные измерения ⇒ запрет сварки.
- Триггеры пересмотра решения:
  - появляется требование на интерфейсы/пропускную способность, которые рациональнее делать на H7 (например, Ethernet/большой объём высокоскоростного логирования/сложная обработка сигналов),
  - обнаруживается, что G474 не закрывает по ресурсам (Flash/RAM/CPU) или по pinout без значимого усложнения,
  - по итогам прототипа на H723 выявляются неприемлемые риски (cache/DMA coherency, джиттер) либо, наоборот, демонстрируется сопоставимый детерминизм при меньших ограничениях.

## 2) Decision (что выбрали)
- Выбранный вариант: **Вариант A — STM32G474 как основная платформа проекта** (baseline), STM32H723 — как исследовательская/резервная опция при появлении новых требований.
- Scope: это ADR фиксирует критерии выбора, сравнение и риски. **Код/схема/тайминги не меняются** в рамках этого ADR.

## 3) Options considered (варианты)
### Вариант A
- Идея: оставить целевым МК **STM32G474**, как зафиксировано в `docs/PROJECT_CONTEXT.md`, и довести проект на этой платформе.
- Плюсы:
  - Минимальный риск относительно текущего Ground Truth: контекст/архитектура/тайминги уже описаны под G474.
  - Более простая модель детерминизма для RT-контуров: отсутствие проблем cache-coherency для DMA-буферов (важно для SPI+DMA внешних АЦП).
  - Уже есть начальное распределение пинов (CubeMX экспорт) и оно покрывает ключевые блоки (TIM1 + SPI1/3/4 + safety-пины).
- Минусы/риски:
  - Меньший запас по CPU/Flash/RAM для будущих “тяжёлых” функций (расширенная диагностика, большие логи, сложная обработка).
  - Меньше GPIO/периферии “на будущее”; pinout может стать тесным при росте требований.

### Вариант B
- Идея: перейти на **STM32H723** (Cortex‑M7, больше ресурсов и периферии), перенося архитектуру fast/slow loop без изменения safety-инвариантов.
- Плюсы:
  - Существенно больше ресурсов (CPU/память/пины) → больше headroom для диагностики/логирования/алгоритмов, потенциально проще трассировка проблем.
  - По экспортам CubeMX видно, что TIM1 + SPI1/2/3/4 + BKIN/BKIN2 без конфликтов размещаются; дополнительно возможно задействовать Ethernet (RMII) при необходимости.
- Минусы/риски:
  - Риск **cache/DMA coherency** (критично для SPI+DMA и любых буферов измерений/логов): потребуется дисциплина размещения буферов, MPU-настройка и/или явное обслуживание кэша, плюс отдельный план доказательства отсутствия “тихой” порчи данных.
  - Более сложный bring-up и портирование (другая линейка HAL, больше доменов тактирования/питания, больше мест для ошибок конфигурации).
  - Рост объёма верификации таймингов/джиттера: требуется подтвердить на железе, что fast loop и fault path детерминированы (см. критерии).

## 4) Decision criteria (критерии выбора)
- Safety: сохранение аппаратного shutdown-path (BKIN/BKIN2) и политики latch/recovery.
- Детерминизм: предсказуемое время выполнения шага управления и отсутствие неконтролируемого джиттера (fast loop).
- Надёжность трактов измерений: корректность данных SPI+DMA (AD7380, 2×AD7606), отсутствие “тихих” ошибок из-за памяти/кэшей.
- Периферия и пины: возможность разместить TIM1 (CHx/CHxN + BKIN/BKIN2), SPI, CAN FD, UART(PCcom4), watchdog/debug GPIO, входы fault драйверов.
- Инженерный риск/стоимость: объём портирования/отладки, сложность конфигурирования, вероятность регрессий.
- Расширяемость: запас по ресурсам и интерфейсам на будущие требования (логирование, диагностика, дополнительные интерфейсы).

## 5) Rationale (почему так)
- Почему выбран Вариант A:
  - Проект по Ground Truth уже “заточен” под G474; смена платформы сейчас добавляет риски без явной необходимости по требованиям.
  - Для fast loop и внешних АЦП по SPI+DMA критичны предсказуемость и простота модели памяти; у H723 основные риски — cache/DMA coherency и усложнение доказательств.
  - По представленным pinout (CubeMX экспортам) критичные функции (TIM1 PWM + BKIN/BKIN2, SPI3/SPI4, safety GPIO) реализуемы на обеих платформах, поэтому решающим фактором становится риск/стоимость доказательства, а не “возможность в принципе”.
- Почему отвергнут Вариант B (на данном этапе):
  - Требует отдельного плана и дисциплины по cache/DMA, а значит повышает вероятность труднообнаружимых ошибок (особенно в измерениях) и увеличивает объём доказательств таймингов.
  - Потребует пересборки/перепроверки platform HAL и конфигураций, что отодвигает фокус от ключевой задачи проекта (устойчивый контур управления + safety).

## 6) Consequences / Risks
- Позитивные последствия:
  - Снижается риск “размазать” сроки и доказательства на перенос платформы; можно быстрее прийти к измеримому результату на текущей архитектуре.
  - Меньше классов ошибок вида “всё работает, но иногда” (типично для проблем согласованности DMA/кэш).
- Негативные последствия/долг:
  - Если появятся требования на большой объём логирования/сложные алгоритмы/новые интерфейсы, может понадобиться оптимизация на G474 или пересмотр платформы.
  - Решение держит “в голове” альтернативу H723, но не закрывает её доказательствами (перенос остаётся будущей работой).
- Риски отказа/edge cases и как их обнаруживаем (наблюдаемость/счётчики/логи):
  - Риск нехватки ресурсов G474 (CPU/RAM/Flash) → измерять CPU load fast/slow loop, вести счётчики overrun и буферные watermark’и (см. `docs/ARCHITECTURE.md` / наблюдаемость).
  - Риск pinout-конфликтов при росте требований → поддерживать “матрицу интерфейсов” и периодически прогонять CubeMX pinout review перед фиксацией платы.

## 7) Interfaces / Data / Timing impact
- Контракты интерфейсов/таймингов **не меняются** (см. `docs/PROJECT_CONTEXT.md`):
  - PWM: TIM1, 1–4 кГц, шаг управления 1/период.
  - CAN FD к ТК: период 1 мс; таймауты по политике.
  - PCcom4 по USB-UART (FT232H) для логов/осциллографирования.
- Сопоставление ключевых сигналов по CubeMX экспортам (как отправная точка):

| Функция | G474 pinout (`docs/g474_cubemx/...txt`) | H723 pinout (`docs/h723_cubemx/...txt`) | Комментарий |
|---|---|---|---|
| TIM1_CH1 / CH1N | PC0 / PC13 | PA8 / PB13 | PWM комплементарные |
| TIM1_CH2 / CH2N | PC1 / PB0 | PE11 / PB0 | PWM комплементарные |
| TIM1_BKIN / BKIN2 | PB10 / PC3 | PE15 / PG4 | Аппаратный shutdown-path |
| SPI3 (AD7606#1) SCK/MISO/MOSI | PC10/PC11/PC12 | PC10/PC11/PB2 | NSS/CS не зафиксирован в G474 экспортe |
| SPI4 (AD7606#2) SCK/MISO/MOSI | PE2/PE5/PE6 | PE2/PE5/PE6 | Совпадает |
| SPI1 (AD7380) SCK/MISO/MOSI/NSS | PA5/PA6/PA7/PA4 | PG11/PA6/PD7/PA15 | У H723 NSS на JTDI pin — требует внимания к отладке |
| AD7606 BUSY/CONVST (пример) | PB9/PD2/PD3 | PB6/PB5/PB7 | По H723 экспортe также есть AD7606_CS1/2 (PG14/PG13) |
| AD7380 CS1/CS2 (пример) | PB7/PB6 | PB9/PB8 | |
| SKYPER ERROUT1/2, ERRIN | PA9/PA8, PC9 | PD13/PD12, PD11 | Имена сигналов уточняются по схеме |
| EXTWDG_OUT | PC2 | PC9 | |
| COMX reset/irq | PA1/PA0 | PC6/PC8 | По H723 экспортe помечено как COMX100_* |

- Замечания:
  - В предоставленном H723 экспортe **не отражены** CAN FD и UART под PCcom4: при серьёзном рассмотрении H723 требуется донастроить CubeMX и проверить pin-матрицу под FDCAN + USART + debug.
  - Для H723 нужно заранее заложить правила для DMA буферов измерений/логов (размещение/MPU/cache maintenance), иначе невозможно честно подтвердить инвариант “не варим вслепую” из-за риска тихих ошибок данных.

## 8) Tests / Proof / Evidence / Rollback
### Tests / Proof / Evidence
- Unit/host:
  - N/A для выбора МК на уровне ADR (это документальное решение). Рекомендация: иметь host-тесты core-модулей независимо от платформы (см. `docs/ARCHITECTURE.md` / 4.1).
- SIL:
  - N/A для данного ADR. (SIL важен для алгоритмов, но не доказывает риски cache/DMA на H7.)
- On-target измерения (GPIO/осциллограф/trace):
  - N/A для принятия **этого** ADR (по выбранному Done/Proof). Если платформа будет пересмотрена на H723 — обязательны замеры джиттера control_tick и задержки shutdown-path (BKIN_RAW→PWM_OUT) по `docs/PROJECT_CONTEXT.md`.
- HIL/bench:
  - N/A для данного ADR. При переносе на H723 требуется отдельный план fault-injection, включая сценарии “искажение/повреждение DMA буфера” и “джиттер fast loop”.

### Rollback
- Т.к. это документальное решение, откат = пометить ADR как `obsolete` и принять альтернативный вариант.
- До “заморозки” платы сохранять оба CubeMX проекта как артефакты сравнения; решение пересматривается при срабатывании триггеров (раздел 1).

## 9) Status / Follow-ups
- Status: draft | accepted | implemented | obsolete
- Follow-ups: TODO список задач (если есть)
  - Дополнив `docs/h723_cubemx/...ioc`, включить FDCAN + UART (PCcom4) и выпустить обновлённый экспорт pinout для честного сравнения по интерфейсам проекта.
  - Сформировать “матрицу интерфейсов” (требование → периферия → пины) и держать её актуальной при добавлении новых функций.
  - Если появится потребность в H723: отдельный документ/ADR по правилам DMA+cache (MPU regions, non-cacheable buffers, доказательства корректности).
- Links: PR/commit/issue
