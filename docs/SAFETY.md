# Safety / Functional Safety (проектная политика)

Этот документ фиксирует проектные правила безопасного поведения источника сварочного тока:
- что считается безопасным состоянием,
- какие классы аварий существуют и как они обрабатываются,
- как устроен shutdown-path (в т.ч. аппаратный),
- как работает latch/recovery,
- какие доказательства (tests/proof) обязательны.

Источники правды:
- `docs/PROJECT_CONTEXT.md` — железо/тайминги/пины/интерфейсы
- `docs/GLOSSARY.md` — определения терминов
- `docs/ARCHITECTURE.md` — модульные границы (кто имеет право “разрешить сварку”)

---

## 1) Safety objectives (что защищаем)
O1) Не допустить неконтролируемого формирования сварочного тока.
O2) Любая критическая авария приводит к безопасному состоянию с предсказуемой задержкой.
O3) Зависание МК/RTOS не оставляет силовую часть включённой.
O4) Потеря связи/невалидные команды/невалидные измерения не приводят к “варке вслепую”.
O5) После критической аварии нет авто-рестарта без явного восстановления.

---

## 2) Определение безопасного состояния (Safe State)
Safe State (проектное определение):
- ШИМ на TIM1 выключен (выходы безопасны).
- Драйверы запрещены (DRV_EN/INH), если линия предусмотрена.
- Состояние системы = FAULT (или экв.), ошибка отражена в статусе.
- Для критических аварий — latch до явного recovery (см. раздел 5).

Важно: **reset микроконтроллера не является безопасным состоянием**. Safe state обеспечивается аппаратным запретом силовой части, а reset используется как механизм восстановления.

Примечание: точная электрическая “полярность” безопасных уровней определяется схемой и фиксируется в `PROJECT_CONTEXT.md`.

---

## 3) Классы аварий и реакция

### C0 — Emergency stop / аппаратный трип (критический)
Типичные причины:
- Driver fault / аппаратный FAULT драйвера
- Перегрузка/КЗ (если есть аппаратный компаратор)
- Внешний E-Stop (если есть)
- Любое событие, требующее мгновенного отключения

Реакция:
- Немедленно аппаратно отключить PWM через TIM1 BKIN/BKIN2 (или эквивалентный path).
- Запретить драйверы (DRV_EN/INH), если доступно.
- Установить latch (см. раздел 5).
- Сформировать fault_flags/fault_code и выдать в ответ ТК.

### C1 — Быстрый программный stop (важный, но без hardware triр)
Типичные причины:
- Потеря команд ТК > N мс (N TBD)
- Потеря обновления EtherCAT PDO / link down (если штатный интерфейс ТК — EtherCAT; для legacy CAN *(устар.)* — bus-off/ошибки линии, включая случаи, когда связь “логически” невалидна)
- Устойчиво невалидные измерения (timeout/stuck/sat/CRC)
- Overrun критического цикла (fast-loop): шаг управления не завершён до следующего периода PWM (детект: новый тик при активном шаге)
- Некорректная команда (режим/уставка вне допустимого диапазона)

Реакция:
- Controlled ramp down: линейное снижение `I_ref_used` до 0 за `T_ramp_ms` = 10–20 мс (дефолт 10 мс), 1 раз на период PWM.
- Отмена ramp после старта не допускается; восстановление — только после достижения safe state и явного recovery (см. раздел 5).
- Для причины “невалидные измерения” ramp выполняется без доверия к измерениям (монотонное снижение к 0).
- По завершении ramp: PWM off + DRV_EN/INH off (если возможно), фиксация причины и статус.
- Эскалация: C0 во время ramp → аппаратный OFF через BKIN/BKIN2.
- Эскалация: hard-timeout (потеря связи) или overrun fast-loop → немедленный программный OFF + latch.
- Политика latch по причинам — см. раздел 5.1.

### C2 — Предупреждение (warning)
Типичные причины:
- измерение близко к пределу, но ещё валидно
- повышенная температура, но ниже отключения
- редкие ошибки связи без потери управления

Реакция:
- Не изменять силовую часть автоматически (если это безопасно).
- Отразить warning_flags, увеличить счётчики, ограничить режим (если определено).

---

## 4) Shutdown-path (как именно выключаемся)

### 4.1 Аппаратный путь (обязателен для C0)
- TIM1 BKIN/BKIN2 должны быть сконфигурированы так, чтобы приводить выходы TIM1 в безопасное состояние без участия RTOS/задач.
- Запрещено делать критическое отключение зависимым только от софта.

### 4.2 Второй рубильник (желательно)
- DRV_EN/INH используется как независимый запрет драйверов (не только “через PWM”).
- Для C0 предпочтительно: BKIN + DRV_EN.

### 4.3 Программный путь (для C1/C2)
- ПО обязано перевести систему в safe state в соответствии с классом аварии.
- Наличие hardware trip не отменяет корректную софт-обработку: фиксация причины, отчёт, запрет повторного старта.

---

## 4.4 Разделение ролей Fault vs Reset (CBM706T / супервизор)
Если используется внешний супервизор (например, **CBM706T**), архитектурное правило:
- **FAULT** используется как **аппаратный запрет драйверов / силовой части** (не зависит от МК).
- **RESET** используется только для **восстановления**, и сам по себе не гарантирует safe state.

Референс: `docs/safety/SAFETY_CONCEPT_CBM706T_RU.md` (Safety Concept) и `docs/safety/SFAT_and_Timing_Budget_MFDC_ru.md` (SFAT + timing budget).

---

## 5) Latch и Recovery (восстановление)
### 5.1 Latch (защёлка)
- C0: всегда latch.
- C1 (потеря связи): soft-timeout → без latch; hard-timeout → latch.
- C1 (перегрев): latch до восстановления температуры + явный recovery.
- C1 (невалидные измерения): latch до восстановления валидности + явный recovery.
- C1 (overrun fast-loop): latch.
- C1 (некорректная команда / единичная “мягкая” ошибка связи): без latch, запрет запуска до восстановления условий.

### 5.2 Recovery
Recovery должен быть явным и проверяемым:
- Для C1-ramp восстановление допускается только после достижения safe state.
- Кто инициирует: ТК (команда/поле `fault_reset`) / локальная кнопка / power-cycle (TBD).
- Условия снятия:
  - причина исчезла (например, измерения снова валидны, связь восстановлена),
  - команда восстановления получена и валидна,
  - выполнена задержка/проверка готовности (если требуется).

Запрещено:
- Автоматически выходить из C0-latch без явного recovery.
- Автоматически отменять C1-ramp или возобновлять сварку без явного recovery.

---

## 6) Условия “разрешено варить” (gating)
Сварка разрешается только если одновременно:
- Нет активного latch / состояние не FAULT.
- Связь с ТК валидна (по таймауту и правилам `seq`/валидаторам протокола).
- Измерения валидны (качество данных OK по диагностике measurement_core).
- Нет критических сигналов драйвера/аппаратных fault.
- Нет признаков overrun критического цикла.
- Если включён legacy CAN *(устар.)*: нет активного `BUS_OFF_ACTIVE`/bus-off, либо он обработан по политике восстановления.

(Конкретные пороги/окна времени — фиксируются в `PROJECT_CONTEXT.md` и `docs/protocols/PROTOCOL_TK_ETHERCAT.md`; legacy CAN *(устар.)* — в `docs/protocols/obsolete/PROTOCOL_TK.md` *(устар.)*.)

Примечание по legacy CAN *(устар.)* bus-off recovery:
- По умолчанию **не использовать** hardware ABOM (чтобы исключить неконтролируемые попытки восстановления и “спам” в шину).
- Восстановление CAN — программное, с backoff/ограничением частоты попыток (см. `docs/protocols/obsolete/PROTOCOL_TK.md` *(устар.)* / раздел 5).

---

## 7) Watchdog (защита от зависания)
Требование:
- Срабатывание watchdog (внутреннего/внешнего) должно приводить к safe state аппаратно.

Политика:
- Kick watchdog только в “здоровом” состоянии системы.
- При зависании задач/ISR kick прекращается → watchdog приводит к отключению.

(Конкретная схема — фиксируется в `PROJECT_CONTEXT.md`.)

---

## 8) Требования к доказательствам (proof obligations)
Для любых изменений, влияющих на safety:
- Измерение shutdown latency: BKIN_RAW → PWM_OUT safe (осциллограф/логический анализатор).
- Минимум 5 сценариев fault-injection для затронутых классов.
- Проверка отсутствия авто-рестарта после C0.
- Проверка поведения при потере команд ТК > N мс.
- Проверка “не варим вслепую”: устойчиво невалидные измерения ведут к запрету сварки.

Связанный документ:
- `docs/TEST_PLAN.md` (минимальная регрессия и стендовые проверки).


