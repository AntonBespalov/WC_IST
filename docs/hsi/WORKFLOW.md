# HSI Snapshots: назначение и как пользоваться

Статус: living doc (workflow)  
Владелец: TBD  
Связано:  
- `docs/design-notes/DN-015_HSI_Pinmux_Map.md`  
- `tools/hsi/gen_hsi_docs.py`  
- `docs/hsi/*`  

---

## 1) Что это такое

В проекте есть два типа документов про HSI (Hardware/Software Interface):

1) **Design Note (DN-015)** — *почему и по каким источникам истины мы фиксируем HSI*, какие риски, какие правила изменения.

2) **HSI snapshots в `docs/hsi/*`** — *что именно сейчас сконфигурировано* (pinmux, DMA, trigger chains, safety‑pins).  
   Это “оперативная карта” для ревью, стенда и регрессии.

HSI snapshots **генерируются детерминированно** из CubeMX `.ioc` (и опционально из `stm32g4xx_hal_msp.c`) через генератор `tools/hsi/gen_hsi_docs.py`.

---

## 2) Какие файлы генерируются

Папка `docs/hsi/`:

- `HSI_IO_MAP.md` — pin mux snapshot (Pin → Signal → Mode → Label → speed/locked).
- `HSI_DMA_MAP.md` — DMA/DMAMUX snapshot (request → DMA channel + параметры).  
  Если указан MSP-файл, добавляется сравнение `Mode(IOC)` vs `Mode(MSP)` и отметка divergence.
- `HSI_TRIGGER_MAP.md` — цепочки синхронизации (таймеры/ADC/SPI): фиксируем “намерение” + ключевые IOC параметры.
- `HSI_SAFETY_PINS.md` — safety‑critical IO (BKIN/BKIN2, сигналы драйверов, watchdog, PWM и т.п.).

Все snapshot‑файлы содержат:
- дату генерации,
- **IOC SHA256**,
- **CubeMX version** (если есть в `.ioc`),
- имя `.ioc`.

---

## 3) Источники истины

**Primary (обязательные):**
- `*.ioc` (STM32CubeMX) — базовая конфигурация пинов/AF/периферии/DMA.

**Secondary (опциональные, но важные):**
- `Core/Src/stm32g4xx_hal_msp.c` — ручные правки в USER CODE, которые могут отличаться от IOC (например, DMA mode).
- `Core/Src/main.c` — если таймерные/триггерные цепочки настраиваются кодом.

Правило:
- `.ioc` — источник правды по умолчанию.
- Любая **осознанная дивергенция** IOC vs MSP допустима, но должна быть:
  - намеренной,
  - отражённой в `HSI_DMA_MAP.md` (Notes / MANUAL_NOTES),
  - и объяснённой в 1–2 строках (зачем).

---

## 4) Как пользоваться (обычный workflow)

### 4.1 Когда нужно обновлять snapshots
Обновляй `docs/hsi/*`, если изменилось что-то из:
- `.ioc`
- `stm32g4xx_hal_msp.c` (DMA mode, IRQ prio, init peripheral)
- существенные настройки таймеров/триггеров в `main.c`

Если ничего из этого не менялось — snapshots не трогаем.

### 4.2 Порядок действий после изменения `.ioc`
1) Изменить конфигурацию в CubeMX → сохранить `.ioc`.
2) Сгенерировать код CubeMX (убедиться, что USER CODE секции не потерты).
3) При необходимости — внести правки в `stm32g4xx_hal_msp.c` (строго в USER CODE).
4) Пересобрать проект (минимальная sanity‑проверка).
5) Регенерировать snapshots:
   ```bash
   python tools/hsi/gen_hsi_docs.py --ioc uspf_*.ioc
   ```
   (или конкретный файл: `--ioc uspf_421243_064.ioc`)
6) Посмотреть diff `docs/hsi/*` и убедиться, что изменения ожидаемые.
7) Обновить/проверить DN-015 (генератор может обновлять DN автоматически, если указан `--dn` и не задан `--no-dn`).
8) Коммит/PR должен включать *вместе*:
   - `.ioc`
   - (если было) `stm32g4xx_hal_msp.c` / `main.c`
   - `docs/hsi/*`
   - `DN-015` (если затронут)

---

## 5) Как запускать генератор

### 5.1 Базовый запуск (генерировать snapshots)
```bash
python tools/hsi/gen_hsi_docs.py --ioc uspf_421243_064.ioc
```

### 5.2 С учётом MSP (поймать IOC vs MSP divergence)
```bash
python tools/hsi/gen_hsi_docs.py --ioc uspf_421243_064.ioc --msp Core/Src/stm32g4xx_hal_msp.c
```

### 5.3 В другой output‑каталог (редко нужно)
```bash
python tools/hsi/gen_hsi_docs.py --ioc uspf_421243_064.ioc --out docs/hsi
```

### 5.4 Проверка актуальности (для CI)
`--check` не перезаписывает файлы, а **падает с ошибкой**, если snapshots устарели:
```bash
python tools/hsi/gen_hsi_docs.py --ioc uspf_421243_064.ioc --check
```

---

## 6) Ручные заметки (MANUAL_NOTES) — как не потерять “живую” информацию

В каждом `docs/hsi/*.md` есть блок:

- `<!-- MANUAL_NOTES:START -->`
- `<!-- MANUAL_NOTES:END -->`

Генератор **сохраняет** содержимое между маркерами при регенерации.

Туда можно писать:
- пояснение “почему MSP отличается от IOC”,
- стендовые наблюдения,
- TODO по проверкам (например, полярность CS, валидация ITRx).

Рекомендация: **не править руками** автогенерируемые таблицы; писать только в MANUAL_NOTES.

---

## 7) Что именно обновляет DN-015

При наличии `--dn` (и если не задан `--no-dn`) генератор делает “консервативное” обновление DN-015:
- дата,
- ссылки на `docs/hsi/*` (derived artifacts),
- блок reproducibility (CubeMX version + IOC SHA256 + имя `.ioc`),
- команда для регенерации и `--check`.

Если DN-015 имеет сильно изменённую структуру — лучше держать его обновление ручным (или доработать логику `update_dn_015()` в генераторе).

---

## 8) Типовые проблемы и быстрые ответы

### 8.1 «Я поменял `.ioc`, но забыл обновить `docs/hsi/*`»
- CI (`--check`) должен упасть.
- Лечится запуском генератора и коммитом обновлений.

### 8.2 «У меня режим DMA другой, чем в `HSI_DMA_MAP.md`»
- Значит изменение сделано в MSP.
- Запускай генератор с `--msp ...`, и/или добавь пояснение в MANUAL_NOTES.

### 8.3 «CubeMX стёр мои ручные правки»
- Правки должны быть только в USER CODE секциях.
- Если надо менять то, что CubeMX всегда перетирает — либо переносить в `.ioc`, либо оформлять как системное “IOC vs MSP divergence” и поддерживать сознательно.

---

## 9) Минимальные правила ревью (чеклист PR)

Если PR содержит изменения в `.ioc`/MSP:
- [ ] Запущен `python tools/hsi/gen_hsi_docs.py --ioc <file.ioc>`
- [ ] Обновлены `docs/hsi/*`
- [ ] В заголовках snapshots обновились IOC SHA256 / CubeMX version (если нужно)
- [ ] Любые IOC vs MSP divergence объяснены (Notes/MANUAL_NOTES)
- [ ] DN-015 актуализирован (ссылки + reproducibility)

---

## 10) Границы текущего генератора (что он не делает)

- Не анализирует схему/нетлист: он фиксирует *то, что в `.ioc` и (опционально) MSP*.
- Не гарантирует корректность ITRx↔TRGO: это фиксируется как “намерение” + требует верификации на стенде/по RM.
- Не вытягивает GPIO pull‑up/down и дефолтные уровни из кода (если это важно — можно расширить генератор чтением `MX_GPIO_Init`).

---

## 11) Быстрый пример “как это выглядит” после изменения

**Изменение:** в CubeMX поменяли пин `PA9` с GPIO на альтернативную функцию UART.  
**Действия:** обновить `.ioc` → запустить генератор → увидеть diff в `HSI_IO_MAP.md` и, возможно, в `HSI_SAFETY_PINS.md` (если это safety‑пин).  
**Коммит:** `.ioc` + `docs/hsi/*` + DN-015.

---

Если хочешь, этот документ можно положить как:
- `docs/hsi/WORKFLOW.md` (рекомендую),  
или расширить текущий `docs/hsi/README.md`, если хочешь держать всё в одном README.
