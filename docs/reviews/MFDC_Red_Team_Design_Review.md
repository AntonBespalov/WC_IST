# MFDC Source Controller — Red-Team Design Review (Design Review + Failure Analysis)

Автор: Ведущий инженер-архитектор силовой электроники и embedded-ПО (MFDC)
Версия: 1.0
Статус: Red-team review
Дата: 2026-01-29

---

## TL;DR

Архитектура источника тока в целом **инженерно сильная и зрелая**: правильно разведена ответственность между источником и ТК, зафиксирован real-time контракт, выбран адекватный контур тока (PI + FF + anti-windup), продумана телеметрия и логирование.

**Основные риски** лежат не в идее, а в:
- граничных режимах (насыщение, просадка Udc, плохой контакт),
- временных рассинхронизациях (CAN ↔ fast loop),
- «скрытых» допущениях (что ТК всегда ведёт себя идеально).

Документ ниже — целенаправленный **red-team разбор**: где и как система может сломаться, и какие архитектурные фиксации нужны, чтобы этого не произошло.

---

## 1. Архитектурный контракт (что уже сделано правильно)

### 1.1. Разделение ролей

Источник:
- быстрый детерминированный привод тока;
- не знает «процесс»;
- честно сообщает о лимитах и насыщениях.

ТК:
- управляет процессом;
- формирует I_ref(t);
- интерпретирует лимиты источника.

**Red-team вывод:** это правильная граница. Её нельзя размывать «костылями» в источнике.

---

### 1.2. Временная архитектура

Зафиксировано:
- одна фаза измерения;
- регулятор только в fast ISR;
- CAN/логи вне fast loop.

**Red-team вывод:** это must-have. Любое отступление = неустойчивость, которую потом будут лечить коэффициентами.

---

## 2. Контур тока — точки отказа

### 2.1. Насыщение управления (u → u_max)

**Сценарий отказа**
- ТК повышает I_ref;
- Udc низкое / контакт плохой;
- u упирается в u_max;
- ток не растёт.

**Риски**
- интегратор «накачивается»;
- при выходе из насыщения — выброс тока;
- ТК не понимает, почему ток не дотягивает.

**Что уже хорошо**
- anti-windup описан корректно;
- есть flags LIMIT_HI.

**Что зафиксировать явно**
- если F_LIMIT_HI держится > T_track_bad:
  - источник НЕ пытается «дожать»;
  - только сигнализирует ТК;
  - дальнейшее решение — на стороне ТК.

---

### 2.2. Feedforward и Udc

**Сценарий отказа**
- резкая просадка Udc;
- u_ff резко растёт;
- duty уходит в насыщение;
- PI теряет авторитет.

**Риски**
- ложная динамика;
- «ватное» восстановление;
- скачки при возврате Udc.

**Рекомендации red-team**
- жёстко ограничить u_ff (раньше PI);
- ввести флаг UDC_LOW как причину LIMIT;
- при Udc < Udc_crit:
  - либо ограничивать I_ref_used,
  - либо уходить в safe-state.

---

## 3. Уставка от ТК — недоверенная по умолчанию

### 3.1. dI/dt и профиль

**Сценарий отказа**
- ТК ошибся в профиле;
- пришёл резкий скачок I_ref;
- источник физически не успевает.

**Что правильно**
- slew-rate limiter на I_ref_used.

**Что важно зафиксировать**
- limiter — это физический envelope, а не «фильтр»;
- источник не пытается быть «умнее» ТК;
- все изменения I_ref_used должны быть видны в телеметрии.

---

### 3.2. Потеря или деградация CAN

**Сценарий отказа**
- пропуски кадров;
- seq скачет или повторяется;
- задержки из-за шины.

**Риски**
- дрожание уставки;
- неочевидные провалы тока.

**Рекомендации**
- timeout soft → плавный спад;
- timeout hard → PWM off + FAULT;
- фиксировать seq_applied в логах.

---

## 4. Измерение тока — самый опасный участок

### 4.1. Роговский + интегратор

**Сценарий отказа**
- дрейф нуля;
- насыщение интегратора;
- обрыв катушки.

**Риски**
- ложный I=0;
- регулятор «разгоняет» duty;
- аппаратный аварийный ток.

**Red-team требования**
- детект залипания/обрыва;
- контроль диапазона;
- авто-рецентровка нуля в известных состояниях;
- FAULT при недоверии к I_fast.

---

### 4.2. Рассинхрон I и V

**Сценарий отказа**
- I и V относятся к разным окнам;
- ТК считает R по мусору.

**Решение**
- всегда передавать I/V как пару;
- фиксировать timestamp/тик.

---

## 5. Насыщение трансформатора (flux walking)

**Сценарий отказа**
- асимметрия модуляции;
- накопление вольт-секунд;
- внезапный рост di/dt.

**Риски**
- токовый удар;
- ложные защиты;
- деградация железа.

**Минимальный red-team подход**
- индикатор риска (SAT_RISK);
- реакция: ограничение duty / завершение импульса;
- не пытаться «лечить» процесс — только защищаться.

---

## 6. Логирование и диагностика

### 6.1. Что может пойти не так

- логи влияют на fast loop;
- переполнение буфера;
- потеря кадров именно в авариях.

**Контрмеры**
- двойные буферы;
- DMA;
- флаг LOG_OVERRUN;
- EVENT_FAULT с snapshot.

---

## 7. Чек-лист red-team (коротко)

Источник ОБЯЗАН:
- быть детерминированным;
- не скрывать лимиты;
- не «улучшать» уставку;
- уходить в безопасное состояние при недоверии к данным.

Источник НЕ ДОЛЖЕН:
- компенсировать ошибки ТК;
- гадать о процессе;
- работать без валидного измерения тока;
- держать PWM при сомнительном состоянии.

---

## 8. Итог

Архитектура **готова к реализации** и масштабированию.

Если зафиксировать описанные выше политики как **жёсткий контракт**, система:
- будет предсказуемо вести себя в нештатах;
- даст ТК всю необходимую информацию;
- не потребует «магических» правок на этапе пусконаладки.

Следующий шаг после этого документа — формализация в:
- DN (Design Note),
- ICD (CAN),
- Safety/Failure policy.

