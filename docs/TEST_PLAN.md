# План тестирования (TEST PLAN)

Цель: описать минимально достаточную стратегию тестирования и регрессию для прошивки сварочного источника.
Документ про подход и “что обязательно доказать”; детали железа и пороги — в `docs/PROJECT_CONTEXT.md`.

Источники правды:
- `docs/PROJECT_CONTEXT.md`, `docs/GLOSSARY.md`
- `docs/ARCHITECTURE.md` (границы модулей)
- `docs/SAFETY.md` (классы аварий и proof obligations)
- `docs/protocols/PROTOCOL_TK.md` (тесты протокола с ТК)
- `docs/protocols/PCCOM4.02.md` (тесты протокола плата ↔ ПК по USB-UART)

---

## 1) Уровни тестирования (пирамидально)

### L0 — Статические проверки (до запуска)
Цель: не пропускать тривиальные дефекты.
- Сборка без warning (по возможности warnings-as-errors)
- Проверка форматирования/линтинга (если введёте)
- Проверка “запрещённых” паттернов (например, прямой доступ к TIM1 вне pwm_hal)

Выход: отчёт CI/локально.

### L1 — Host unit tests (на ПК)
Цель: проверить core-логику без HAL/RTOS.
Охват:
- `control_core` (ограничения, anti-windup, границы)
- `measurement_core` (диагностика stuck/sat/timeout как логика, фильтры)
- `safety_supervisor` (gating, latch/recovery правила)
- `protocol_core` (seq/CRC/таймауты как логика)
- `state_machine` (переходы и запреты)

Выход: быстрый регрессионный прогон за секунды/минуты.

### L2 — SIL (software-in-the-loop)
Цель: воспроизводимость и регрессия алгоритмов на трассах.
Охват:
- Прогон “команды ТК + измерения” → “duty/state/fault_flags”.
- Использование “golden traces” (реальные логи или синтетика).

Архитектурное требование (чтобы SIL был возможен):
- ядро управления должно компилироваться и исполняться на ПК (host) без HAL/RTOS-зависимостей,
- минимальный API: `control_init()`, `control_fast_step()`, `control_slow_step()` (см. `docs/verification/MFDC_Master_Document_RU.md`).

Выход:
- сравнение результатов с эталоном (допуски/пороговые проверки).

### L3 — On-target интеграция (STM32 без силовой части)
Цель: проверить периферию и тайминги без киловатт.
Охват:
- TIM1 настройка/обновление CCR/ARR
- SPI/DMA для АЦП, буферы, таймауты
- CAN транспорт и очереди
- RTOS приоритеты, отсутствие overruns

Обязательные измерения:
- периодичность control_tick и jitter
- ADC_START → ADC_READY latency
- (если применимо) PWM_APPLY момент относительно цикла

### L4 — HIL (hardware-in-the-loop)
Цель: проверить поведение системы и отказоустойчивость без силовой нагрузки.
Охват:
- Эмуляция сигналов измерений/ошибок (stuck/sat/timeout)
- Инъекция fault-линий (driver fault/E-stop/BKIN и т.п.)
- Проверка реакций на плохую связь/пропуски кадров

Обязательные проверки:
- shutdown latency BKIN_RAW → PWM_OUT safe
- отсутствие авто-рестарта после C0
- “не варим вслепую” при невалидных измерениях
- поведение при потере команд ТК > N мс

### L5 — Power bench / System tests
Цель: проверить на реальном силовом тракте ступенчато (безопасно).
Охват:
- запуск и останов по командам
- ограничения по току/напряжению
- реакция на реальные fault’ы драйвера/датчиков
- долговременные тесты (нагрев/помехи)

---

## 2) Минимальная регрессия (обязательный набор)
Этот набор должен прогоняться перед каждым “опасным” релизом/прошивкой на стенд:

R1) Нормальный цикл: команда 1 мс → ответ, без пропусков, стабильные статусы.  
R2) Потеря команд ТК > N мс: переход в stop/fault согласно политике, отчёт в статус.  
R3) Невалидные команды (диапазоны/флаги): отказ применения + корректный status/fault.  
R4) Stuck measurement: диагностика → запрет сварки, корректный fault_flags.  
R5) Saturation measurement: диагностика → запрет сварки, корректный fault_flags.  
R6) ADC timeout/транспортная ошибка: диагностика → запрет сварки, корректный fault_flags.  
R7) Overrun критического цикла: фиксируется и приводит к определённому безопасному поведению.  
R8) Critical fault (BKIN): аппаратное отключение PWM + latch + отсутствие авто-рестарта.  
R9) Recovery: снять latch только по правилам (явное восстановление + проверка условий).  
R10) Протокол seq/CRC: повтор/пропуск/битый кадр не приводит к неконтролируемому поведению.

(Значения N и классификация faults — в `SAFETY.md` и `PROJECT_CONTEXT.md`.)

---

## 3) Fault-injection suite (минимум)
Для каждого критичного изменения добавлять сценарии инъекции, как минимум:
- Пропажа связи (таймаут)
- Burst ошибок кадров (CRC/формат)
- ADC stuck / sat / timeout
- Driver fault линия (или симуляция)
- Overrun (искусственное утяжеление, уменьшение приоритетов, заполняем очереди)

Ожидаемая реакция всегда формулируется как:
- class (C0/C1/C2),
- что происходит с PWM (off? через BKIN?),
- latch/recovery правила,
- что уходит в статус ТК.

---

## 3.1) Протокол плата ↔ ПК (PCcom4 по USB-UART) — проверки (минимум)
Цель: иметь воспроизводимые доказательства, что PCcom4 работает устойчиво и **не влияет на fast loop**.

Host/unit (если есть реализация парсера/кодека на ПК):
- корректный парсинг потока (resync по `0xFF`, межбайтовые разрывы, частичные кадры)
- валидаторы длины (8…255) и CRC16
- негативные кейсы: битые CRC, мусор/шум в потоке, бурст `0xFF`

On-target интеграция:
- стресс по входящему потоку (бурст кадров) → не должно приводить к блокировкам/overrun fast loop
- backpressure/переполнение буферов: поведение определено (дроп/ограничение/счётчики), система остаётся управляемой и безопасной
- измерения: jitter `DBG_CTRL_TICK`, worst-case длительность шага управления при включённом обмене по USB-UART

Сервисный режим “CAN over PCcom4” (отладка):
- приём “упакованных” CAN-кадров от ПК и их выдача в канальный слой без требований 1 мс (допускаются задержки мс)
- негативные кейсы: некорректный формат CAN-пакета внутри PCcom4, бурст пакетов, out-of-order, дубли

Evidence/артефакты:
- логи счётчиков (CRC errors, parse errors, overruns, drops)
- осциллограммы/трассы jitter/latency (как минимум сравнение “обмен выключен vs включен”)

---

## 4) Инструментирование и измерения (обязательный минимум)
Debug GPIO / точки измерения:
- DBG_CTRL_TICK
- DBG_ADC_START
- DBG_ADC_READY
- DBG_PWM_APPLY
- DBG_FAULT_ENTRY
- BKIN_RAW
- PWM_OUT

Что измерять:
- BKIN_RAW → PWM_OUT safe (самое важное)
- worst-case длительность шага управления
- jitter control_tick
- ADC latency и потери кадров/таймауты
- частота/задержка обмена с ТК (1 мс)

---

## 5) Артефакты тестирования (что сохраняем)
- Логи on-target/HIL: измерения + статус + fault_flags + счётчики.
- Для SIL: набор “golden traces” и эталоны.
- Короткое резюме результатов регрессии (что прогнано, какая версия, какие отклонения).

---

## 6) Трассируемость (минимум)
Для safety/critical частей поддерживать связку:
`Hazard → Safety mechanism → Test case → Evidence (лог/осциллограф/результат)`
(см. `docs/verification/MFDC_Master_Document_RU.md`).

---

## 7) Критерии готовности (exit criteria)
Фича/релиз считается готовым к силовым испытаниям, если:
- пройдена минимальная регрессия R1–R10,
- подтверждён shutdown latency для критичных аварий,
- нет авто-рестарта после C0,
- подтверждено “не варим вслепую” при отказах измерений/связи,
- документация обновлена (как минимум PROJECT_CONTEXT + при необходимости SAFETY/PROTOCOL/ARCHITECTURE).
