# Архитектура ПО источника MFDC сварочного тока  
## Проект: STM32G474 + MFDC RSW (1–4 кГц)

---

## 1. Назначение документа

Документ описывает **целевую архитектуру ПО** источника сварочного тока MFDC
для точечной сварки с жёстким разделением:
- быстрого детерминированного контура тока;
- процессного и коммуникационного уровня.

Документ предназначен для:
- проектирования embedded‑ПО;
- аудита архитектурных решений;
- последующей сертификации / расширения.

---

## 2. Аппаратная платформа

### 2.1. Микроконтроллер
- **STM32G474**
- Cortex‑M4F, FPU
- Таймеры HRTIM / TIM1
- DMA, OPAMP, COMP

---

### 2.2. Силовая часть (внешняя)
- MFDC инвертор
- Частота выходного тока: **1–4 кГц**
- Драйверы: **2 × Skyper 42R**
- Силовые модули: **4 × SEMiX252GB12**

---

### 2.3. Измерения
- Ток вторички: **катушка Роговского**
- АЦП: **AD7380 (двухканальный, синхронный)**
  - Канал 1: I_weld
  - Канал 2: U_weld
- Интерфейс: SPI + DMA

---

### 2.4. Связь
- **EtherCAT PDO (COMX↔FMC)** — штатный интерфейс ТК
- Частота обновления уставки: **1 кГц**
- Внешний технологический контроллер (ТК)
- (Опционально) legacy CAN FD — только как fallback/совместимость

---

## 3. Архитектурные принципы

1. **Трансформатор является частью объекта управления**
2. **Контур тока — hard real-time, без участия RTOS**
3. **RTOS не влияет на тайминги регулирования**
4. **EtherCAT и технологическая логика не имеют приоритета над током**
5. **Скорость изменения уставки ≠ скорость регулятора**

---

## 4. Общая структура ПО

```
+--------------------------------------------------+
|                  RTOS (FreeRTOS)                 |
|                                                  |
|  [Task_TK]    [Task_Process]   [Task_Diagnostics]|
|       |             |                 |          |
+-------|-------------|-----------------|----------+
        |             |                 |
        v             v                 v
+--------------------------------------------------+
|        Shared Data / Ring Buffers / Flags        |
+--------------------------------------------------+
                ↑
+--------------------------------------------------+
|         Fast Control Layer (No RTOS)             |
|  ISR: PWM, ADC, Control Loop                     |
+--------------------------------------------------+
                ↑
+--------------------------------------------------+
|           Hardware (PWM, ADC, DMA)               |
+--------------------------------------------------+
```

---

## 5. Быстрый контур тока (Hard Real-Time)

### 5.1. Тайминги

| Элемент                     | Частота        |
|-----------------------------|---------------|
| PWM / TIM1 (MFDC-инвертор)  | 1–4 кГц       |
| Контур регулирования тока   | 1–4 кГц (1 шаг на период PWM) |
| Оцифровка I, V (AD7380)     | N выборок на период PWM (N TBD) |
| Обновление duty             | каждый период (через preload) |

---

### 5.2. Основной ISR (PWM / HRTIM)

**Источник прерывания:** PWM period event  

Последовательность:
1. Триггер SPI‑DMA чтения AD7380
2. Получение буфера выборок `I_samples[]`, `U_samples[]` одного PWM‑периода
3. Расчёт агрегатов `I_per`, `U_per`, `P_per = mean(I*U)` (см. `docs/measurements/MEASUREMENT_ARCHITECTURE_RU.md`)
4. Расчёт ошибки:
   ```
   e = I_ref_fast − I_per
   ```
5. Регулятор тока (PI / PID / robust PI)
6. Ограничения:
   - duty_max
   - di/dt
   - volt‑seconds
7. Обновление PWM
8. Обновление быстрых диагностических флагов

⚠️ ISR **не использует malloc, RTOS, EtherCAT, printf**

---

### 5.3. Быстрые защиты (ISR)

- Overcurrent (I_meas > I_max)
- Saturation detect (di/dt без роста U)
- ADC fault
- Driver fault (Skyper)

Реакция:  
**немедленный запрет PWM + защёлка ошибки**

---

## 6. Процессный уровень (RTOS)

### 6.1. Task_Process (1 кГц)

Назначение:
- управление циклом сварки
- формирование I_ref_profile

Состояния:
- IDLE
- SQUEEZE
- UPSLOPE
- WELD
- HOLD
- FAULT

Формирует:
- I_ref_slow → передаётся в fast layer

---

### 6.2. Task_TK (1 кГц, EtherCAT PDO)

Назначение:
- приём уставок от ТК
- передача телеметрии

Обмен:
- I_set
- enable / disable
- status / fault word

---

### 6.3. Task_Diagnostics (100–200 Гц)

Назначение:
- анализ R_dyn(t)
- оценка энергии
- логирование

---

## 7. Обмен между уровнями

### 7.1. Shared data (lock-free)

- I_ref_slow
- I_meas_avg
- U_meas_avg
- R_dyn
- fault_flags

Используются:
- atomic / critical sections
- double buffering

#### 7.1.1. Атомарные “снимки” из ISR → Task (без data tearing)

Проблема: даже если отдельные `u32` читаются атомарно, “снимок” из нескольких полей (например `I_per`, `U_per`, `state`, counters) может быть “рваным”, если ISR обновляет структуру одновременно с чтением задачей.

Решение (рекомендованный паттерн публикации): **seqlock** (sequence lock) для снимка структуры.

- Writer (ISR):
  - увеличить `seq_ctr` (получится нечётное значение) → запись началась;
  - записать структуру целиком;
  - увеличить `seq_ctr` (получится чётное значение) → запись закончена.
- Reader (Task):
  - прочитать `seq_ctr` и дождаться чётного;
  - скопировать структуру;
  - перечитать `seq_ctr` и принять снимок только если значение не изменилось и оно чётное (иначе повторить).

Требование: на Cortex‑M использовать барьеры памяти (`__DMB()`/экв.) вокруг чтения/записи и держать `seq_ctr` выровненным `u32`.

---

## 8. Частотная карта системы

```
1–4 кГц  ─ PWM / Current Control / Measurement aggregation
1 кГц    ─ Process FSM / EtherCAT
100–200 Гц ─ Diagnostics
```

---

## 9. Работа с трансформатором

ПО использует **профиль трансформатора**:
- коэффициенты пересчёта
- лимиты di/dt
- volt‑seconds
- фильтрацию

Профиль загружается при инициализации или смене конфигурации.

---

## 10. Итог

Архитектура обеспечивает:
- детерминированный контур тока;
- масштабируемость под разные трансформаторы;
- готовность к адаптивному и процессному управлению.

Контур тока физически отделён от логики и коммуникаций.
