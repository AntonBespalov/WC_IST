---
name: ask-questions-embedded-stm32-freertos
version: 0.2.0
description: >
  “Ворота” против недоописанных задач и случайных опасных изменений в embedded-проекте на C (STM32 + FreeRTOS).
  Задаёт минимальные must-have вопросы и не позволяет начинать реализацию до ответов или явных допущений.
  Может вызываться явно в промпте ИЛИ использоваться как шаг 0 из других skills/шаблонов (по правилам skills/AGENTS.md).
tags: ["gate","requirements","stm32","freertos","embedded","rt","safety"]
project_context: "docs/PROJECT_CONTEXT.md"
glossary: "docs/GLOSSARY.md"
context_snapshot: "docs/CONTEXT_SNAPSHOT.md"
when_to_use:
  - "задача двусмысленная или есть 2+ правдоподобных трактовки"
  - "изменение затрагивает тайминги/ISR/DMA/обмен/аварии/разрешение сварки"
  - "перед кодогенерацией, если непонятны критерии “готово” или границы изменений"
outputs:
  - "Список must-have вопросов (коротко, с вариантами a/b/c) + дефолты + формат ответа defaults или 0a 1b ..."
---

# Уточняющие вопросы для embedded (STM32 + FreeRTOS, C)

## Цель
Задать минимальный набор уточняющих вопросов, чтобы не сделать неверные изменения.
Не начинать реализацию, пока не получены ответы на must-have вопросы (или пока пользователь явно не разрешит двигаться с указанными допущениями).

## Контекст по умолчанию (если не указано иное)
- Базовый контекст проекта см. `docs/CONTEXT_SNAPSHOT.md` (предпочтительно ссылаться на него, а не перепечатывать).
- Язык: C
- RTOS: FreeRTOS
- Ограничения реального времени: считать важными по умолчанию
- Память ограничена; динамическая память нежелательна без явного разрешения

Если `docs/CONTEXT_SNAPSHOT.md` противоречит этим дефолтам — верь snapshot.

## Workflow

### 1) Определить, недоописана ли задача
Считать задачу недоописанной, если после краткого анализа непонятно хотя бы одно из:
- Цель: что должно измениться, а что строго нельзя менять
- “Готово”: критерии приёмки (функционал, тайминги, тест/лог, сценарии)
- Границы: какие модули/файлы/задачи FreeRTOS/ISR в зоне изменений
- Ограничения RT: допустимая задержка/джиттер/время цикла/частоты
- Интеграция: контекст прерываний, DMA, очереди, таймеры, приоритеты
- Окружение: серия STM32, toolchain (CubeIDE/GCC), FreeRTOS config, HAL/LL
- Безопасность: влияет ли на safe state / аварии / разрешение работы силовой части

Если есть 2+ правдоподобных трактовки — значит недоописано.

### 2) Задать must-have вопросы (0–5), максимально “ветвь-убивающие”
Правила:
- Коротко, нумеровано.
- Где можно — варианты a/b/c.
- Предложить дефолты (пометить **Рекомендуется**).
- Дать быстрый путь: ответ `defaults` = согласие на рекомендуемые.

#### Must-have (типовой набор для STM32 + FreeRTOS)

0) Это safety/силовая логика или может повлиять на безопасное состояние?
a) Нет (инструменты/логи/косметика)  
b) Да: PWM/измерения/fault/recovery/watchdog/обмен 1 мс **(если b — далее обязателен план доказательств и fault-injection)**  
c) Не уверен — считать b **(Рекомендуется при неизвестности)**

1) Контекст выполнения?
a) Только task-контекст (FreeRTOS task) **(Рекомендуется)**  
b) ISR (прерывание) тоже участвует  
c) Не уверен — использовать безопасный дефолт (a) и отметить места, где ISR может понадобиться

2) Ограничения по времени/частоте для затронутого пути?
a) Нет строгих RT-ограничений (редко для embedded)  
b) Есть: укажи период/частоту (например, цикл 1 мс / период PWM / и т.п.) **(Рекомендуется, если известно)**  
c) Не уверен — считать, что путь RT-критичный и избегать тяжёлых операций **(Рекомендуется при неизвестности)**

3) Разрешена ли динамическая память и большие буферы?
a) malloc/new запрещены; только статик/стек **(Рекомендуется)**  
b) Можно pvPortMalloc (FreeRTOS heap_*), но с лимитом и контролем  
c) Не уверен — (a)

4) Стек и синхронизация:
a) Использовать очереди/нотификации FreeRTOS, без busy-wait **(Рекомендуется)**  
b) Можно спин/поллинг (только если оправдано RT и измерено)  
c) Не уверен — (a)

5) Как проверяем “готово”?
a) Сборка проходит + базовый runtime-чек (лог/LED/статус) **(Рекомендуется)**  
b) Нужны измерения времени (GPIO toggle + логика/осциллограф/trace)  
c) Нужны юнит-тесты/симуляция/SIL (если применимо)

Формат ответа:
- `defaults` (принять рекомендуемые)
- или `0b 1b 2c 3a 4a 5b`

### 3) Пауза перед действием
Пока must-have ответы не получены:
- Не выполнять изменения в файлах, не предлагать детальный план, завязанный на неизвестные.
- Разрешено только низкорисковое “обследование”: посмотреть структуру репо, FreeRTOSConfig.h, конфиги тактирования, места ISR/DMA, текущие паттерны логирования и синхронизации.

Если пользователь просит “делай без ответов”:
- Явно перечислить допущения (1–6 пунктов).
- Попросить подтверждение.
- Начать только после подтверждения.

### 4) Подтвердить понимание и продолжить
После ответов:
- В 1–3 предложениях пересказать задачу: цель, ограничения, критерии “готово”.
- Затем начинать план/изменения.

## Анти-паттерны (запрещено)
- Задавать вопросы, на которые можно ответить чтением конфигов (FreeRTOSConfig.h, CubeMX .ioc, системный такт, NVIC приоритеты).
- Спрашивать широко/размыто вместо вариантов.
- Начинать реализацию до must-have ответов (если нет явного согласия на допущения).
- Вводить тяжёлые зависимости/библиотеки без явного разрешения.
