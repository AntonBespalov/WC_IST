---
name: workflow-spec-tests-code
version: 0.1.0
description: >
  Процесс Spec → Tests/Proof → Code для надёжной разработки: сначала требования и критерии,
  затем план доказательств (unit/on-target/HIL/fault), затем минимальный патч.
tags: ["workflow","spec","tests","proof","code"]
when_to_use:
  - "любая новая фича или изменение поведения"
  - "изменения в control/measurement/safety/comms"
outputs:
  - "Spec + Tests/Proof + Code plan (или патч, если запрошено явно)"
---

# Skill: Workflow Spec → Tests/Proof → Code

## Миссия
Снизить риск: сначала понять, что должно быть доказано, затем чем доказать, затем код.

## MUST (порядок)
## Шаг 0 — Gate (перед Spec)
Перед началом Spec проверь, определены ли MUST-поля запроса (см. `AGENTS.md` → Gate M1..M5):
- цель + что не менять
- границы файлов/модулей
- контекст исполнения (task/ISR/DMA)
- временной домен (PWM / 1 мс / async fault / другое)
- критерий “готово” (proof/done)

Если хотя бы одно отсутствует:
- **не продолжать Spec/Tests/Code**
- вместо этого применить skill `ask-questions-embedded-stm32-freertos`
- выдать только вопросы в формате `defaults` или `0a 1b ...`

### Шаг 1 — Spec
- цель изменения (что меняется / что остаётся)
- измеримые критерии приёмки (границы, задержки, поведение при fault)
- инварианты, которые нельзя сломать (safety/тайминги/протокол)

### Шаг 2 — Tests/Proof
- какие тесты подтверждают Spec:
  - host unit (где возможно)
  - on-target тайминги (GPIO/осциллограф/trace)
  - fault-injection (минимум 5 сценариев для критичных изменений)
  - HIL (если затрагивает поведение контура/помехоустойчивость)
- что именно измерить (BKIN_RAW→PWM_OUT, jitter, ADC latency, overrun)

### Шаг 3 — Code
- минимальный список файлов, которые меняем
- план коммитов
- реализация (только если запросили)

## Контракт ответа
По умолчанию выдавай Шаг 1 и Шаг 2.
Код писать только если пользователь явно попросил реализовать.

## Нельзя
- Перескакивать к коду без Spec и Tests/Proof для критичных изменений.
- Писать host unit тесты, которые напрямую включают `stm32g4xx_hal.h`/регистры STM32: core-логика должна тестироваться через mock-интерфейсы HAL/Platform.
